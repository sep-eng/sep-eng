<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SEP & Make It Happen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Inter font -->
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- GSAP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>

  <!-- Firebase module: sets window.mihFirebaseApi that the main script uses -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      addDoc,
      query,
      where,
      orderBy,
      serverTimestamp,
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAkbH3mJkeheF3L7EaqN1kMgbFd_LJCIXo",
  authDomain: "hitachi-vantara-make-it-happen.firebaseapp.com",
  projectId: "hitachi-vantara-make-it-happen",
  storageBucket: "hitachi-vantara-make-it-happen.firebasestorage.app",
  messagingSenderId: "749690169824",
  appId: "1:749690169824:web:21d6b8d2a5862847e4e385",
  measurementId: "G-7WZ03E68MF"
};

    function createApi() {
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const usersCol = collection(db, "mih_users");
      const entriesCol = collection(db, "mih_entries");

      // Helper to fetch all users
      async function fetchAllUsers() {
        const snap = await getDocs(usersCol);
        const users = [];
        snap.forEach((doc) => {
          users.push({ id: doc.id, ...doc.data() });
        });
        return users;
      }

      // Helper to fetch all entries
      async function fetchAllEntries() {
        const snap = await getDocs(entriesCol);
        const entries = [];
        snap.forEach((doc) => {
          entries.push({ id: doc.id, ...doc.data() });
        });
        return entries;
      }

      // Determine league with lowest user count
      async function decideLeague() {
        const users = await fetchAllUsers();
        const counts = {
          amateurs: 0,
          intermediates: 0,
          pros: 0,
          legends: 0,
        };
        users.forEach((u) => {
          if (counts[u.league] !== undefined) {
            counts[u.league]++;
          }
        });
        const leagues = Object.keys(counts);
        let best = "amateurs";
        let bestCount = counts[best];
        leagues.forEach((l) => {
          if (counts[l] < bestCount) {
            best = l;
            bestCount = counts[l];
          }
        });
        return best;
      }

      // Login or create user
      async function loginOrCreateUser(name, password) {
        const trimmed = name.trim();
        if (!trimmed) {
          throw new Error("Name is required");
        }

        const qUser = query(usersCol, where("nameLower", "==", trimmed.toLowerCase()));
        const qSnap = await getDocs(qUser);
        if (!qSnap.empty) {
          // Existing user
          const docSnap = qSnap.docs[0];
          const data = docSnap.data();
          if (data.password !== password) {
            throw new Error("wrong-password");
          }
          return { id: docSnap.id, ...data };
        } else {
          // New user
          const league = await decideLeague();
          const docRef = await addDoc(usersCol, {
            name: trimmed,
            nameLower: trimmed.toLowerCase(),
            password,
            league,
            createdAt: serverTimestamp(),
          });
          return {
            id: docRef.id,
            name: trimmed,
            nameLower: trimmed.toLowerCase(),
            password,
            league,
          };
        }
      }

      // Add activity
      async function addActivity(userId, distanceKm, timeMinutes) {
        return addDoc(entriesCol, {
          userId,
          distanceKm,
          timeMinutes,
          createdAt: serverTimestamp(),
        });
      }

      // Fetch entries for a single user
      async function fetchEntriesForUser(userId) {
        const qEntries = query(entriesCol, where("userId", "==", userId), orderBy("createdAt", "desc"));
        const snap = await getDocs(qEntries);
        const entries = [];
        snap.forEach((doc) => {
          entries.push({ id: doc.id, ...doc.data() });
        });
        return entries;
      }

      // Build leaderboard data
      async function buildLeaderboard() {
        const [users, entries] = await Promise.all([fetchAllUsers(), fetchAllEntries()]);
        const userMap = {};
        users.forEach((u) => {
          userMap[u.id] = u;
        });

        const totals = {};
        entries.forEach((e) => {
          if (!totals[e.userId]) {
            totals[e.userId] = {
              userId: e.userId,
              totalDistance: 0,
              totalTime: 0,
              runs: 0,
            };
          }
          totals[e.userId].totalDistance += Number(e.distanceKm) || 0;
          totals[e.userId].totalTime += Number(e.timeMinutes) || 0;
          totals[e.userId].runs += 1;
        });

        const rows = Object.values(totals).map((row) => {
          const user = userMap[row.userId] || {};
          return {
            ...row,
            name: user.name || "Unknown",
            league: user.league || "amateurs",
          };
        });

        rows.sort((a, b) => b.totalDistance - a.totalDistance);
        return rows;
      }

      // Stats table
      async function buildStats() {
        const leaderboardRows = await buildLeaderboard();
        // For now stats are same as leaderboard but with improvement placeholder
        return leaderboardRows.map((row) => ({
          ...row,
          avgDistance: row.runs > 0 ? row.totalDistance / row.runs : 0,
          bestDistance: 0,
          improvement: 0,
        }));
      }

      // Profile data for a single user
      async function buildProfile(userId) {
        const [users, entries] = await Promise.all([
          fetchAllUsers(),
          fetchEntriesForUser(userId),
        ]);
        const user = users.find((u) => u.id === userId);
        if (!user) {
          throw new Error("user-not-found");
        }
        let totalDistance = 0;
        let totalTime = 0;
        entries.forEach((e) => {
          totalDistance += Number(e.distanceKm) || 0;
          totalTime += Number(e.timeMinutes) || 0;
        });
        const runs = entries.length;
        const avgDistance = runs > 0 ? totalDistance / runs : 0;
        const avgPace = totalDistance > 0 ? totalTime / totalDistance : 0; // minutes per km

        function formatMinutes(m) {
          if (!isFinite(m) || m <= 0) return "–";
          const mins = Math.floor(m);
          const secs = Math.round((m - mins) * 60);
          return `${mins}m ${secs}s`;
        }

        return {
          user,
          runs,
          totalDistance,
          totalTime,
          avgDistance,
          bestTimes: {
            "5k": formatMinutes(avgPace * 5),
            "10k": formatMinutes(avgPace * 10),
            "100m": formatMinutes((avgPace * 0.1)),
          },
        };
      }

      // Expose API
      window.mihFirebaseApi = {
        loginOrCreateUser,
        addActivity,
        fetchEntriesForUser,
        buildLeaderboard,
        buildStats,
        buildProfile,
      };
      console.log("Firebase initialised for Make It Happen.");
    }

    try {
      if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY") {
        createApi();
      } else {
        console.log("Firebase config still placeholder. MIH will not work until you fill it in.");
      }
    } catch (err) {
      console.warn("Firebase init error:", err);
    }
  </script>

  <style>
    body {
      font-family: "Inter", sans-serif;
      background: linear-gradient(to bottom, #000000, #ffffff);
      color: #111;
      scroll-behavior: smooth;
    }

    .scene {
      display: none;
    }
    .scene.active {
      display: block;
    }

    .fade-section {
      opacity: 0;
      transform: translateY(30px);
    }

    button,
    a {
      transition: all 0.2s ease;
    }
    button:hover,
    a:hover {
      transform: translateY(-1px);
    }

    .popup {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #16a34a;
      color: #fff;
      padding: 10px 16px;
      border-radius: 8px;
      opacity: 0;
      transition: opacity 0.25s ease;
      z-index: 100;
      font-size: 13px;
    }
    .popup.show {
      opacity: 1;
    }

    #cartSidebar {
      color: #000;
      transition: transform 0.3s ease;
    }
    .hidden-during-cart {
      transition: opacity 0.2s ease;
    }

    #exitHomeBtn {
      position: fixed;
      top: 12px;
      left: 12px;
      z-index: 70;
      display: none;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 9999px;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.3);
      font-size: 11px;
      cursor: pointer;
    }
    .door-icon {
      width: 14px;
      height: 14px;
      position: relative;
    }
    .door-icon::before {
      content: "";
      position: absolute;
      left: 2px;
      top: 1px;
      width: 7px;
      height: 12px;
      border: 2px solid currentColor;
      border-left-width: 4px;
      border-right-width: 1px;
      border-top-width: 2px;
      border-bottom-width: 2px;
      border-radius: 1px;
    }
    .door-icon::after {
      content: "";
      position: absolute;
      right: -1px;
      top: 5px;
      width: 6px;
      height: 4px;
      border-top: 2px solid currentColor;
      border-left: 2px solid currentColor;
      border-bottom: 2px solid transparent;
      border-right: 2px solid transparent;
      transform: translateX(-1px);
    }

    #sepNav {
      position: fixed;
      top: 10px;
      right: 12px;
      z-index: 70;
      display: none;
      flex-direction: column;
      gap: 6px;
    }
    .nav-toggle-btn {
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      border-radius: 9999px;
      padding: 6px 10px;
      font-size: 10px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    .nav-lines {
      display: inline-block;
      width: 14px;
      height: 10px;
      position: relative;
    }
    .nav-lines span {
      position: absolute;
      left: 0;
      right: 0;
      height: 2px;
      background: #fff;
      border-radius: 999px;
    }
    .nav-lines span:nth-child(1) { top: 0; }
    .nav-lines span:nth-child(2) { top: 4px; }
    .nav-lines span:nth-child(3) { top: 8px; }

    #sepNavMenu {
      margin-top: 4px;
      background: rgba(0, 0, 0, 0.85);
      border-radius: 9999px;
      padding: 4px 6px;
      border: 1px solid rgba(255, 255, 255, 0.25);
      display: none;
    }
    #sepNavMenu.show {
      display: flex;
    }
    #sepNavMenu button {
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 9999px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: transparent;
      color: #f3f3f3;
      white-space: nowrap;
    }

    .mih-card {
      background: rgba(255, 255, 255, 0.04);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.45);
    }
    .profile-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
    }
    .profile-value {
      font-size: 14px;
    }
  </style>
</head>

<body class="text-sm md:text-base">

  <!-- EXIT TO HOME -->
  <button id="exitHomeBtn" type="button">
    <span class="door-icon"></span>
    <span>Exit to home</span>
  </button>

  <!-- SEP BURGER NAV -->
  <div id="sepNav" class="hidden-during-cart">
    <button id="sepNavToggle" class="nav-toggle-btn" type="button">
      <span class="nav-lines">
        <span></span><span></span><span></span>
      </span>
      <span>Menu</span>
    </button>
    <div id="sepNavMenu">
      <button type="button" onclick="showScene('sep-shop')">SEP shop</button>
      <button type="button" onclick="showScene('sep-about')">About SEP</button>
    </div>
  </div>

  <!-- HOME -->
  <section id="scene-home" class="scene active">
    <div class="min-h-screen flex items-center justify-center px-6 py-16">
      <div class="max-w-3xl w-full text-center fade-section">
        <p class="text-xs tracking-[0.25em] uppercase text-gray-400 mb-4">
          SEP · Make It Happen
        </p>
        <h1 class="text-3xl md:text-4xl font-semibold text-white mb-4">
          Two simple projects.<br class="hidden md:block" />
          One calm starting point.
        </h1>
        <p class="text-gray-300 mb-10 max-w-xl mx-auto">
          Choose where you want to go. SEP is a small clothing brand built in Copenhagen.
          Make It Happen is a simple running challenge that lives in your browser.
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <button
            id="homeSepBtn"
            type="button"
            class="group bg-white/5 border border-white/15 rounded-2xl px-6 py-8 text-left hover:bg-white/10"
          >
            <div class="text-xs uppercase tracking-[0.25em] text-gray-400 mb-2">
              Clothing
            </div>
            <div class="text-xl font-semibold text-white mb-2">
              SEP shop
            </div>
            <p class="text-gray-300 text-sm mb-3">
              Minimalist shirts, hoodies and trousers. Hand pressed in Copenhagen.
            </p>
            <div class="text-xs text-gray-400">
              Enter shop →
            </div>
          </button>

          <button
            id="homeMihBtn"
            type="button"
            class="group bg-white/5 border border-white/15 rounded-2xl px-6 py-8 text-left hover:bg-white/10"
          >
            <div class="text-xs uppercase tracking-[0.25em] text-gray-400 mb-2">
              Movement
            </div>
            <div class="text-xl font-semibold text-white mb-2">
              Make It Happen
            </div>
            <p class="text-gray-300 text-sm mb-3">
              Log your runs, walks and rides. Climb a shared leaderboard with your friends.
            </p>
            <div class="text-xs text-gray-400">
              Enter challenge →
            </div>
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- SEP SHOP -->
  <section id="scene-sep-shop" class="scene">
    <header class="pt-20 pb-16 text-center fade-section">
      <h1 class="text-4xl md:text-5xl font-bold text-gray-100 mb-4">
        Minimalist clothing made with intention.
      </h1>
      <p class="text-lg text-gray-300 mb-8">
        Soft, clean and hand pressed in Copenhagen.
      </p>
      <div id="sepHeroButtons" class="flex justify-center gap-4 hidden-during-cart">
        <a
          href="#sep-products"
          class="bg-white text-black px-6 py-3 rounded-full font-medium"
        >
          Shop Now
        </a>
        <button
          id="viewCartBtn"
          class="border border-white text-white px-6 py-3 rounded-full font-medium relative"
          type="button"
        >
          View Cart
          <span
            id="cartCounter"
            class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hidden"
          >
            0
          </span>
        </button>
      </div>
    </header>

    <section id="sep-products" class="py-16 px-6 fade-section">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold text-gray-100 mb-3">
          Three products. One choice.
        </h2>
        <p class="text-gray-300">
          Soft, durable and calm pieces for everyday wear.
        </p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl mx-auto">
        <div class="product-card bg-white/10 p-6 rounded-xl shadow-md text-center backdrop-blur">
          <div class="w-full h-64 bg-gray-200 rounded mb-4 flex items-center justify-center text-gray-500 text-xs uppercase tracking-widest">
            White T shirt
          </div>
          <h3 class="text-xl font-bold mb-1">SEP White T shirt</h3>
          <p class="mb-3">180 kr.</p>
          <select class="border rounded px-3 py-2 mb-3 bg-transparent">
            <option>XS</option><option>S</option><option>M</option><option>L</option><option>XL</option>
          </select>
          <div class="flex justify-center gap-2">
            <input type="number" min="1" value="1" class="border rounded w-16 text-center bg-transparent quantity-selector" />
            <button class="add-to-cart bg-white text-black px-4 py-2 rounded" type="button">Add</button>
          </div>
        </div>

        <div class="product-card bg-white/10 p-6 rounded-xl shadow-md text-center backdrop-blur">
          <div class="w-full h-64 bg-gray-200 rounded mb-4 flex items-center justify-center text-gray-500 text-xs uppercase tracking-widest">
            Black Hoodie
          </div>
          <h3 class="text-xl font-bold mb-1">SEP Black Hoodie</h3>
          <p class="mb-3">180 kr.</p>
          <select class="border rounded px-3 py-2 mb-3 bg-transparent">
            <option>XS</option><option>S</option><option>M</option><option>L</option><option>XL</option>
          </select>
          <div class="flex justify-center gap-2">
            <input type="number" min="1" value="1" class="border rounded w-16 text-center bg-transparent quantity-selector" />
            <button class="add-to-cart bg-white text-black px-4 py-2 rounded" type="button">Add</button>
          </div>
        </div>

        <div class="product-card bg-white/10 p-6 rounded-xl shadow-md text-center backdrop-blur">
          <div class="w-full h-64 bg-gray-200 rounded mb-4 flex items-center justify-center text-gray-500 text-xs uppercase tracking-widest">
            Black Trousers
          </div>
          <h3 class="text-xl font-bold mb-1">SEP Black Trousers</h3>
          <p class="mb-3">180 kr.</p>
          <select class="border rounded px-3 py-2 mb-3 bg-transparent">
            <option>XS</option><option>S</option><option>M</option><option>L</option><option>XL</option>
          </select>
          <div class="flex justify-center gap-2">
            <input type="number" min="1" value="1" class="border rounded w-16 text-center bg-transparent quantity-selector" />
            <button class="add-to-cart bg-white text-black px-4 py-2 rounded" type="button">Add</button>
          </div>
        </div>
      </div>
    </section>

    <div
      id="cartSidebar"
      class="fixed top-0 right-0 h-full w-80 bg-white shadow-xl translate-x-full z-50 overflow-y-auto"
    >
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold">Your Cart</h3>
          <button id="closeCart" type="button">✕</button>
        </div>

        <div class="mb-4 text-sm">
          <p class="mb-1 font-medium">Shipping destination</p>
          <div class="flex gap-2 text-xs">
            <button
              id="shippingCph"
              type="button"
              class="px-3 py-1 rounded-full border border-gray-400 bg-gray-200"
            >
              Copenhagen
            </button>
            <button
              id="shippingNonCph"
              type="button"
              class="px-3 py-1 rounded-full border border-gray-400 bg-transparent"
            >
              Rest of Denmark
            </button>
          </div>
          <p class="mt-1 text-gray-500 text-xs">
            Copenhagen = free shipping. Rest of Denmark = +45 kr.
          </p>
        </div>

        <div id="cartItems" class="space-y-4 text-sm"></div>

        <div class="border-t border-gray-300 pt-4 mt-4 text-sm">
          <div class="flex justify-between mb-1">
            <span>Subtotal:</span>
            <span id="cartSubtotal" class="font-bold">0 kr.</span>
          </div>
          <div class="flex justify-between mb-2 text-xs text-gray-600">
            <span>Shipping:</span>
            <span id="cartShippingLabel">+45 kr.</span>
          </div>
          <div class="flex justify-between font-semibold border-t border-gray-300 pt-2 mb-3">
            <span>Total:</span>
            <span id="cartTotal">45 kr.</span>
          </div>

          <button
            id="openMobilePay"
            class="w-full bg-green-500 text-white py-2 rounded mb-2"
            type="button"
          >
            Open MobilePay
          </button>
          <p class="text-xs text-gray-500 mb-2 text-center">
            “Open MobilePay” only works properly on mobile devices.
          </p>
          <button
            id="copyMobilePay"
            class="w-full bg-gray-200 py-2 rounded"
            type="button"
          >
            Copy Order Message
          </button>
        </div>
      </div>
    </div>
    <div id="cartOverlay" class="fixed inset-0 bg-black/50 hidden z-40"></div>

    <section class="py-20 text-center fade-section">
      <h2 class="text-3xl font-bold mb-10 text-gray-100">
        How to order
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-5 gap-6 max-w-6xl mx-auto text-sm md:text-base">
        <div class="bg-white/10 rounded-xl p-6 backdrop-blur">
          <h3 class="font-bold text-lg mb-2">1. Choose</h3>
          <p>Pick your favourite SEP piece. Then choose your size.</p>
        </div>
        <div class="bg-white/10 rounded-xl p-6 backdrop-blur">
          <h3 class="font-bold text-lg mb-2">2. Add to cart</h3>
          <p>Use the Add button on each card to build your cart.</p>
        </div>
        <div class="bg-white/10 rounded-xl p-6 backdrop-blur">
          <h3 class="font-bold text-lg mb-2">3. Copy message</h3>
          <p>Open the cart and tap “Copy Order Message”.</p>
        </div>
        <div class="bg-white/10 rounded-xl p-6 backdrop-blur">
          <h3 class="font-bold text-lg mb-2">4. Pay with MobilePay</h3>
          <p>Send the total to <b>5894BZ</b> on MobilePay.</p>
        </div>
        <div class="bg-white/10 rounded-xl p-6 backdrop-blur">
          <h3 class="font-bold text-lg mb-2">5. Send your order</h3>
          <p>Paste the message into a DM to <b>@seproairesis</b>.</p>
        </div>
      </div>
    </section>

    <footer class="text-center py-10 fade-section text-sm">
      <p>
        © 2025 SEP – Se Proairesis (“Your Choice”) · MobilePay 5894BZ ·
        +45 kr shipping, free in Copenhagen · Delivery only within Denmark.
      </p>
      <p class="mt-2 text-xs text-gray-400">
        No data selling. No ads following you around. No creepy tracking.
      </p>
      <div class="flex justify-center gap-4 mt-4">
        <a
          href="https://instagram.com/seproairesis"
          target="_blank"
          class="bg-gradient-to-br from-pink-500 to-purple-600 text-white px-4 py-2 rounded-full text-sm"
        >
          Instagram
        </a>
        <a
          href="https://tiktok.com/@seproairesis"
          target="_blank"
          class="bg-black text-white px-4 py-2 rounded-full text-sm"
        >
          TikTok
        </a>
      </div>
    </footer>
  </section>

  <!-- ABOUT SEP -->
  <section id="scene-sep-about" class="scene">
    <div class="min-h-screen bg-black text-white flex items-center justify-center px-6 py-16">
      <div class="max-w-3xl mx-auto space-y-6">
        <h2 class="text-3xl font-bold tracking-wide">About SEP</h2>
        <p class="text-gray-300">
          SEP stands for <span class="italic">Se Proairesis</span>, an ancient Greek idea that roughly
          means “Your Choice”. The brand is built around that idea.
        </p>
        <p class="text-gray-300">
          A white T shirt, a black hoodie and black trousers that feel good and work with almost anything.
          Every print is hand pressed in Copenhagen in small batches.
        </p>
        <p class="text-gray-300">
          There are no big collections and no hype drops. You pick your piece, copy your order message, pay and wait.
        </p>
        <p class="text-gray-400 text-xs">
          There is no tracking across the internet. No data selling. No newsletter trying to drag you back.
        </p>
        <div class="flex flex-wrap gap-3 text-xs md:text-sm mt-4">
          <button
            class="px-4 py-2 rounded-full border border-white/20"
            type="button"
            onclick="showScene('sep-shop')"
          >
            Back to SEP shop
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- MIH WELCOME -->
  <section id="scene-mih-welcome" class="scene">
    <div class="min-h-screen bg-black text-white pt-16 pb-20 px-4 md:px-6">
      <div class="max-w-5xl mx-auto mb-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <div class="text-[10px] tracking-[0.5em] uppercase text-gray-400 mb-1">
            Make It
          </div>
          <div class="text-2xl md:text-3xl font-semibold tracking-[0.5em] uppercase">
            Happen
          </div>
        </div>
        <div class="flex flex-wrap gap-2 text-xs md:text-sm">
          <button class="px-3 py-1 rounded-full border border-white/20 text-gray-300" type="button" onclick="showScene('mih-login')">
            Login
          </button>
          <button class="px-3 py-1 rounded-full border border-white/20 text-gray-300" type="button" onclick="showScene('mih-welcome')">
            Welcome
          </button>
          <button class="px-3 py-1 rounded-full border border-white/20 text-gray-300" type="button" onclick="showScene('mih-leaderboard')">
            Leaderboard
          </button>
          <button class="px-3 py-1 rounded-full border border-white/20 text-gray-300" type="button" onclick="showScene('mih-stats')">
            Stats
          </button>
          <button class="px-3 py-1 rounded-full border border-white/20 text-gray-300" type="button" onclick="showScene('mih-about')">
            About
          </button>
        </div>
      </div>

      <main class="max-w-5xl mx-auto">
        <div class="mih-card p-6 md:p-8 space-y-4 text-sm md:text-base">
          <div>
            <h1 class="text-2xl md:text-3xl font-semibold mb-2">
              Move more. Compete. Make it happen.
            </h1>
            <p class="text-gray-300">
              Run, walk or cycle. Log your distance and time. Slowly climb a shared leaderboard in your league.
            </p>
          </div>
          <div class="flex flex-wrap gap-3 text-xs md:text-sm">
            <button
              class="px-5 py-2 rounded-full bg-white text-black"
              type="button"
              onclick="showScene('mih-leaderboard')"
            >
              See leaderboard →
            </button>
            <button
              class="px-5 py-2 rounded-full border border-white/20 text-gray-200"
              type="button"
              onclick="showScene('mih-about')"
            >
              What is this?
            </button>
          </div>
        </div>
      </main>
    </div>
  </section>

  <!-- MIH LOGIN -->
  <section id="scene-mih-login" class="scene">
    <div class="min-h-screen bg-black text-white pt-16 pb-20 px-4 md:px-6">
      <div class="max-w-5xl mx-auto mb-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <div class="text-[10px] tracking-[0.5em] uppercase text-gray-400 mb-1">
            Make It
          </div>
          <div class="text-2xl md:text-3xl font-semibold tracking-[0.5em] uppercase">
            Happen
          </div>
        </div>
        <div class="flex flex-wrap gap-2 text-xs md:text-sm">
          <button class="px-3 py-1 rounded-full border border-white/20 text-gray-300" type="button" onclick="showScene('mih-login')">
            Login
          </button>
          <button class="px-3 py-1 rounded-full border border-white/20 text-gray-300" type="button" onclick="showScene('mih-welcome')">
            Welcome
          </button>
          <button class="px-3 py-1 rounded-full border border-white/20 text-gray-300" type="button" onclick="showScene('mih-leaderboard')">
            Leaderboard
          </button>
          <button class="px-3 py-1 rounded-full border border-white/20 text-gray-300" type="button" onclick="showScene('mih-stats')">
            Stats
          </button>
          <button class="px-3 py-1 rounded-full border border-white/20 text-gray-300" type="button" onclick="showScene('mih-about')">
            About
          </button>
        </div>
      </div>

      <main class="max-w-5xl mx-auto">
        <div class="mih-card p-6 md:p-8 text-sm md:text-base">
          <h1 class="text-2xl md:text-3xl font-semibold mb-2">
            Log in to Make It Happen
          </h1>
          <p class="text-gray-300 mb-4">
            Create a simple account so the site knows who you are and only you can manage your activities.
          </p>
          <form id="login-form" class="space-y-3 mt-2">
            <div>
              <label for="login-name" class="block text-xs text-gray-400 mb-1">Name</label>
              <input
                id="login-name"
                type="text"
                placeholder="e.g. Daniel"
                class="w-full px-3 py-2 rounded-full bg-black/40 border border-white/15 text-sm"
                required
              />
            </div>
            <div>
              <label for="login-password" class="block text-xs text-gray-400 mb-1">Password</label>
              <input
                id="login-password"
                type="password"
                placeholder="Choose something simple"
                class="w-full px-3 py-2 rounded-full bg-black/40 border border-white/15 text-sm"
                required
              />
            </div>
            <button
              type="submit"
              class="px-5 py-2 rounded-full bg-white text-black text-xs md:text-sm mt-1"
            >
              Log in / Create account
            </button>
            <p class="text-[11px] text-gray-400 mt-2">
              If this is your first time with this name, a new account will be created and you will be placed into a league.
            </p>
          </form>
          <p class="text-[11px] text-gray-500 mt-4">
            Your login is stored with Firebase and your browser. There are no ads and no data selling.
          </p>
        </div>
      </main>
    </div>
  </section>

  <!-- MIH LEADERBOARD -->
  <section id="scene-mih-leaderboard" class="scene">
    <div class="min-h-screen bg-black text-white pt-16 pb-20 px-4 md:px-6">
      <div class="max-w-5xl mx-auto mb-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <div class="text-[10px] tracking-[0.5em] uppercase text-gray-400 mb-1">
            Make It
          </div>
          <div class="text-2xl md:text-3xl font-semibold tracking-[0.5em] uppercase">
            Happen
          </div>
        </div>
        <div class="flex flex-wrap gap-2 text-xs md:text-sm">
          <button class="px-3 py-1 rounded-full border border-white/20 text-gray-300" type="button" onclick="showScene('mih-login')">
            Login
          </button>
          <button class="px-3 py-1 rounded-full border border-white/20 text-gray-300" type="button" onclick="showScene('mih-welcome')">
            Welcome
          </button>
          <button class="px-3 py-1 rounded-full border border-white/20 text-gray-300" type="button" onclick="showScene('mih-leaderboard')">
            Leaderboard
          </button>
          <button class="px-3 py-1 rounded-full border border-white/20 text-gray-300" type="button" onclick="showScene('mih-stats')">
            Stats
          </button>
          <button class="px-3 py-1 rounded-full border border-white/20 text-gray-300" type="button" onclick="showScene('mih-about')">
            About
          </button>
        </div>
        <div class="flex flex-col items-end gap-2 text-[11px] text-gray-400 min-w-[160px]">
          <div id="user-controls" class="flex flex-wrap gap-2 justify-end"></div>
        </div>
      </div>

      <main class="max-w-5xl mx-auto space-y-6 text-sm md:text-base">
        <div class="mih-card p-6 md:p-8">
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <h2 class="text-xl font-semibold mb-2">Add your latest activity</h2>
              <p class="text-sm text-gray-300 mb-3">
                Log any run, walk or ride. Use kilometres and minutes so the leaderboard stays fair.
              </p>
              <form id="entry-form" class="space-y-3">
                <div>
                  <label for="name" class="block text-xs text-gray-400 mb-1">
                    Your name
                  </label>
                  <input
                    id="name"
                    type="text"
                    disabled
                    placeholder="Log in to set your name"
                    class="w-full px-3 py-2 rounded-full bg-black/40 border border-white/15 text-sm"
                  />
                  <p class="text-[11px] text-gray-500 mt-1">
                    Name comes from your account. You cannot change it here.
                  </p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <div>
                    <label for="distance" class="block text-xs text-gray-400 mb-1">
                      Distance (km)
                    </label>
                    <input
                      id="distance"
                      type="number"
                      step="0.1"
                      min="0"
                      placeholder="e.g. 5"
                      class="w-full px-3 py-2 rounded-full bg-black/40 border border-white/15 text-sm"
                      required
                    />
                  </div>
                  <div>
                    <label for="time" class="block text-xs text-gray-400 mb-1">
                      Time (minutes)
                    </label>
                    <input
                      id="time"
                      type="number"
                      step="0.1"
                      min="0"
                      placeholder="e.g. 28"
                      class="w-full px-3 py-2 rounded-full bg-black/40 border border-white/15 text-sm"
                      required
                    />
                  </div>
                </div>
                <button
                  type="submit"
                  class="px-5 py-2 rounded-full bg-white text-black text-xs md:text-sm"
                >
                  Save my activity
                </button>
                <p class="text-[11px] text-gray-400 mt-2">
                  New accounts are spread across leagues so numbers stay balanced.
                </p>
              </form>
            </div>

            <div>
              <h3 class="text-lg font-semibold mb-2">How ranking works</h3>
              <p class="text-sm text-gray-300">
                The leaderboard gives credit for:
              </p>
              <ul class="text-sm text-gray-300 list-disc list-inside mt-2 space-y-1">
                <li><strong>Total distance</strong> – moving more is good.</li>
                <li><strong>Commitment over time</strong> – more sessions logged counts.</li>
                <li><strong>Speed and improvement</strong> – faster pace helps, but it is not everything.</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="mih-card p-6 md:p-8">
          <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
            <h2 class="text-xl font-semibold">Live leaderboard</h2>
            <div class="flex items-center gap-2 text-xs text-gray-300">
              <span>League:</span>
              <select
                id="league-filter"
                class="px-3 py-1 rounded-full bg-black/40 border border-white/20 text-xs"
                onchange="renderLeaderboard()"
              >
                <option value="all">All leagues</option>
                <option value="amateurs">Amateurs</option>
                <option value="intermediates">Intermediates</option>
                <option value="pros">Pros</option>
                <option value="legends">Legends</option>
              </select>
            </div>
          </div>
          <div class="overflow-x-auto text-xs md:text-sm">
            <table class="w-full border-collapse min-w-full">
              <thead class="text-gray-400 text-[11px] uppercase tracking-wide border-b border-white/10">
                <tr>
                  <th class="py-2 pr-2 text-left">#</th>
                  <th class="py-2 px-2 text-left">Participant</th>
                  <th class="py-2 px-2 text-left">League</th>
                  <th class="py-2 px-2 text-left">Total distance</th>
                  <th class="py-2 px-2 text-left">Total time</th>
                </tr>
              </thead>
              <tbody id="leaderboard-body"></tbody>
            </table>
          </div>
          <div id="no-entries" class="text-xs text-gray-400 mt-3">
            No activities yet. Be the first to log a run and take the top spot.
          </div>
        </div>

        <div class="mih-card p-6 md:p-8">
          <h3 class="text-lg font-semibold mb-2">My activities</h3>
          <p class="text-xs text-gray-400 mb-3">
            Only activities from the account you are logged in with are shown here.
          </p>
          <div class="overflow-x-auto text-xs md:text-sm">
            <table class="w-full border-collapse min-w-full">
              <thead class="text-gray-400 text-[11px] uppercase tracking-wide border-b border-white/10">
                <tr>
                  <th class="py-2 px-2 text-left">Date</th>
                  <th class="py-2 px-2 text-left">Distance</th>
                  <th class="py-2 px-2 text-left">Time</th>
                </tr>
              </thead>
              <tbody id="my-activities-body"></tbody>
            </table>
          </div>
          <div id="no-my-activities" class="text-xs text-gray-400 mt-3">
            No activities yet for this account.
          </div>
        </div>
      </main>
    </div>
  </section>

  <!-- MIH STATS -->
  <section id="scene-mih-stats" class="scene">
    <div class="min-h-screen bg-black text-white pt-16 pb-20 px-4 md:px-6">
      <div class="max-w-5xl mx-auto mb-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <div class="text-[10px] tracking-[0.5em] uppercase text-gray-400 mb-1">
            Make It
          </div>
          <div class="text-2xl md:text-3xl font-semibold tracking-[0.5em] uppercase">
            Happen
          </div>
        </div>
        <div class="flex flex-wrap gap-2 text-xs md:text-sm">
          <button class="px-3 py-1 rounded-full border border-white/20 text-gray-300" type="button" onclick="showScene('mih-login')">
            Login
          </button>
          <button class="px-3 py-1 rounded-full border border-white/20 text-gray-300" type="button" onclick="showScene('mih-welcome')">
            Welcome
          </button>
          <button class="px-3 py-1 rounded-full border border-white/20 text-gray-300" type="button" onclick="showScene('mih-leaderboard')">
            Leaderboard
          </button>
          <button class="px-3 py-1 rounded-full border border-white/20 text-gray-300" type="button" onclick="showScene('mih-stats')">
            Stats
          </button>
          <button class="px-3 py-1 rounded-full border border-white/20 text-gray-300" type="button" onclick="showScene('mih-about')">
            About
          </button>
        </div>
      </div>

      <main class="max-w-5xl mx-auto">
        <div class="mih-card p-6 md:p-8">
          <h2 class="text-xl font-semibold mb-2">Player stats</h2>
          <p class="text-sm text-gray-300 mb-3">
            Every activity builds your stats. This table looks at runs, total distance and more.
          </p>
          <div class="overflow-x-auto text-xs md:text-sm">
            <table class="w-full border-collapse min-w-full">
              <thead class="text-gray-400 text-[11px] uppercase tracking-wide border-b border-white/10">
                <tr>
                  <th class="py-2 px-2 text-left">Participant</th>
                  <th class="py-2 px-2 text-left">League</th>
                  <th class="py-2 px-2 text-left">Runs</th>
                  <th class="py-2 px-2 text-left">Total distance</th>
                  <th class="py-2 px-2 text-left">Total time</th>
                  <th class="py-2 px-2 text-left">Avg distance</th>
                  <th class="py-2 px-2 text-left">Best distance</th>
                  <th class="py-2 px-2 text-left">Improvement</th>
                </tr>
              </thead>
              <tbody id="stats-body"></tbody>
            </table>
          </div>
          <div id="no-stats" class="text-xs text-gray-400 mt-3">
            Stats will appear as soon as people start logging their activities.
          </div>
        </div>
      </main>
    </div>
  </section>

  <!-- MIH PROFILE -->
  <section id="scene-mih-profile" class="scene">
    <div class="min-h-screen bg-black text-white pt-16 pb-20 px-4 md:px-6">
      <div class="max-w-3xl mx-auto space-y-6">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-2xl font-semibold" id="profileName">Runner profile</h2>
            <p class="text-xs text-gray-400" id="profileLeague"></p>
          </div>
          <button
            class="px-3 py-1 rounded-full border border-white/25 text-[11px]"
            type="button"
            onclick="showScene('mih-leaderboard')"
          >
            Back to leaderboard
          </button>
        </div>

        <div class="mih-card p-6 space-y-4 text-sm">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="profile-label">Total distance</div>
              <div class="profile-value" id="profileTotalDistance">–</div>
            </div>
            <div>
              <div class="profile-label">Total time</div>
              <div class="profile-value" id="profileTotalTime">–</div>
            </div>
            <div>
              <div class="profile-label">Runs logged</div>
              <div class="profile-value" id="profileRuns">–</div>
            </div>
            <div>
              <div class="profile-label">Average distance</div>
              <div class="profile-value" id="profileAvgDistance">–</div>
            </div>
          </div>

          <hr class="border-white/10 my-4" />

          <h3 class="text-lg font-semibold mb-1">Estimated best times</h3>
          <p class="text-xs text-gray-400 mb-3">
            Based on the pace from your logged runs.
          </p>
          <div class="grid grid-cols-3 gap-4 text-sm">
            <div>
              <div class="profile-label">5 km</div>
              <div class="profile-value" id="profileBest5k">–</div>
            </div>
            <div>
              <div class="profile-label">10 km</div>
              <div class="profile-value" id="profileBest10k">–</div>
            </div>
            <div>
              <div class="profile-label">100 m</div>
              <div class="profile-value" id="profileBest100m">–</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- MIH ABOUT -->
  <section id="scene-mih-about" class="scene">
    <div class="min-h-screen bg-black text-white pt-16 pb-20 px-4 md:px-6">
      <div class="max-w-5xl mx-auto mb-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <div class="text-[10px] tracking-[0.5em] uppercase text-gray-400 mb-1">
            Make It
          </div>
          <div class="text-2xl md:text-3xl font-semibold tracking-[0.5em] uppercase">
            Happen
          </div>
        </div>
        <div class="flex flex-wrap gap-2 text-xs md:text-sm">
          <button class="px-3 py-1 rounded-full border border-white/20 text-gray-300" type="button" onclick="showScene('mih-login')">
            Login
          </button>
          <button class="px-3 py-1 rounded-full border border-white/20 text-gray-300" type="button" onclick="showScene('mih-welcome')">
            Welcome
          </button>
          <button class="px-3 py-1 rounded-full border border-white/20 text-gray-300" type="button" onclick="showScene('mih-leaderboard')">
            Leaderboard
          </button>
          <button class="px-3 py-1 rounded-full border border-white/20 text-gray-300" type="button" onclick="showScene('mih-stats')">
            Stats
          </button>
          <button class="px-3 py-1 rounded-full border border-white/20 text-gray-300" type="button" onclick="showScene('mih-about')">
            About
          </button>
        </div>
      </div>

      <main class="max-w-5xl mx-auto">
        <div class="mih-card p-6 md:p-8 space-y-4 text-sm md:text-base text-gray-200">
          <h2 class="text-xl font-semibold mb-2">
            About Make It Happen
          </h2>
          <p>
            Make It Happen is a simple health challenge for anyone who wants to move a bit more without
            subscriptions or complicated apps. You log what you do and see where you land in your league.
          </p>
          <p>
            It is not about being the fastest in the world. It is about small sessions adding up over
            weeks and months.
          </p>
          <p class="font-semibold">
            It is built to be:
          </p>
          <ul class="list-disc list-inside space-y-1">
            <li><strong>Healthy</strong> – even short walks and slow runs help your heart, sleep and energy.</li>
            <li><strong>Free</strong> – no paid tiers and no hidden upgrades.</li>
            <li><strong>Fun</strong> – gentle competition and visible progress instead of pressure.</li>
          </ul>
          <p class="text-sm text-gray-300">
            Data lives in Firebase and is only used to run this simple leaderboard. No ads, no tracking across other sites.
          </p>
          <div class="flex flex-wrap gap-3 text-xs md:text-sm mt-2">
            <button
              class="px-4 py-2 rounded-full border border-white/20"
              type="button"
              onclick="showScene('mih-leaderboard')"
            >
              Go to leaderboard
            </button>
          </div>
        </div>
      </main>
    </div>
  </section>

  <!-- MAIN SCRIPT (non-module) -->
  <script>
    // GSAP fade
    window.addEventListener("load", function () {
      if (window.gsap && window.ScrollTrigger) {
        gsap.registerPlugin(ScrollTrigger);
        gsap.utils.toArray(".fade-section").forEach(function (sec) {
          gsap.to(sec, {
            opacity: 1,
            y: 0,
            duration: 1,
            scrollTrigger: {
              trigger: sec,
              start: "top 80%",
              once: true,
            },
          });
        });
      }
    });

    var exitHomeBtn = document.getElementById("exitHomeBtn");
    var sepNav = document.getElementById("sepNav");

    function isSepScene(name) {
      return name.indexOf("sep-") === 0;
    }
    function isMihScene(name) {
      return name.indexOf("mih-") === 0;
    }

    function updateURLForScene(name) {
      var path = window.location.pathname || "/";
      var base = path.replace(/\/(sepshop|MIH)$/, "");
      if (name === "home") {
        history.pushState({ scene: "home" }, "", base || "/");
      } else if (isSepScene(name)) {
        history.pushState({ scene: name }, "", base + "/sepshop");
      } else if (isMihScene(name)) {
        history.pushState({ scene: name }, "", base + "/MIH");
      }
    }

    function showScene(name, pushState) {
      if (pushState === undefined) pushState = true;
      document.querySelectorAll(".scene").forEach(function (s) {
        s.classList.remove("active");
      });
      var target = document.getElementById("scene-" + name);
      if (target) {
        target.classList.add("active");
      }
      window.scrollTo({ top: 0, left: 0, behavior: "instant" });

      if (name === "home") {
        exitHomeBtn.style.display = "none";
      } else {
        exitHomeBtn.style.display = "flex";
      }

      if (isSepScene(name)) {
        sepNav.style.display = "flex";
      } else {
        sepNav.style.display = "none";
      }

      if (pushState) {
        updateURLForScene(name);
      }
    }

    window.addEventListener("popstate", function (event) {
      var scene = event.state && event.state.scene ? event.state.scene : "home";
      showScene(scene, false);
    });

    function initRouteFromPath() {
      var path = window.location.pathname || "/";
      if (/\/sepshop$/.test(path)) {
        showScene("sep-shop", false);
      } else if (/\/MIH$/.test(path)) {
        showScene("mih-welcome", false);
      } else {
        showScene("home", false);
      }
      var activeScene = document.querySelector(".scene.active");
      if (activeScene) {
        history.replaceState({ scene: activeScene.id.replace("scene-", "") }, "", window.location.pathname);
      }
    }

    exitHomeBtn.addEventListener("click", function () {
      showScene("home");
    });
    document.getElementById("homeSepBtn").addEventListener("click", function () {
      showScene("sep-shop");
    });
    document.getElementById("homeMihBtn").addEventListener("click", function () {
      showScene("mih-welcome");
    });

    var sepNavToggle = document.getElementById("sepNavToggle");
    var sepNavMenu = document.getElementById("sepNavMenu");
    sepNavToggle.addEventListener("click", function () {
      sepNavMenu.classList.toggle("show");
    });

    // SEP CART (localStorage)
    var cart = JSON.parse(localStorage.getItem("sep_cart")) || [];
    var cartSidebar = document.getElementById("cartSidebar");
    var cartOverlay = document.getElementById("cartOverlay");
    var SHIPPING_BASE = 45;
    var isCopenhagen = false;
    var sepHeroButtons = document.getElementById("sepHeroButtons");

    function setShippingButtons() {
      var btnCph = document.getElementById("shippingCph");
      var btnNon = document.getElementById("shippingNonCph");
      if (isCopenhagen) {
        btnCph.classList.add("bg-gray-200");
        btnNon.classList.remove("bg-gray-200");
        btnNon.classList.add("bg-transparent");
      } else {
        btnCph.classList.remove("bg-gray-200");
        btnNon.classList.add("bg-gray-200");
      }
    }
    function currentShippingCost() {
      return isCopenhagen ? 0 : SHIPPING_BASE;
    }
    function updateCounter() {
      var c = document.getElementById("cartCounter");
      var t = cart.reduce(function (sum, i) {
        return sum + i.qty;
      }, 0);
      if (t > 0) {
        c.textContent = t;
        c.classList.remove("hidden");
      } else {
        c.classList.add("hidden");
      }
    }
    function updateCart() {
      var items = document.getElementById("cartItems");
      var subtotal = document.getElementById("cartSubtotal");
      var total = document.getElementById("cartTotal");
      var shippingLabel = document.getElementById("cartShippingLabel");
      items.innerHTML = "";
      var sum = 0;

      if (cart.length === 0) {
        items.innerHTML = '<p class="text-center text-gray-500 py-10">Cart is empty</p>';
        subtotal.textContent = "0 kr.";
      } else {
        cart.forEach(function (it, i) {
          var priceNum = parseInt(String(it.price).replace(/\D/g, "")) || 0;
          var linePrice = priceNum * it.qty;
          sum += linePrice;
          items.innerHTML +=
            '<div class="border-b pb-2">' +
            '<div class="flex justify-between"><span>' +
            it.name +
            "</span><span>" +
            linePrice +
            " kr.</span></div>" +
            '<div class="text-gray-500 text-xs">Size: ' +
            it.size +
            " | Qty: " +
            it.qty +
            "</div>" +
            '<button class="text-red-500 text-xs mt-1" onclick="removeFromCart(' +
            i +
            ')">Remove</button>' +
            "</div>";
        });
        subtotal.textContent = sum + " kr.";
      }

      var ship = currentShippingCost();
      shippingLabel.textContent =
        ship === 0 ? "0 kr. (FREE in Copenhagen)" : "+" + ship + " kr.";
      total.textContent = sum + ship + " kr.";

      localStorage.setItem("sep_cart", JSON.stringify(cart));
      updateCounter();
    }
    function addToCart(name, price, size, qty) {
      if (qty <= 0 || !Number.isFinite(qty)) return;
      var f = cart.findIndex(function (i) {
        return i.name === name && i.size === size;
      });
      if (f >= 0) {
        cart[f].qty += qty;
      } else {
        cart.push({ name: name, price: price, size: size, qty: qty });
      }
      updateCart();
      showPopup("Added to cart");
    }
    function removeFromCart(i) {
      cart.splice(i, 1);
      updateCart();
    }
    function showPopup(text) {
      var popup = document.createElement("div");
      popup.className = "popup";
      popup.textContent = text;
      document.body.appendChild(popup);
      setTimeout(function () {
        popup.classList.add("show");
      }, 10);
      setTimeout(function () {
        popup.classList.remove("show");
        setTimeout(function () {
          popup.remove
          popup.remove();
        }, 250);
      }, 2000);
    }

    // Attach add-to-cart handlers
    document.querySelectorAll(".add-to-cart").forEach(function (btn) {
      btn.addEventListener("click", function () {
        var card = btn.closest(".product-card");
        var name = card.querySelector("h3").textContent;
        var price = card.querySelector("p").textContent;
        var size = card.querySelector("select").value;
        var qty = parseInt(card.querySelector(".quantity-selector").value, 10);
        addToCart(name, price, size, qty);
      });
    });

    // Cart open / close
    var viewCartBtn = document.getElementById("viewCartBtn");
    if (viewCartBtn) {
      viewCartBtn.addEventListener("click", function () {
        cartSidebar.classList.remove("translate-x-full");
        cartOverlay.classList.remove("hidden");
        sepNav.style.opacity = "0";
        if (sepHeroButtons) sepHeroButtons.style.opacity = "0";
      });
    }
    document.getElementById("closeCart").addEventListener("click", closeCart);
    cartOverlay.addEventListener("click", closeCart);

    function closeCart() {
      cartSidebar.classList.add("translate-x-full");
      cartOverlay.classList.add("hidden");
      sepNav.style.opacity = "1";
      if (sepHeroButtons) sepHeroButtons.style.opacity = "1";
    }

    // Shipping buttons
    document
      .getElementById("shippingCph")
      .addEventListener("click", function () {
        isCopenhagen = true;
        setShippingButtons();
        updateCart();
      });
    document
      .getElementById("shippingNonCph")
      .addEventListener("click", function () {
        isCopenhagen = false;
        setShippingButtons();
        updateCart();
      });

    setShippingButtons();
    updateCart();

    // MobilePay behaviour
    var mobilePayNum = "5894BZ";
    document
      .getElementById("openMobilePay")
      .addEventListener("click", function () {
        var digits = mobilePayNum.replace(/\D/g, "");
        if (digits) {
          window.location.href = "mobilepay://transfer?phone=" + digits;
        }
        alert("Thank you for supporting SEP.");
      });

    document
      .getElementById("copyMobilePay")
      .addEventListener("click", function () {
        var subtotal = document.getElementById("cartSubtotal").textContent;
        var total = document.getElementById("cartTotal").textContent;
        var shipping = document.getElementById("cartShippingLabel").textContent;

        var lines = cart.map(function (i) {
          return i.qty + "× " + i.name + " (Size: " + i.size + ")";
        });

        var msg =
          "Hi SEP, here is my order:\n" +
          (lines.length ? lines.join("\n") : "[Cart is empty]") +
          "\n\nSubtotal: " +
          subtotal +
          "\nShipping: " +
          shipping +
          "\nTotal: " +
          total;

        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(msg).then(function () {
            showPopup("Order message copied.");
          });
        } else {
          // Fallback
          var ta = document.createElement("textarea");
          ta.value = msg;
          document.body.appendChild(ta);
          ta.select();
          try {
            document.execCommand("copy");
            showPopup("Order message copied.");
          } catch (e) {
            alert("Copy this message:\n\n" + msg);
          }
          document.body.removeChild(ta);
        }
      });

    // -----------------------------
    // MAKE IT HAPPEN – FIREBASE
    // -----------------------------
    var STORAGE_KEY_CURRENT_USER = "mih_current_user_v1";
    var currentUser = null;

    function loadCurrentUser() {
      var raw = localStorage.getItem(STORAGE_KEY_CURRENT_USER);
      if (!raw) return;
      try {
        currentUser = JSON.parse(raw);
      } catch (e) {
        currentUser = null;
      }
    }

    function saveCurrentUser() {
      if (currentUser) {
        localStorage.setItem(
          STORAGE_KEY_CURRENT_USER,
          JSON.stringify(currentUser)
        );
      } else {
        localStorage.removeItem(STORAGE_KEY_CURRENT_USER);
      }
    }

    function setEntryFormEnabled(enabled) {
      var nameInput = document.getElementById("name");
      var distance = document.getElementById("distance");
      var time = document.getElementById("time");
      var btn = document.querySelector("#entry-form button[type='submit']");
      if (!nameInput || !distance || !time || !btn) return;

      if (enabled) {
        nameInput.disabled = true;
        distance.disabled = false;
        time.disabled = false;
        btn.disabled = false;
        nameInput.value = currentUser ? currentUser.name : "";
      } else {
        nameInput.disabled = true;
        distance.disabled = true;
        time.disabled = true;
        btn.disabled = true;
        nameInput.value = "Log in to set your name";
      }
    }

    function updateUserControlsUI() {
      var container = document.getElementById("user-controls");
      if (!container) return;
      container.innerHTML = "";

      if (!currentUser) {
        container.innerHTML =
          '<span class="text-gray-500">Not logged in</span>';
        setEntryFormEnabled(false);
        return;
      }

      var span = document.createElement("span");
      span.textContent =
        "Logged in as " +
        currentUser.name +
        (currentUser.league ? " · " + currentUser.league : "");
      span.className = "text-gray-300";

      var btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = "Log out";
      btn.className =
        "px-3 py-1 rounded-full border border-white/25 text-[11px]";
      btn.addEventListener("click", function () {
        currentUser = null;
        saveCurrentUser();
        updateUserControlsUI();
        renderLeaderboard();
        renderStats();
        renderMyActivities();
      });

      container.appendChild(span);
      container.appendChild(btn);
      setEntryFormEnabled(true);
    }

    function formatKm(val) {
      var v = Number(val) || 0;
      return v.toFixed(1) + " km";
    }
    function formatMinutes(val) {
      var v = Number(val) || 0;
      return v.toFixed(1) + " min";
    }

    async function renderLeaderboard() {
      var body = document.getElementById("leaderboard-body");
      var empty = document.getElementById("no-entries");
      if (!body) return;

      body.innerHTML = "";
      if (!window.mihFirebaseApi) {
        if (empty) {
          empty.textContent =
            "Leaderboard will appear when Firebase is configured.";
        }
        return;
      }

      var rows;
      try {
        rows = await window.mihFirebaseApi.buildLeaderboard();
      } catch (e) {
        console.warn("Leaderboard error:", e);
        if (empty) {
          empty.textContent = "Could not load leaderboard right now.";
        }
        return;
      }

      var leagueFilter = document.getElementById("league-filter");
      var filterValue = leagueFilter ? leagueFilter.value : "all";
      if (filterValue && filterValue !== "all") {
        rows = rows.filter(function (r) {
          return r.league === filterValue;
        });
      }

      if (!rows.length) {
        if (empty) empty.style.display = "block";
        return;
      }
      if (empty) empty.style.display = "none";

      rows.forEach(function (row, index) {
        var tr = document.createElement("tr");
        tr.className = index % 2 === 0 ? "bg-black/10" : "bg-black/5";
        tr.innerHTML =
          '<td class="py-2 pr-2">' +
          (index + 1) +
          "</td>" +
          '<td class="py-2 px-2">' +
          row.name +
          "</td>" +
          '<td class="py-2 px-2 capitalize">' +
          (row.league || "") +
          "</td>" +
          '<td class="py-2 px-2">' +
          formatKm(row.totalDistance) +
          "</td>" +
          '<td class="py-2 px-2">' +
          formatMinutes(row.totalTime) +
          "</td>";
        body.appendChild(tr);
      });
    }

    async function renderStats() {
      var body = document.getElementById("stats-body");
      var empty = document.getElementById("no-stats");
      if (!body) return;

      body.innerHTML = "";
      if (!window.mihFirebaseApi) {
        if (empty) {
          empty.textContent =
            "Stats will appear when Firebase is configured correctly.";
        }
        return;
      }

      var rows;
      try {
        rows = await window.mihFirebaseApi.buildStats();
      } catch (e) {
        console.warn("Stats error:", e);
        if (empty) empty.textContent = "Could not load stats right now.";
        return;
      }

      if (!rows.length) {
        if (empty) empty.style.display = "block";
        return;
      }
      if (empty) empty.style.display = "none";

      rows.forEach(function (row) {
        var tr = document.createElement("tr");
        tr.className = "bg-black/5";
        tr.innerHTML =
          '<td class="py-2 px-2">' +
          row.name +
          "</td>" +
          '<td class="py-2 px-2 capitalize">' +
          (row.league || "") +
          "</td>" +
          '<td class="py-2 px-2">' +
          (row.runs || 0) +
          "</td>" +
          '<td class="py-2 px-2">' +
          formatKm(row.totalDistance) +
          "</td>" +
          '<td class="py-2 px-2">' +
          formatMinutes(row.totalTime) +
          "</td>" +
          '<td class="py-2 px-2">' +
          formatKm(row.avgDistance) +
          "</td>" +
          '<td class="py-2 px-2">' +
          (row.bestDistance ? formatKm(row.bestDistance) : "–") +
          "</td>" +
          '<td class="py-2 px-2">' +
          (row.improvement ? row.improvement.toFixed(1) + "%" : "–") +
          "</td>";
        body.appendChild(tr);
      });
    }

    async function renderMyActivities() {
      var body = document.getElementById("my-activities-body");
      var empty = document.getElementById("no-my-activities");
      if (!body) return;

      body.innerHTML = "";
      if (!currentUser || !window.mihFirebaseApi) {
        if (empty) {
          empty.textContent =
            "Log in to see the activities for your account.";
          empty.style.display = "block";
        }
        return;
      }

      var entries;
      try {
        entries = await window.mihFirebaseApi.fetchEntriesForUser(
          currentUser.id
        );
      } catch (e) {
        console.warn("My activities error:", e);
        if (empty) {
          empty.textContent = "Could not load your activities right now.";
          empty.style.display = "block";
        }
        return;
      }

      if (!entries.length) {
        if (empty) {
          empty.textContent = "No activities yet for this account.";
          empty.style.display = "block";
        }
        return;
      }
      if (empty) empty.style.display = "none";

      entries.forEach(function (e) {
        var tr = document.createElement("tr");
        tr.className = "bg-black/5";
        var dateText = e.createdAt && e.createdAt.toDate
          ? e.createdAt.toDate().toLocaleDateString()
          : "";
        tr.innerHTML =
          '<td class="py-2 px-2">' +
          dateText +
          "</td>" +
          '<td class="py-2 px-2">' +
          formatKm(e.distanceKm) +
          "</td>" +
          '<td class="py-2 px-2">' +
          formatMinutes(e.timeMinutes) +
          "</td>";
        body.appendChild(tr);
      });
    }

    async function renderProfileForCurrentUser() {
      if (!currentUser || !window.mihFirebaseApi) return;
      try {
        var profile = await window.mihFirebaseApi.buildProfile(currentUser.id);
        document.getElementById("profileName").textContent =
          profile.user.name || "Runner profile";
        document.getElementById("profileLeague").textContent =
          "League: " + (profile.user.league || "amateurs");
        document.getElementById("profileTotalDistance").textContent =
          formatKm(profile.totalDistance);
        document.getElementById("profileTotalTime").textContent =
          formatMinutes(profile.totalTime);
        document.getElementById("profileRuns").textContent = profile.runs || 0;
        document.getElementById("profileAvgDistance").textContent =
          formatKm(profile.avgDistance);
        document.getElementById("profileBest5k").textContent =
          profile.bestTimes["5k"];
        document.getElementById("profileBest10k").textContent =
          profile.bestTimes["10k"];
        document.getElementById("profileBest100m").textContent =
          profile.bestTimes["100m"];
      } catch (e) {
        console.warn("Profile error:", e);
      }
    }

    // Login form submit
    var loginForm = document.getElementById("login-form");
    if (loginForm) {
      loginForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        if (!window.mihFirebaseApi) {
          alert(
            "Make It Happen is still initialising. Please wait a few seconds and try again."
          );
          return;
        }
        var name = document.getElementById("login-name").value.trim();
        var password = document.getElementById("login-password").value.trim();
        if (!name || !password) return;

        var submitBtn = loginForm.querySelector("button[type='submit']");
        if (submitBtn) submitBtn.disabled = true;

        try {
          var user = await window.mihFirebaseApi.loginOrCreateUser(
            name,
            password
          );
          currentUser = {
            id: user.id,
            name: user.name,
            league: user.league,
          };
          saveCurrentUser();
          updateUserControlsUI();
          setEntryFormEnabled(true);
          showPopup("Logged in as " + user.name);
          showScene("mih-leaderboard");
          renderLeaderboard();
          renderStats();
          renderMyActivities();
          renderProfileForCurrentUser();
        } catch (err) {
          console.warn("Login error:", err);
          if (err && err.message === "wrong-password") {
            alert("Wrong password for this name. Please try again.");
          } else {
            alert("Could not log in right now. Please try again later.");
          }
        } finally {
          if (submitBtn) submitBtn.disabled = false;
        }
      });
    }

    // Entry form submit
    var entryForm = document.getElementById("entry-form");
    if (entryForm) {
      entryForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        if (!currentUser) {
          alert("Please log in before adding an activity.");
          return;
        }
        if (!window.mihFirebaseApi) {
          alert(
            "Make It Happen is still initialising. Please wait and try again."
          );
          return;
        }

        var distance = parseFloat(
          document.getElementById("distance").value || "0"
        );
        var time = parseFloat(document.getElementById("time").value || "0");
        if (!distance || !time) {
          alert("Please enter a valid distance and time.");
          return;
        }

        var btn = entryForm.querySelector("button[type='submit']");
        if (btn) btn.disabled = true;

        try {
          await window.mihFirebaseApi.addActivity(
            currentUser.id,
            distance,
            time
          );
          document.getElementById("distance").value = "";
          document.getElementById("time").value = "";
          showPopup("Activity saved.");
          renderLeaderboard();
          renderStats();
          renderMyActivities();
          renderProfileForCurrentUser();
        } catch (err) {
          console.warn("Add activity error:", err);
          alert("Could not save this activity. Please try again.");
        } finally {
          if (btn) btn.disabled = false;
        }
      });
    }

    // Initialisation
    loadCurrentUser();
    updateUserControlsUI();
    initRouteFromPath();
    renderLeaderboard();
    renderStats();
    renderMyActivities();

  </script>
</body>
</html>
