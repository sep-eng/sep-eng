<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SEP â€“ Make It Happen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Icons -->
  <link rel="apple-touch-icon" href="sep-logo.jpg">
  <link rel="icon" type="image/jpeg" sizes="192x192" href="sep-logo.jpg">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      font-family: Inter, sans-serif;
      background: #000000;
      color: #f7f7f7;
    }

    header {
      display: flex;
      justify-content: space-between;
      padding: 12px 16px;
      background: #050505;
      border-bottom: 1px solid #222222;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header nav button {
      background: none;
      border: none;
      padding: 8px 12px;
      font-size: 15px;
      cursor: pointer;
      color: #f7f7f7;
    }

    header nav button.active {
      font-weight: 600;
      color: #ffffff;
      border-bottom: 1px solid #ffffff;
    }

    .scene {
      display: none;
      max-width: 900px;
      margin: auto;
      padding: 20px;
    }
    .scene.active {
      display: block;
    }

    h1, h2 {
      color: #ffffff;
    }

    .btn {
      background: #ffffff;
      color: #000000;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin: 8px 0;
    }

    .btn-small {
      padding: 6px 10px;
      font-size: 14px;
    }

    .danger {
      background: #b91c1c;
      color: #ffffff;
    }

    .input {
      width: 100%;
      padding: 10px;
      margin: 6px 0 14px;
      border: 1px solid #555;
      border-radius: 6px;
      font-size: 16px;
      background: #111;
      color: #f7f7f7;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 14px;
      background: #111111;
    }

    th, td {
      padding: 8px;
      border-bottom: 1px solid #333;
      text-align: left;
      color: #f7f7f7;
    }

    .badge-league {
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 12px;
      color: white;
    }
    .amateurs { background: #6c757d; }
    .intermediates { background: #3b82f6; }
    .pros { background: #22c55e; }
    .legends { background: #e5e5e5; color:#000; }
    .pending { background: #888888; }
  </style>
</head>

<body>

<header>
  <nav>
    <button onclick="showScene('welcome')" data-i18n="nav.welcome"></button>
    <button onclick="showScene('leaderboard')" data-i18n="nav.leaderboard"></button>
    <button onclick="showScene('stats')" data-i18n="nav.stats"></button>
    <button onclick="showScene('rules')" data-i18n="nav.rules"></button>
    <button onclick="showScene('about')" data-i18n="nav.about"></button>
    <button onclick="showScene('entry')" data-i18n="nav.entry"></button>
    <button id="nav-login-btn" onclick="showScene('login')" data-i18n="nav.login"></button>
  </nav>

  <div style="display:flex; gap:8px; align-items:center;">
    <select id="lang-select">
      <option value="en">English</option>
      <option value="da">Dansk</option>
      <option value="cs">ÄŒeÅ¡tina</option>
    </select>

    <div id="user-controls"></div>
  </div>
</header>

<!-- WELCOME SCENE -->
<section id="scene-welcome" class="scene active">
  <h1 data-i18n="welcome.title"></h1>
  <p data-i18n="welcome.subtitle"></p>
  <button class="btn" onclick="showScene('login')" data-i18n="welcome.cta"></button>
</section>

<!-- LOGIN SCENE -->
<section id="scene-login" class="scene">
  <h1 data-i18n="login.title"></h1>
  <p data-i18n="login.description"></p>

  <form id="login-form">
    <label data-i18n="login.name"></label>
    <input id="login-name" class="input" type="text">

    <label data-i18n="login.password"></label>
    <input id="login-password" class="input" type="password">

    <button class="btn" data-i18n="login.submit"></button>
  </form>

  <button id="view-code-btn" class="btn btn-small" type="button" style="margin-top:4px;">
    View saved login password
  </button>
  <p id="saved-code-display" style="display:none; margin-top:6px;"></p>

  <p data-i18n="login.note"></p>
</section>

<!-- LEADERBOARD SCENE -->
<section id="scene-leaderboard" class="scene">
  <h1 data-i18n="leaderboard.title"></h1>

  <label data-i18n="leaderboard.filter"></label>
  <select id="league-filter" class="input" style="max-width:260px;">
    <option value="all" data-i18n="leaderboard.all"></option>
    <option value="pending" data-i18n="league.pending"></option>
    <option value="amateurs" data-i18n="league.amateurs"></option>
    <option value="intermediates" data-i18n="league.intermediates"></option>
    <option value="pros" data-i18n="league.pros"></option>
    <option value="legends" data-i18n="league.legends"></option>
  </select>

  <table>
    <thead>
      <tr>
        <th data-i18n="lb.rank"></th>
        <th data-i18n="lb.name"></th>
        <th data-i18n="lb.league"></th>
        <th data-i18n="lb.distance"></th>
        <th data-i18n="lb.time"></th>
      </tr>
    </thead>
    <tbody id="leaderboard-body"></tbody>
  </table>

  <p id="no-entries" data-i18n="leaderboard.none"></p>

  <!-- Pending view -->
  <h2 data-i18n="pending.title"></h2>
  <p data-i18n="pending.subtitle"></p>

  <table>
    <thead>
      <tr>
        <th data-i18n="pending.rank"></th>
        <th data-i18n="pending.name"></th>
        <th data-i18n="pending.joinMonth"></th>
      </tr>
    </thead>
    <tbody id="pending-body"></tbody>
  </table>

  <p id="no-pending" data-i18n="pending.none"></p>
</section>

<!-- STATS SCENE -->
<section id="scene-stats" class="scene">
  <h1 data-i18n="stats.title"></h1>

  <table>
    <thead>
      <tr>
        <th data-i18n="lb.name"></th>
        <th data-i18n="lb.league"></th>
        <th data-i18n="stats.runs"></th>
        <th data-i18n="stats.totaldistance"></th>
        <th data-i18n="stats.totaltime"></th>
        <th data-i18n="stats.avgdistance"></th>
        <th data-i18n="stats.bestdistance"></th>
        <th data-i18n="stats.improvement"></th>
      </tr>
    </thead>
    <tbody id="stats-body"></tbody>
  </table>

  <p id="no-stats" data-i18n="stats.none"></p>
</section>

<!-- RULES SCENE -->
<section id="scene-rules" class="scene">
  <h1 data-i18n="rules.title"></h1>

  <h2 data-i18n="rules.joiningtitle"></h2>
  <p data-i18n="rules.joiningtext"></p>

  <h2 data-i18n="rules.leaguetitle"></h2>
  <p data-i18n="rules.leaguetext"></p>

  <h2 data-i18n="rules.promotiontitle"></h2>
  <p data-i18n="rules.promotiontext"></p>
</section>

<!-- ABOUT SCENE -->
<section id="scene-about" class="scene">
  <h1 data-i18n="about.title"></h1>
  <p data-i18n="about.text1"></p>
  <p data-i18n="about.text2"></p>
  <p data-i18n="about.text3"></p>
</section>

<!-- ENTRY FORM + MY ACTIVITIES -->
<section id="scene-entry" class="scene">
  <h1 data-i18n="entry.title"></h1>

  <form id="entry-form">
    <label data-i18n="entry.distance"></label>
    <input id="distance" type="number" step="0.01" class="input">

    <label data-i18n="entry.time"></label>
    <input id="time" type="number" step="0.01" class="input">

    <button class="btn" data-i18n="entry.submit"></button>
  </form>

  <h2 data-i18n="entry.my"></h2>
  <table>
    <thead>
      <tr>
        <th data-i18n="entry.date"></th>
        <th data-i18n="entry.distance"></th>
        <th data-i18n="entry.time"></th>
        <th data-i18n="entry.actions"></th>
      </tr>
    </thead>
    <tbody id="my-activities-body"></tbody>
  </table>

  <p id="no-my-activities" data-i18n="entry.none"></p>
</section>

<!-- PROFILE SCENE -->
<section id="profile-card" class="scene" style="display:none;">
  <h1 id="profile-title"></h1>
  <p id="profile-summary"></p>

  <table>
    <tr><th data-i18n="profile.runs"></th><td id="profile-runs"></td></tr>
    <tr><th data-i18n="profile.totaldistance"></th><td id="profile-total-distance"></td></tr>
    <tr><th data-i18n="profile.totaltime"></th><td id="profile-total-time"></td></tr>
    <tr><th data-i18n="profile.avgdistance"></th><td id="profile-avg-distance"></td></tr>
    <tr><th data-i18n="profile.avgpace"></th><td id="profile-avg-pace"></td></tr>
    <tr><th data-i18n="profile.longest"></th><td id="profile-longest"></td></tr>
    <tr><th data-i18n="profile.best10k"></th><td id="profile-10k"></td></tr>
    <tr><th data-i18n="profile.best5k"></th><td id="profile-5k"></td></tr>
  </table>
</section>

<!-- Firebase scripts -->
<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>

<script>
  // ==========================
  //  CONFIG
  // ==========================

  const firebaseConfig = {
    apiKey: "AIzaSyAkbH3mJkeheF3L7EaqN1kMgbFd_LJCIXo",
    authDomain: "hitachi-vantara-make-it-happen.firebaseapp.com",
    projectId: "hitachi-vantara-make-it-happen",
    storageBucket: "hitachi-vantara-make-it-happen.firebasestorage.app",
    messagingSenderId: "749690169824",
    appId: "1:749690169824:web:21d6b8d2a5862847e4e385",
    measurementId: "G-7WZ03E68MF"
  };

  const LS_CURRENT_USER_KEY = "mih_current_user_id";
  const LS_LANG_KEY = "mih_lang";
  const LS_PASSWORD_KEY = "mih_saved_password";

  const LEAGUES = ["amateurs", "intermediates", "pros", "legends"];
  const MIN_RUNS_FOR_PLACEMENT = 3;

  let db = null;
  let users = [];
  let entries = [];
  let currentUser = null;
  let currentLang = "en";
  let autoRunning = false;

  // ==========================
  //  TRANSLATIONS
  // ==========================

  const translations = {
    en: {
      // nav
      "nav.welcome": "Welcome",
      "nav.leaderboard": "Leaderboard",
      "nav.stats": "Stats",
      "nav.rules": "Rules",
      "nav.about": "About",
      "nav.entry": "Log activity",
      "nav.login": "Login",

      // welcome
      "welcome.title": "Move more. Compete together.",
      "welcome.subtitle": "Make It Happen is a simple challenge by SEP. Walk, run or cycle, log your distance and climb the leagues.",
      "welcome.cta": "Log in or create an account",

      // login
      "login.title": "Log in to Make It Happen",
      "login.description": "Create a simple account so the site knows who you are and only you can manage your activities.",
      "login.name": "Name",
      "login.password": "Password",
      "login.submit": "Log in / Create account",
      "login.note": "Your account is stored in the shared database, not just on your device. If you do not use your account for a long time it may be cleaned up.",

      // leagues
      "league.amateurs": "Amateurs",
      "league.intermediates": "Intermediates",
      "league.pros": "Pros",
      "league.legends": "Legends",
      "league.pending": "Pending",

      // leaderboard
      "leaderboard.title": "Leaderboard",
      "leaderboard.filter": "Filter by league:",
      "leaderboard.all": "All leagues",
      "leaderboard.none": "No activities yet. Be the first to log something.",
      "lb.rank": "#",
      "lb.name": "Name",
      "lb.league": "League",
      "lb.distance": "Total distance (km)",
      "lb.time": "Total time (min)",

      // pending
      "pending.title": "Pending joiners",
      "pending.subtitle": "New sign-ups who will be placed into leagues automatically.",
      "pending.rank": "#",
      "pending.name": "Name",
      "pending.joinMonth": "Join month",
      "pending.none": "No pending joiners right now.",

      // stats
      "stats.title": "Player stats and league moves",
      "stats.runs": "Runs",
      "stats.totaldistance": "Total distance (km)",
      "stats.totaltime": "Total time (min)",
      "stats.avgdistance": "Average distance (km)",
      "stats.bestdistance": "Longest distance (km)",
      "stats.improvement": "Improvement",
      "stats.none": "Stats will appear once people start logging activities.",

      // rules
      "rules.title": "Rules and leagues",
      "rules.joiningtitle": "Joining and signing up",
      "rules.joiningtext":
        "You can sign up any time. When you create an account you start as â€œPendingâ€. You can log activities straight away. The system places players into leagues based on distance, time and speed while keeping league sizes balanced.",
      "rules.leaguetitle": "Leagues and balance",
      "rules.leaguetext":
        "There are four leagues: Amateurs, Intermediates, Pros and Legends. The system tries to keep league sizes balanced so that no league becomes much larger than the others.",
      "rules.promotiontitle": "Promotions and relegations",
      "rules.promotiontext":
        "Each month the site automatically applies promotions and relegations. The number of players moved depends on how many people are active: with 8+ players there is 1 promotion and 1 relegation, with 16+ there are 2 of each, and with 32+ there are 3 of each. Rankings are based on total distance first, then total time, then average speed.",

      // about
      "about.title": "About Make It Happen",
      "about.text1":
        "Make It Happen is a simple, fair health challenge created under SEP. The goal is not to create elite athletes, but to give everyone a clear, friendly way to move more and see progress over time.",
      "about.text2":
        "You can walk, run or cycle and log your distance and time. The system looks at both how far you go and how long you spend moving. That means slower but very dedicated people still get rewarded, not only the fastest runners.",
      "about.text3":
        "New players start as â€œPendingâ€ and are automatically placed into a league over time in a way that keeps league sizes balanced.",

      // entry
      "entry.title": "Log a new activity",
      "entry.distance": "Distance (km)",
      "entry.time": "Time (minutes)",
      "entry.submit": "Save my activity",
      "entry.my": "My activities",
      "entry.date": "Date",
      "entry.actions": "Actions",
      "entry.none": "You have no activities yet for this account.",

      // profile
      "profile.runs": "Runs",
      "profile.totaldistance": "Total distance",
      "profile.totaltime": "Total time",
      "profile.avgdistance": "Average distance",
      "profile.avgpace": "Average pace",
      "profile.longest": "Longest activity",
      "profile.best10k": "Fastest ~10 km",
      "profile.best5k": "Fastest ~5 km",

      // user header
      "user.notLoggedIn": "Not logged in",
      "user.loginButton": "Login",
      "user.loggedInAs": "Logged in as {name}",
      "user.leagueLabel": "League: {league}",
      "user.addActivity": "Add activity",
      "user.deleteAccount": "Delete account",

      // alerts
      "alert.loginMissing": "Please enter both name and password.",
      "alert.firebase": "Firebase is not configured yet. Please add your Firebase config in the script.",
      "alert.mustLogin": "Please log in before adding activities.",
      "alert.activityInvalid": "Please fill in distance and time correctly with positive values.",
      "alert.noPlayers": "No players yet.",
      "alert.notEnoughPlayers": "You need at least 8 players for promotions and relegations.",
      "alert.promotionsDone": "Promotions and relegations applied: {up} up, {down} down.",
      "alert.noActivitiesToPlace": "No activities yet, nothing to place.",
      "alert.noPending": "No pending joiners ready to place.",
      "alert.placeSummary": "Placed {placed} new joiner(s) into leagues. {skipped}",
      "alert.placeSkipped": "{count} left pending (not enough data yet or for balance).",
      "alert.deleteActivityConfirm": "Delete this activity?",
      "alert.deleteAccountConfirm": "This will delete your account and all your activities. Are you sure?",
      "alert.alreadyLoggedIn": "You are already logged in. Delete your account if you want to start over.",
      "alert.passwordWrong": "Wrong password for this name."
    },

    da: {
      "nav.welcome": "Velkomst",
      "nav.leaderboard": "Rangliste",
      "nav.stats": "Statistik",
      "nav.rules": "Regler",
      "nav.about": "Om projektet",
      "nav.entry": "RegistrÃ©r aktivitet",
      "nav.login": "Log ind",

      "welcome.title": "BevÃ¦g dig mere. KonkurrÃ©r sammen.",
      "welcome.subtitle": "Make It Happen er en enkel udfordring fra SEP. GÃ¥, lÃ¸b eller cykl, registrÃ©r din distance og ryk op gennem ligaerne.",
      "welcome.cta": "Log ind eller opret konto",

      "login.title": "Log ind pÃ¥ Make It Happen",
      "login.description": "Lav en enkel konto, sÃ¥ siden ved, hvem du er, og kun du kan styre dine aktiviteter.",
      "login.name": "Navn",
      "login.password": "Adgangskode",
      "login.submit": "Log ind / Opret konto",
      "login.note": "Din konto ligger i en delt database, ikke kun pÃ¥ din egen enhed. Hvis du ikke bruger den i lang tid, kan den blive ryddet op.",

      "league.amateurs": "AmatÃ¸rer",
      "league.intermediates": "Ã˜vede",
      "league.pros": "Prof",
      "league.legends": "Legender",
      "league.pending": "Afventer",

      "leaderboard.title": "Rangliste",
      "leaderboard.filter": "FiltrÃ©r efter liga:",
      "leaderboard.all": "Alle ligaer",
      "leaderboard.none": "Ingen aktiviteter endnu. VÃ¦r den fÃ¸rste til at logge noget.",
      "lb.rank": "#",
      "lb.name": "Navn",
      "lb.league": "Liga",
      "lb.distance": "Samlet distance (km)",
      "lb.time": "Samlet tid (min)",

      "pending.title": "Afventende deltagere",
      "pending.subtitle": "Nye tilmeldinger, som bliver placeret i ligaer automatisk.",
      "pending.rank": "#",
      "pending.name": "Navn",
      "pending.joinMonth": "TilmeldingsmÃ¥ned",
      "pending.none": "Ingen afventende deltagere lige nu.",

      "stats.title": "Spillerstatistik og ligaflytninger",
      "stats.runs": "Ture",
      "stats.totaldistance": "Samlet distance (km)",
      "stats.totaltime": "Samlet tid (min)",
      "stats.avgdistance": "Gennemsnitlig distance (km)",
      "stats.bestdistance": "LÃ¦ngste tur (km)",
      "stats.improvement": "Forbedring",
      "stats.none": "Statistik vises, nÃ¥r deltagerne begynder at logge aktiviteter.",,

      "rules.title": "Regler og ligaer",
      "rules.joiningtitle": "Tilmelding og opstart",
      "rules.joiningtext":
        "Du kan tilmelde dig nÃ¥r som helst. NÃ¥r du opretter en konto, starter du som â€œAfventerâ€. Du kan logge aktiviteter med det samme. Systemet placerer spillere i ligaer ud fra distance, tid og hastighed, samtidig med at ligastÃ¸rrelserne holdes nogenlunde i balance.",
      "rules.leaguetitle": "Ligaer og balance",
      "rules.leaguetext":
        "Der er fire ligaer: AmatÃ¸rer, Ã˜vede, Prof og Legender. Systemet forsÃ¸ger at holde ligastÃ¸rrelserne i balance, sÃ¥ Ã©n liga ikke bliver markant stÃ¸rre end de andre.",
      "rules.promotiontitle": "Oprykning og nedrykning",
      "rules.promotiontext":
        "Hver mÃ¥ned udfÃ¸rer siden automatisk oprykning og nedrykning. Antallet af spillere der flyttes, afhÃ¦nger af hvor mange der er aktive: ved 8+ spillere er der 1 oprykning og 1 nedrykning, ved 16+ er der 2 af hver, og ved 32+ er der 3 af hver. Ranglisten bygger fÃ¸rst pÃ¥ samlet distance, derefter samlet tid og til sidst gennemsnitlig hastighed.",

      "about.title": "Om Make It Happen",
      "about.text1":
        "Make It Happen er en enkel, fair sundhedsudfordring under SEP. MÃ¥let er ikke at skabe elitesportsfolk, men at give alle en klar og venlig mÃ¥de at bevÃ¦ge sig mere og se deres udvikling over tid.",
      "about.text2":
        "Du kan gÃ¥, lÃ¸be eller cykle og registrere din distance og tid. Systemet kigger bÃ¥de pÃ¥ hvor langt du kommer, og hvor lÃ¦nge du er i bevÃ¦gelse. Det betyder, at langsommere men meget dedikerede deltagere ogsÃ¥ bliver belÃ¸nnet, ikke kun de hurtigste lÃ¸bere.",
      "about.text3":
        "Nye spillere starter som â€œAfventerâ€ og bliver automatisk placeret i en liga hen ad vejen, pÃ¥ en mÃ¥de der holder ligastÃ¸rrelserne i balance.",

      "entry.title": "RegistrÃ©r en ny aktivitet",
      "entry.distance": "Distance (km)",
      "entry.time": "Tid (minutter)",
      "entry.submit": "Gem min aktivitet",
      "entry.my": "Mine aktiviteter",
      "entry.date": "Dato",
      "entry.actions": "Handlinger",
      "entry.none": "Du har ingen aktiviteter endnu pÃ¥ denne konto.",

      "profile.runs": "Ture",
      "profile.totaldistance": "Samlet distance",
      "profile.totaltime": "Samlet tid",
      "profile.avgdistance": "Gennemsnitlig distance",
      "profile.avgpace": "Gennemsnitstempo",
      "profile.longest": "LÃ¦ngste aktivitet",
      "profile.best10k": "Hurtigste ~10 km",
      "profile.best5k": "Hurtigste ~5 km",

      "user.notLoggedIn": "Ikke logget ind",
      "user.loginButton": "Log ind",
      "user.loggedInAs": "Logget ind som {name}",
      "user.leagueLabel": "Liga: {league}",
      "user.addActivity": "TilfÃ¸j aktivitet",
      "user.deleteAccount": "Slet konto",

      "alert.loginMissing": "Indtast bÃ¥de navn og adgangskode.",
      "alert.firebase": "Firebase er ikke sat korrekt op. IndsÃ¦t din Firebase-konfiguration i scriptet.",
      "alert.mustLogin": "Log ind, fÃ¸r du tilfÃ¸jer aktiviteter.",
      "alert.activityInvalid": "Udfyld distance og tid korrekt med positive vÃ¦rdier.",
      "alert.noPlayers": "Ingen spillere endnu.",
      "alert.notEnoughPlayers": "Du skal bruge mindst 8 spillere til oprykning og nedrykning.",
      "alert.promotionsDone": "Oprykning og nedrykning udfÃ¸rt: {up} op, {down} ned.",
      "alert.noActivitiesToPlace": "Ingen aktiviteter endnu, intet at placere.",
      "alert.noPending": "Ingen afventende deltagere klar til placering.",
      "alert.placeSummary": "Placerede {placed} ny(e) deltager(e) i ligaer. {skipped}",
      "alert.placeSkipped": "{count} blev efterladt som Afventer (mangler data eller for balance).",
      "alert.deleteActivityConfirm": "Slet denne aktivitet?",
      "alert.deleteAccountConfirm": "Dette sletter din konto og alle dine aktiviteter. Er du sikker?",
      "alert.alreadyLoggedIn": "Du er allerede logget ind. Slet din konto, hvis du vil starte forfra.",
      "alert.passwordWrong": "Forkert adgangskode til dette navn."
    },

    cs: {
      "nav.welcome": "VÃ­tejte",
      "nav.leaderboard": "Å½ebÅ™Ã­Äek",
      "nav.stats": "Statistiky",
      "nav.rules": "Pravidla",
      "nav.about": "O projektu",
      "nav.entry": "Zapsat aktivitu",
      "nav.login": "PÅ™ihlÃ¡Å¡enÃ­",

      "welcome.title": "HÃ½bej se vÃ­c. SoutÄ›Å¾ spolu s ostatnÃ­mi.",
      "welcome.subtitle": "Make It Happen je jednoduchÃ¡ vÃ½zva od SEP. ChoÄ, bÄ›hej nebo jezdi na kole, zapisuj kilometry a stoupej ligami nahoru.",
      "welcome.cta": "PÅ™ihlÃ¡sit se nebo vytvoÅ™it ÃºÄet",

      "login.title": "PÅ™ihlÃ¡Å¡enÃ­ do Make It Happen",
      "login.description": "VytvoÅ™ si jednoduchÃ½ ÃºÄet, aby systÃ©m vÄ›dÄ›l, kdo jsi, a jen ty mohl/a spravovat svÃ© aktivity.",
      "login.name": "JmÃ©no",
      "login.password": "Heslo",
      "login.submit": "PÅ™ihlÃ¡sit / VytvoÅ™it ÃºÄet",
      "login.note": "TvÅ¯j ÃºÄet je uloÅ¾enÃ½ ve sdÃ­lenÃ© databÃ¡zi, ne jen v tomto zaÅ™Ã­zenÃ­. Pokud ho dlouho nepouÅ¾Ã­vÃ¡Å¡, mÅ¯Å¾e bÃ½t smazÃ¡n.",

      "league.amateurs": "AmatÃ©Å™i",
      "league.intermediates": "StÅ™ednÄ› pokroÄilÃ­",
      "league.pros": "ProfÃ­ci",
      "league.legends": "Legendy",
      "league.pending": "ÄŒekÃ¡ na zaÅ™azenÃ­",

      "leaderboard.title": "Å½ebÅ™Ã­Äek",
      "leaderboard.filter": "Filtrovat podle ligy:",
      "leaderboard.all": "VÅ¡echny ligy",
      "leaderboard.none": "ZatÃ­m Å¾Ã¡dnÃ© aktivity. BuÄ prvnÃ­, kdo nÄ›co zapÃ­Å¡e.",
      "lb.rank": "#",
      "lb.name": "JmÃ©no",
      "lb.league": "Liga",
      "lb.distance": "CelkovÃ¡ vzdÃ¡lenost (km)",
      "lb.time": "CelkovÃ½ Äas (min)",

      "pending.title": "ÄŒekajÃ­cÃ­ ÃºÄastnÃ­ci",
      "pending.subtitle": "NovÃ© registrace, kterÃ© budou automaticky rozdÄ›leny do lig.",
      "pending.rank": "#",
      "pending.name": "JmÃ©no",
      "pending.joinMonth": "MÄ›sÃ­c registrace",
      "pending.none": "MomentÃ¡lnÄ› Å¾Ã¡dnÃ­ ÄekajÃ­cÃ­ ÃºÄastnÃ­ci.",

      "stats.title": "Statistiky hrÃ¡ÄÅ¯ a pohyb mezi ligami",
      "stats.runs": "Aktivity",
      "stats.totaldistance": "CelkovÃ¡ vzdÃ¡lenost (km)",
      "stats.totaltime": "CelkovÃ½ Äas (min)",
      "stats.avgdistance": "PrÅ¯mÄ›rnÃ¡ vzdÃ¡lenost (km)",
      "stats.bestdistance": "NejdelÅ¡Ã­ aktivita (km)",
      "stats.improvement": "ZlepÅ¡enÃ­",
      "stats.none": "Statistiky se objevÃ­, jakmile lidÃ© zaÄnou zapisovat aktivity.",

      "rules.title": "Pravidla a ligy",
      "rules.joiningtitle": "Registrace a zaÄÃ¡tek",
      "rules.joiningtext":
        "Zaregistrovat se mÅ¯Å¾eÅ¡ kdykoliv. Po vytvoÅ™enÃ­ ÃºÄtu zaÄÃ­nÃ¡Å¡ ve stavu â€žÄŒekÃ¡ na zaÅ™azenÃ­â€œ. Aktivity mÅ¯Å¾eÅ¡ zapisovat hned. SystÃ©m tÄ› postupnÄ› zaÅ™adÃ­ do ligy podle vzdÃ¡lenosti, Äasu a rychlosti a zÃ¡roveÅˆ se snaÅ¾Ã­ udrÅ¾et velikost lig vyrovnanou.",
      "rules.leaguetitle": "Ligy a rovnovÃ¡ha",
      "rules.leaguetext":
        "ExistujÃ­ ÄtyÅ™i ligy: AmatÃ©Å™i, StÅ™ednÄ› pokroÄilÃ­, ProfÃ­ci a Legendy. SystÃ©m se snaÅ¾Ã­, aby Å¾Ã¡dnÃ¡ liga nebyla vÃ½raznÄ› vÄ›tÅ¡Ã­ neÅ¾ ostatnÃ­.",
      "rules.promotiontitle": "Postupy a sestupy",
      "rules.promotiontext":
        "KaÅ¾dÃ½ mÄ›sÃ­c systÃ©m automaticky provede postupy a sestupy. PoÄet pÅ™esunÅ¯ zÃ¡visÃ­ na poÄtu aktivnÃ­ch hrÃ¡ÄÅ¯: pÅ™i 8+ hrÃ¡ÄÃ­ch 1 postup a 1 sestup, pÅ™i 16+ dva, pÅ™i 32+ tÅ™i. PoÅ™adÃ­ se urÄuje podle celkovÃ© vzdÃ¡lenosti, pak podle celkovÃ©ho Äasu a nakonec podle prÅ¯mÄ›rnÃ© rychlosti.",

      "about.title": "O Make It Happen",
      "about.text1":
        "Make It Happen je jednoduchÃ¡, fÃ©rovÃ¡ zdravotnÃ­ vÃ½zva vytvoÅ™enÃ¡ pod SEP. CÃ­lem nenÃ­ z tebe udÄ›lat profesionÃ¡lnÃ­ho sportovce, ale dÃ¡t ti pÅ™ehlednÃ½ a pÅ™Ã¡telskÃ½ zpÅ¯sob, jak se vÃ­c hÃ½bat a vidÄ›t svÅ¯j pokrok.",
      "about.text2":
        "MÅ¯Å¾eÅ¡ chodit, bÄ›hat nebo jezdit na kole a zapisovat vzdÃ¡lenost a Äas. SystÃ©m hodnotÃ­ jak to, jak daleko jdeÅ¡, tak to, jak dlouho se hÃ½beÅ¡. DÃ­ky tomu se odmÄ›Åˆuje i vytrvalost, ne jen rychlost.",
      "about.text3":
        "NovÃ­ hrÃ¡Äi zaÄÃ­najÃ­ jako â€žÄŒekÃ¡ na zaÅ™azenÃ­â€œ a systÃ©m je postupnÄ› automaticky zaÅ™adÃ­ do lig tak, aby zÅ¯staly vyvÃ¡Å¾enÃ©.",

      "entry.title": "Zapsat novou aktivitu",
      "entry.distance": "VzdÃ¡lenost (km)",
      "entry.time": "ÄŒas (minuty)",
      "entry.submit": "UloÅ¾it aktivitu",
      "entry.my": "Moje aktivity",
      "entry.date": "Datum",
      "entry.actions": "Akce",
      "entry.none": "V tomto ÃºÄtu zatÃ­m nemÃ¡Å¡ Å¾Ã¡dnÃ© aktivity.",

      "profile.runs": "Aktivity",
      "profile.totaldistance": "CelkovÃ¡ vzdÃ¡lenost",
      "profile.totaltime": "CelkovÃ½ Äas",
      "profile.avgdistance": "PrÅ¯mÄ›rnÃ¡ vzdÃ¡lenost",
      "profile.avgpace": "PrÅ¯mÄ›rnÃ© tempo",
      "profile.longest": "NejdelÅ¡Ã­ aktivita",
      "profile.best10k": "NejrychlejÅ¡Ã­ ~10 km",
      "profile.best5k": "NejrychlejÅ¡Ã­ ~5 km",

      "user.notLoggedIn": "NepÅ™ihlÃ¡Å¡en",
      "user.loginButton": "PÅ™ihlÃ¡sit",
      "user.loggedInAs": "PÅ™ihlÃ¡Å¡en jako {name}",
      "user.leagueLabel": "Liga: {league}",
      "user.addActivity": "PÅ™idat aktivitu",
      "user.deleteAccount": "Smazat ÃºÄet",

      "alert.loginMissing": "Zadej prosÃ­m jmÃ©no i heslo.",
      "alert.firebase": "Firebase jeÅ¡tÄ› nenÃ­ sprÃ¡vnÄ› nastavenÃ©. PÅ™idej konfiguraci Firebase do skriptu.",
      "alert.mustLogin": "NejdÅ™Ã­v se pÅ™ihlas, neÅ¾ pÅ™idÃ¡Å¡ aktivitu.",
      "alert.activityInvalid": "VyplÅˆ vzdÃ¡lenost i Äas jako kladnÃ¡ ÄÃ­sla.",
      "alert.noPlayers": "ZatÃ­m Å¾Ã¡dnÃ­ hrÃ¡Äi.",
      "alert.notEnoughPlayers": "Na postupy a sestupy je potÅ™eba alespoÅˆ 8 hrÃ¡ÄÅ¯.",
      "alert.promotionsDone": "Postupy a sestupy provedeny: {up} nahoru, {down} dolÅ¯.",
      "alert.noActivitiesToPlace": "ZatÃ­m Å¾Ã¡dnÃ© aktivity, nenÃ­ co zaÅ™azovat.",
      "alert.noPending": "Å½Ã¡dnÃ­ ÄekajÃ­cÃ­ hrÃ¡Äi pÅ™ipravenÃ­ k zaÅ™azenÃ­.",
      "alert.placeSummary": "ZaÅ™azeno {placed} novÃ½ch hrÃ¡ÄÅ¯ do lig. {skipped}",
      "alert.placeSkipped": "{count} zÅ¯stalo ve stavu ÄŒekÃ¡ na zaÅ™azenÃ­ (mÃ¡lo dat nebo kvÅ¯li rovnovÃ¡ze).",
      "alert.deleteActivityConfirm": "Opravdu chceÅ¡ smazat tuto aktivitu?",
      "alert.deleteAccountConfirm": "TÃ­mto smaÅ¾eÅ¡ svÅ¯j ÃºÄet i vÅ¡echny aktivity. PokraÄovat?",
      "alert.alreadyLoggedIn": "UÅ¾ jsi pÅ™ihlÃ¡Å¡enÃ½/Ã¡. Pokud chceÅ¡ zaÄÃ­t znovu, smaÅ¾ ÃºÄet.",
      "alert.passwordWrong": "Å patnÃ© heslo pro toto jmÃ©no."
    }
  };

  function t(key, vars) {
    const dict = translations[currentLang] || translations.en;
    let str = dict[key] || translations.en[key] || key;
    if (vars) {
      Object.keys(vars).forEach(k => {
        str = str.replace(`{${k}}`, vars[k]);
      });
    }
    return str;
  }

  function applyTranslations() {
    document.querySelectorAll("[data-i18n]").forEach(el => {
      const key = el.getAttribute("data-i18n");
      el.textContent = t(key);
    });
    renderHeaderUser();
    renderLeaderboard();
    renderStats();
    renderMyActivities();
    renderPendingList();
  }

  function initLanguage() {
    const select = document.getElementById("lang-select");
    const saved = localStorage.getItem(LS_LANG_KEY) || "en";

    currentLang = saved;

    if (select) {
      select.value = saved;
      select.addEventListener("change", () => {
        currentLang = select.value;
        localStorage.setItem(LS_LANG_KEY, currentLang);
        applyTranslations();
      });
    }

    applyTranslations();
  }

  // ==========================
  //  BASIC HELPERS
  // ==========================

  function currentMonthKey(ts) {
    const d = ts ? new Date(ts) : new Date();
    const y = d.getFullYear();
    const m = d.getMonth() + 1;
    return `${y}-${String(m).padStart(2, "0")}`;
  }

  function formatDate(ts) {
    const d = new Date(ts);
    if (isNaN(d.getTime())) return "";
    return d.toLocaleDateString();
  }

  function formatMinutesPretty(minutes) {
    if (!isFinite(minutes) || minutes <= 0) return "0:00";
    const totalSeconds = Math.round(minutes * 60);
    const m = Math.floor(totalSeconds / 60);
    const s = totalSeconds % 60;
    return `${m}:${s.toString().padStart(2, "0")}`;
  }

  function formatImprovement(value) {
    if (!isFinite(value) || value === 0) return "0%";
    const rounded = Math.round(value);
    return (rounded > 0 ? "+" : "") + rounded + "%";
  }

  function leagueIndex(league) {
    return LEAGUES.indexOf(league);
  }

  function getLeagueCounts() {
    const counts = { amateurs: 0, intermediates: 0, pros: 0, legends: 0 };
    users.forEach(u => {
      if (counts[u.league] !== undefined) counts[u.league]++;
    });
    return counts;
  }

  function canMoveLeague(user, targetLeague) {
    if (!LEAGUES.includes(targetLeague)) return false;
    const counts = getLeagueCounts();
    const from = LEAGUES.includes(user.league) ? user.league : null;

    if (from && counts[from] !== undefined) {
      counts[from] = Math.max(0, counts[from] - 1);
    }
    counts[targetLeague] = (counts[targetLeague] || 0) + 1;

    const values = Object.values(counts);
    const max = Math.max(...values);
    const min = Math.min(...values);
    return max - min <= 2;
  }

  // ==========================
  //  NAVIGATION
  // ==========================

  function showScene(name) {
    const scenes = document.querySelectorAll(".scene");
    scenes.forEach(scene => {
      scene.classList.remove("active");
      scene.style.display = "none";
    });

    const el =
      document.getElementById("scene-" + name) ||
      document.getElementById(name);

    if (el) {
      el.classList.add("active");
      el.style.display = "block";
    }

    const navButtons = document.querySelectorAll("header nav button");
    navButtons.forEach(btn => btn.classList.remove("active"));
    navButtons.forEach(btn => {
      const onclick = btn.getAttribute("onclick") || "";
      if (onclick.includes("'" + name + "'")) {
        btn.classList.add("active");
      }
    });
  }

  function updateNavLoginVisibility() {
    const btn = document.getElementById("nav-login-btn");
    if (!btn) return;
    if (currentUser) {
      btn.style.display = "none";
    } else {
      btn.style.display = "inline-block";
    }
  }

  // ==========================
  //  FIREBASE INIT
  // ==========================

  function initFirebase() {
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
  } catch (e) {
      console.error("Firebase init error:", e);
      alert(t("alert.firebase"));
    }
  }

  // ==========================
  //  DATA LOADING
  // ==========================

  async function loadAllData() {
    if (!db) return;
    const [usersSnap, actsSnap] = await Promise.all([
      db.collection("users").get(),
      db.collection("activities").get()
    ]);

    users = usersSnap.docs.map(doc => {
      const data = doc.data();
      if (!data.league) data.league = "pending";
      if (!data.joinMonth) data.joinMonth = currentMonthKey(data.createdAt || Date.now());
      return { id: doc.id, ...data };
    });

    entries = actsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    renderLeaderboard();
    renderStats();
    renderMyActivities();
    renderPendingList();

    if (!autoRunning) {
      autoMonthlyUpdates();
    }
  }

  function restoreCurrentUser() {
    const storedId = localStorage.getItem(LS_CURRENT_USER_KEY);
    if (!storedId) {
      currentUser = null;
      renderHeaderUser();
      updateEntryFormLockState();
      updateNavLoginVisibility();
      return;
    }
    const found = users.find(u => u.id === storedId);
    if (found) {
      currentUser = found;
    } else {
      localStorage.removeItem(LS_CURRENT_USER_KEY);
      currentUser = null;
    }
    renderHeaderUser();
    updateEntryFormLockState();
    updateNavLoginVisibility();
  }

  // ==========================
  //  PLAYER STATS
  // ==========================

  function getPlayerStats() {
    const byUser = {};

    entries.forEach(e => {
      const user = users.find(u => u.id === e.userId);
      if (!user) return;
      const key = user.id;
      if (!byUser[key]) {
        byUser[key] = {
          userId: user.id,
          name: user.name,
          league: user.league || "pending",
          runs: 0,
          totalDistance: 0,
          totalTime: 0,
          bestDistance: 0,
          firstEntry: null
        };
      }
      const stats = byUser[key];

      if (!stats.firstEntry || e.timestamp < stats.firstEntry.timestamp) {
        stats.firstEntry = {
          distanceKm: e.distanceKm,
          timeMinutes: e.timeMinutes,
          timestamp: e.timestamp
        };
      }

      stats.runs++;
      stats.totalDistance += e.distanceKm;
      stats.totalTime += e.timeMinutes;
      if (e.distanceKm > stats.bestDistance) stats.bestDistance = e.distanceKm;
    });

    let players = Object.values(byUser);

    players.forEach(p => {
      p.avgDistance = p.runs > 0 ? p.totalDistance / p.runs : 0;
      p.speed = p.totalTime > 0 ? p.totalDistance / p.totalTime : 0;
      let improvement = 0;
      if (
        p.firstEntry &&
        p.firstEntry.distanceKm > 0 &&
        p.firstEntry.timeMinutes > 0 &&
        p.totalDistance > 0 &&
        p.totalTime > 0
      ) {
        const baselinePace = p.firstEntry.timeMinutes / p.firstEntry.distanceKm;
        const avgPace = p.totalTime / p.totalDistance;
        if (baselinePace > 0) {
          improvement = ((baselinePace - avgPace) / baselinePace) * 100;
        }
      }
      p.improvement = improvement;
    });

    players.sort((a, b) => {
      if (b.totalDistance !== a.totalDistance) {
        return b.totalDistance - a.totalDistance;
      }
      if (b.totalTime !== a.totalTime) {
        return b.totalTime - a.totalTime;
      }
      return b.speed - a.speed;
    });

    players = players.map((p, index) => ({ ...p, rank: index + 1 }));
    return players;
  }

  // ==========================
  //  MONTHLY: AUTO UPDATES (from 12th)
  // ==========================

  async function autoMonthlyUpdates() {
    if (!db) return;
    autoRunning = true;
    try {
      const today = new Date();
      const monthKey = currentMonthKey(today);
      const day = today.getDate();

      // Only run on or after the 12th of the month
      if (day < 12) {
        autoRunning = false;
        return;
      }

      const metaRef = db.collection("meta").doc("global_state");
      const snap = await metaRef.get();
      const data = snap.exists ? snap.data() : {};

      // If we already ran for this month, do nothing
      if (data.lastPromotionMonth === monthKey) {
        autoRunning = false;
        return;
      }

      // Run automatic placement + promotions
      await placeNewJoiners(true);
      await applyPromotions(true);

      // Mark month as updated
      await metaRef.set({ lastPromotionMonth: monthKey }, { merge: true });
    } catch (e) {
      console.error("Auto monthly updates error:", e);
    } finally {
      autoRunning = false;
    }
  }

  // ==========================
  //  MONTHLY: PLACE NEW JOINERS
  // ==========================

  async function placeNewJoiners(auto = false) {
    if (!db) return;

    const players = getPlayerStats();
    if (!players.length) {
      if (!auto) alert(t("alert.noActivitiesToPlace"));
      return;
    }

    const nowKey = currentMonthKey();
    const rankMap = {};
    players.forEach(p => { rankMap[p.userId] = p; });

    const candidates = users.filter(u =>
      u.league === "pending" &&
      u.joinMonth &&
      u.joinMonth < nowKey
    );

    if (!candidates.length) {
      if (!auto) alert(t("alert.noPending"));
      return;
    }

    const batch = db.batch();
    let placed = 0;
    let skipped = 0;

    function preferredLeaguesForTarget(target) {
      if (target === "legends") return ["legends", "pros"];
      if (target === "pros") return ["pros", "intermediates", "legends"];
      if (target === "intermediates") return ["intermediates", "amateurs", "pros"];
      if (target === "amateurs") return ["amateurs", "intermediates"];
      return ["amateurs"];
    }

    candidates.forEach(user => {
      const stats = rankMap[user.id];
      if (!stats || stats.runs < MIN_RUNS_FOR_PLACEMENT) {
        skipped++;
        return;
      }

      const N = players.length;
      const q = stats.rank / N;
      let targetLeague = "amateurs";
      if (q <= 0.25) targetLeague = "legends";
      else if (q <= 0.5) targetLeague = "pros";
      else if (q <= 0.75) targetLeague = "intermediates";
      else targetLeague = "amateurs";

      const prefs = preferredLeaguesForTarget(targetLeague);
      let finalLeague = null;

      for (const lg of prefs) {
        if (canMoveLeague(user, lg)) {
          finalLeague = lg;
          break;
        }
      }

      if (!finalLeague) {
        skipped++;
        return;
      }

      user.league = finalLeague;
      const userRef = db.collection("users").doc(user.id);
      batch.update(userRef, { league: finalLeague });
      placed++;
    });

    if (!placed) {
      if (!auto) {
        alert("No new joiners could be placed yet. They may need more activities or the leagues are already very balanced.");
      }
      return;
    }

    await batch.commit();
    await loadAllData();
    restoreCurrentUser();

    if (!auto) {
      let skippedText = "";
      if (skipped > 0) {
        skippedText = t("alert.placeSkipped", { count: skipped });
      }
      alert(t("alert.placeSummary", { placed, skipped: skippedText }));
    }
  }

  // ==========================
  //  MONTHLY: PROMOTIONS
  // ==========================

  async function applyPromotions(auto = false) {
    if (!db) return;

    const players = getPlayerStats();
    const total = players.length;
    if (total === 0) {
      if (!auto) alert(t("alert.noPlayers"));
      return;
    }

    let moves = 0;
    if (total >= 32) moves = 3;
    else if (total >= 16) moves = 2;
    else if (total >= 8) moves = 1;
    else moves = 0;

    if (moves === 0) {
      if (!auto) alert(t("alert.notEnoughPlayers"));
      return;
    }

    const batch = db.batch();

    let promoted = 0;
    for (let i = 0; i < players.length && promoted < moves; i++) {
      const p = players[i];
      if (!LEAGUES.includes(p.league)) continue;
      const idx = leagueIndex(p.league);
      if (idx < 0 || idx >= LEAGUES.length - 1) continue;
      const userRef = db.collection("users").doc(p.userId);
      batch.update(userRef, { league: LEAGUES[idx + 1] });
      promoted++;
    }

    let relegated = 0;
    for (let i = players.length - 1; i >= 0 && relegated < moves; i--) {
      const p = players[i];
      if (!LEAGUES.includes(p.league)) continue;
      const idx = leagueIndex(p.league);
      if (idx <= 0) continue;
      const userRef = db.collection("users").doc(p.userId);
      batch.update(userRef, { league: LEAGUES[idx - 1] });
      relegated++;
    }

    await batch.commit();
    await loadAllData();
    restoreCurrentUser();
    if (!auto) {
      alert(t("alert.promotionsDone", { up: moves, down: moves }));
    }
  }

  // ==========================
  //  PROFILE VIEW
  // ==========================

  function showProfile(userId) {
    const card = document.getElementById("profile-card");
    const title = document.getElementById("profile-title");
    const summary = document.getElementById("profile-summary");

    const runsCell = document.getElementById("profile-runs");
    const totalDistCell = document.getElementById("profile-total-distance");
    const totalTimeCell = document.getElementById("profile-total-time");
    const avgDistCell = document.getElementById("profile-avg-distance");
    const avgPaceCell = document.getElementById("profile-avg-pace");
    const longestCell = document.getElementById("profile-longest");
    const best10kCell = document.getElementById("profile-10k");
    const best5kCell = document.getElementById("profile-5k");

    const user = users.find(u => u.id === userId);
    if (!user) return;

    const myEntries = entries
      .filter(e => e.userId === userId)
      .slice()
      .sort((a, b) => a.timestamp - b.timestamp);

    if (!myEntries.length) {
      title.textContent = `Profile: ${user.name}`;
      summary.textContent = "No activities logged yet.";
      runsCell.textContent = "0";
      totalDistCell.textContent = "0 km";
      totalTimeCell.textContent = "0";
      avgDistCell.textContent = "â€“";
      avgPaceCell.textContent = "â€“";
      longestCell.textContent = "â€“";
      best10kCell.textContent = "â€“";
      best5kCell.textContent = "â€“";
      showScene("profile-card");
      return;
    }

    let runs = myEntries.length;
    let totalDistance = 0;
    let totalTime = 0;
    let longest = 0;
    let best10kMinutes = Infinity;
    let best5kMinutes = Infinity;

    myEntries.forEach(e => {
      totalDistance += e.distanceKm;
      totalTime += e.timeMinutes;
      if (e.distanceKm > longest) longest = e.distanceKm;

      if (e.distanceKm > 0 && e.timeMinutes > 0) {
        const paceMinutesPerKm = e.timeMinutes / e.distanceKm;

        if (e.distanceKm >= 9.5) {
          const tenKMinutes = paceMinutesPerKm * 10;
          if (tenKMinutes < best10kMinutes) best10kMinutes = tenKMinutes;
        }

        if (e.distanceKm >= 4.5) {
          const fiveKMinutes = paceMinutesPerKm * 5;
          if (fiveKMinutes < best5kMinutes) best5kMinutes = fiveKMinutes;
        }
      }
    });

    const avgDistance = totalDistance / runs;
    const avgPaceMinutesPerKm =
      totalDistance > 0 && totalTime > 0 ? totalTime / totalDistance : 0;

    function formatPace(minPerKm) {
      if (!isFinite(minPerKm) || minPerKm <= 0) return "â€“";
      const totalSeconds = Math.round(minPerKm * 60);
      const m = Math.floor(totalSeconds / 60);
      const s = totalSeconds % 60;
      return `${m}:${s.toString().padStart(2, "0")} min/km`;
    }

    title.textContent = `Profile: ${user.name}`;
    const leagueLabel = LEAGUES.includes(user.league)
      ? t("league." + user.league)
      : t("league.pending");

    summary.textContent = `${t("user.leagueLabel", { league: leagueLabel })}, ${t("stats.runs")}: ${runs}`;

    runsCell.textContent = runs.toString();
    totalDistCell.textContent = `${totalDistance.toFixed(2)} km`;
    totalTimeCell.textContent = formatMinutesPretty(totalTime);
    avgDistCell.textContent = `${avgDistance.toFixed(2)} km`;
    avgPaceCell.textContent = formatPace(avgPaceMinutesPerKm);
    longestCell.textContent = `${longest.toFixed(2)} km`;
    best10kCell.textContent =
      isFinite(best10kMinutes) && best10kMinutes > 0
        ? formatMinutesPretty(best10kMinutes)
        : "â€“";
    best5kCell.textContent =
      isFinite(best5kMinutes) && best5kMinutes > 0
        ? formatMinutesPretty(best5kMinutes)
        : "â€“";

    showScene("profile-card");
  }

  function attachProfileLinks() {
    document.querySelectorAll(".link-name").forEach(btn => {
      const userId = btn.getAttribute("data-user-id");
      btn.onclick = () => showProfile(userId);
    });
  }

  // ==========================
  //  RENDER FUNCTIONS
  // ==========================

  function renderHeaderUser() {
    const container = document.getElementById("user-controls");
    if (!container) return;
    container.innerHTML = "";

    if (!currentUser) {
      const span = document.createElement("span");
      span.textContent = t("user.notLoggedIn");
      container.appendChild(span);

      const btn = document.createElement("button");
      btn.className = "btn btn-small";
      btn.textContent = t("user.loginButton");
      btn.onclick = () => showScene("login");
      container.appendChild(btn);

      updateNavLoginVisibility();
      return;
    }

    const name = currentUser.name;
    const leagueKey = LEAGUES.includes(currentUser.league)
      ? "league." + currentUser.league
      : "league.pending";
    const leagueLabel = t(leagueKey);

    const info = document.createElement("span");
    info.textContent = `${t("user.loggedInAs", { name })} Â· ${t("user.leagueLabel", { league: leagueLabel })}`;
    container.appendChild(info);

    const addBtn = document.createElement("button");
    addBtn.className = "btn btn-small";
    addBtn.style.marginLeft = "8px";
    addBtn.textContent = t("user.addActivity");
    addBtn.onclick = () => showScene("entry");
    container.appendChild(addBtn);

    const deleteBtn = document.createElement("button");
    deleteBtn.className = "btn btn-small danger";
    deleteBtn.style.marginLeft = "4px";
    deleteBtn.textContent = t("user.deleteAccount");
    deleteBtn.onclick = deleteAccount;
    container.appendChild(deleteBtn);

    updateNavLoginVisibility();
  }

  function renderLeaderboard() {
    const tbody = document.getElementById("leaderboard-body");
    const empty = document.getElementById("no-entries");
    if (!tbody) return;
    tbody.innerHTML = "";

    const players = getPlayerStats();
    const filterSel = document.getElementById("league-filter");
    const filter = filterSel ? filterSel.value : "all";

    let filtered = players;
    if (filter !== "all") {
      filtered = players.filter(p => p.league === filter);
    }

    if (!filtered.length) {
      if (empty) empty.style.display = "block";
      return;
    }
    if (empty) empty.style.display = "none";

    filtered.forEach(player => {
      const tr = document.createElement("tr");

      let rankSymbol = player.rank;
      if (player.rank === 1) rankSymbol = "ðŸ¥‡";
      else if (player.rank === 2) rankSymbol = "ðŸ¥ˆ";
      else if (player.rank === 3) rankSymbol = "ðŸ¥‰";

      const leagueClass = LEAGUES.includes(player.league)
        ? player.league
        : "pending";
      const leagueLabel = LEAGUES.includes(player.league)
        ? t("league." + player.league)
        : t("league.pending");

      tr.innerHTML = `
        <td>${rankSymbol}</td>
        <td>
          <button type="button" class="link-name" data-user-id="${player.userId}" style="background:none;border:none;color:#3b82f6;cursor:pointer;text-decoration:underline;">
            ${player.name}
          </button>
        </td>
        <td><span class="badge-league ${leagueClass}">${leagueLabel}</span></td>
        <td>${player.totalDistance.toFixed(2)}</td>
        <td>${player.totalTime.toFixed(1)}</td>
      `;
      tbody.appendChild(tr);
    });

    attachProfileLinks();
  }

  function renderStats() {
    const tbody = document.getElementById("stats-body");
    const empty = document.getElementById("no-stats");
    if (!tbody) return;
    tbody.innerHTML = "";

    if (!entries.length) {
      if (empty) empty.style.display = "block";
      return;
    }
    if (empty) empty.style.display = "none";

    const players = getPlayerStats();

    players.forEach(stats => {
      const leagueClass = LEAGUES.includes(stats.league)
        ? stats.league
        : "pending";
      const leagueLabel = LEAGUES.includes(stats.league)
        ? t("league." + stats.league)
        : t("league.pending");

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <button type="button" class="link-name" data-user-id="${stats.userId}" style="background:none;border:none;color:#3b82f6;cursor:pointer;text-decoration:underline;">
            ${stats.name}
          </button>
        </td>
        <td><span class="badge-league ${leagueClass}">${leagueLabel}</span></td>
        <td>${stats.runs}</td>
        <td>${stats.totalDistance.toFixed(2)}</td>
        <td>${stats.totalTime.toFixed(1)}</td>
        <td>${stats.avgDistance.toFixed(2)}</td>
        <td>${stats.bestDistance.toFixed(2)}</td>
        <td>${formatImprovement(stats.improvement)}</td>
      `;
      tbody.appendChild(tr);
    });

    attachProfileLinks();
  }

  function renderPendingList() {
    const tbody = document.getElementById("pending-body");
    const empty = document.getElementById("no-pending");
    if (!tbody) return;
    tbody.innerHTML = "";

    const pending = users
      .filter(u => u.league === "pending")
      .slice()
      .sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));

    if (!pending.length) {
      if (empty) empty.style.display = "block";
      return;
    }
    if (empty) empty.style.display = "none";

    pending.forEach((u, index) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${index + 1}</td>
        <td>${u.name}</td>
        <td>${u.joinMonth || ""}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderMyActivities() {
    const tbody = document.getElementById("my-activities-body");
    const empty = document.getElementById("no-my-activities");
    if (!tbody) return;
    tbody.innerHTML = "";

    if (!currentUser) {
      if (empty) {
        empty.style.display = "block";
        empty.textContent = t("user.notLoggedIn");
      }
      return;
    }

    const myEntries = entries.filter(e => e.userId === currentUser.id);

    if (!myEntries.length) {
      if (empty) {
        empty.style.display = "block";
        empty.textContent = t("entry.none");
      }
      return;
    }
    if (empty) empty.style.display = "none";

    myEntries
      .slice()
      .sort((a, b) => b.timestamp - a.timestamp)
      .forEach(e => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${formatDate(e.timestamp)}</td>
          <td>${e.distanceKm.toFixed(2)}</td>
          <td>${e.timeMinutes.toFixed(1)}</td>
          <td>
            <button class="btn btn-small danger" style="padding:4px 8px;font-size:12px;" onclick="deleteActivity('${e.id}')">
              âœ•
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
  }

  function updateEntryFormLockState() {
    const distanceInput = document.getElementById("distance");
    const timeInput = document.getElementById("time");
    const form = document.getElementById("entry-form");
    if (!form) return;
    const submit = form.querySelector("button[type='submit']");
    const locked = !currentUser;

    if (distanceInput) distanceInput.disabled = locked;
    if (timeInput) timeInput.disabled = locked;
    if (submit) submit.disabled = locked;
  }

  // ==========================
  //  ACTIVITY DELETION
  // ==========================

  async function deleteActivity(id) {
    if (!currentUser) {
      alert(t("alert.mustLogin"));
      return;
    }
    const entry = entries.find(e => e.id === id);
    if (!entry) return;
    if (entry.userId !== currentUser.id) {
      alert("You can only delete your own activities.");
      return;
    }
    if (!confirm(t("alert.deleteActivityConfirm"))) return;

    await db.collection("activities").doc(id).delete();
    await loadAllData();
    restoreCurrentUser();
  }

  // ==========================
  //  AUTH
  // ==========================

  async function login(name, password) {
    if (!db) {
      alert(t("alert.firebase"));
      return;
    }
    if (currentUser) {
      alert(t("alert.alreadyLoggedIn"));
      return;
    }

    const trimmedName = (name || "").trim();
    if (!trimmedName || !password) {
      alert(t("alert.loginMissing"));
      return;
    }

    const existingSnap = await db
      .collection("users")
      .where("name", "==", trimmedName)
      .limit(1)
      .get();

    let userDoc = null;
    if (existingSnap.empty) {
      const joinMonth = currentMonthKey();
      const newUser = {
        name: trimmedName,
        password,
        league: "pending",
        createdAt: Date.now(),
        joinMonth
      };
      const docRef = await db.collection("users").add(newUser);
      userDoc = { id: docRef.id, ...newUser };
    } else {
      const doc = existingSnap.docs[0];
      const data = doc.data();
      if (data.password !== password) {
        alert(t("alert.passwordWrong"));
        return;
      }
      if (!data.league) data.league = "pending";
      if (!data.joinMonth) data.joinMonth = currentMonthKey(data.createdAt || Date.now());
      userDoc = { id: doc.id, ...data };
    }

    currentUser = userDoc;
    localStorage.setItem(LS_CURRENT_USER_KEY, currentUser.id);
    localStorage.setItem(LS_PASSWORD_KEY, password);

    await loadAllData();
    restoreCurrentUser();
    updateEntryFormLockState();
    showScene("leaderboard");
  }

  async function deleteAccount() {
    if (!currentUser) return;
    if (!confirm(t("alert.deleteAccountConfirm"))) return;

    const userId = currentUser.id;

    const actsSnap = await db
      .collection("activities")
      .where("userId", "==", userId)
      .get();
    const batch = db.batch();
    actsSnap.forEach(doc => batch.delete(doc.ref));
    batch.delete(db.collection("users").doc(userId));
    await batch.commit();

    currentUser = null;
    localStorage.removeItem(LS_CURRENT_USER_KEY);
    localStorage.removeItem(LS_PASSWORD_KEY);

    await loadAllData();
    renderHeaderUser();
    updateEntryFormLockState();
    renderMyActivities();
    showScene("welcome");
  }

  // ==========================
  //  VIEW SAVED PASSWORD BUTTON
  // ==========================

  function setupViewCodeButton() {
    const btn = document.getElementById("view-code-btn");
    const display = document.getElementById("saved-code-display");
    if (!btn || !display) return;
    btn.addEventListener("click", () => {
      const saved = localStorage.getItem(LS_PASSWORD_KEY);
      if (saved) {
        display.textContent = "Saved login password on this device: " + saved;
      } else {
        display.textContent = "No login password has been saved on this device yet.";
      }
      display.style.display = "block";
    });
  }

  // ==========================
  //  FORMS
  // ==========================

  function setupForms() {
    const loginForm = document.getElementById("login-form");
    if (loginForm) {
      loginForm.addEventListener("submit", function (e) {
        e.preventDefault();
        const name = document.getElementById("login-name").value;
        const password = document.getElementById("login-password").value;
        login(name, password);
      });
    }

    const entryForm = document.getElementById("entry-form");
    if (entryForm) {
      entryForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        if (!currentUser) {
          alert(t("alert.mustLogin"));
          showScene("login");
          return;
        }

        const distance = parseFloat(document.getElementById("distance").value);
        const time = parseFloat(document.getElementById("time").value);

        if (isNaN(distance) || isNaN(time) || distance <= 0 || time <= 0) {
          alert(t("alert.activityInvalid"));
          return;
        }

        await db.collection("activities").add({
          userId: currentUser.id,
          distanceKm: distance,
          timeMinutes: time,
          timestamp: Date.now()
        });

        await loadAllData();
        restoreCurrentUser();
        entryForm.reset();
        showScene("leaderboard");
      });
    }

    const leagueFilter = document.getElementById("league-filter");
    if (leagueFilter) {
      leagueFilter.addEventListener("change", renderLeaderboard);
    }
  }

  // ==========================
  //  INIT
  // ==========================

  async function init() {
    initLanguage();
    initFirebase();
    setupForms();
    setupViewCodeButton();

    if (!db) return;

    await loadAllData();
    restoreCurrentUser();
    updateEntryFormLockState();
    updateNavLoginVisibility();

    if (currentUser) {
      showScene("leaderboard");
    } else {
      showScene("welcome");
    }
  }

  document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
