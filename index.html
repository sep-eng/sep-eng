<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SEP</title>
  <meta name="description" content="SEP clothing and Make It Happen health challenge." />
  <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/3/3f/Black_square.jpg">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind + GSAP (SEP) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>

  <!-- Firebase (MIH) - compat build -->
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-auth-compat.js"></script>

  <style>
    body{
      margin:0;
      font-family:'Inter',sans-serif;
      background:linear-gradient(to bottom,#000,#fff);
      color:#111;
      scroll-behavior:smooth;
    }

    /* Make .hidden work instantly (before Tailwind loads) */
    .hidden { display: none !important; }

    button,a{transition:all .25s ease;}
    button:hover,a:hover{transform:translateY(-2px);}

    .popup{
      position:fixed;top:20px;right:20px;
      background:#16a34a;color:#fff;padding:10px 16px;border-radius:8px;
      opacity:0;transition:opacity .3s;z-index:1000;
      pointer-events:none;
    }
    .popup.show{opacity:1;}

    .fade-section{opacity:0;transform:translateY(30px);}

    #cartSidebar{color:#000;}

    /* Utility: prevent invisible layers stealing clicks */
    .pointer-none{pointer-events:none !important;}
    .pointer-auto{pointer-events:auto !important;}

    /* Burger menu styles (SEP) */
    #menuToggle {
      position:fixed;
      top:16px;
      right:16px;
      z-index:60;
      background:rgba(0,0,0,.6);
      color:#fff;
      border-radius:9999px;
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .menu-line {
      width:20px;
      height:2px;
      background:#fff;
      margin:2px 0;
    }
    #menuPanel {
      transition:transform .3s ease;
    }

    /* Global welcome screen */
    #welcome-screen{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:2rem;
      background:radial-gradient(circle at top,#222,#000);
      color:#fff;
    }
    #welcome-screen h1{
      font-size:2.5rem;
      margin-bottom:1rem;
      color:#f5f5f5;
    }
    #welcome-screen p{
      max-width:560px;
      color:#e6e6e6;
      margin-bottom:2rem;
      line-height:1.5;
    }
    #welcome-screen .welcome-btn{
      background:#fff;
      color:#000;
      border:none;
      padding:0.9rem 1.8rem;
      border-radius:9999px;
      font-weight:600;
      cursor:pointer;
      margin:0.25rem;
    }
    #welcome-screen .welcome-secondary{
      background:transparent;
      border:1px solid #fff;
      color:#fff;
    }
    #welcome-lang-row{
      margin-top:18px;
      display:flex;
      gap:8px;
      justify-content:center;
      flex-wrap:wrap;
    }
    #welcome-lang-row button{
      background:transparent;
      border:1px solid rgba(255,255,255,.35);
      color:#fff;
      padding:6px 10px;
      border-radius:9999px;
      font-size:12px;
      cursor:pointer;
    }
    #welcome-lang-row button.active{
      background:#fff;
      color:#000;
      border-color:#fff;
    }

    /* MAKE IT HAPPEN styles (scoped) */
    #mih-app{
      background:#000;
      color:#f7f7f7;
      min-height:100vh;
    }
    #mih-app header{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:12px 16px;
      background:#111111;
      border-bottom:1px solid #333333;
      position:sticky;
      top:0;
      z-index:10;
      align-items:center;
    }
    #mih-app .scene{
      display:none;
      max-width:900px;
      margin:auto;
      padding:20px;
    }
    #mih-app .scene.active{display:block;}
    #mih-app h1,#mih-app h2{color:#f5f5f5;}
    #mih-app .btn{
      background:#ffffff;
      color:#000000;
      border:none;
      padding:10px 16px;
      border-radius:6px;
      cursor:pointer;
      font-weight:600;
      margin:8px 0;
    }
    #mih-app .btn-small{padding:6px 10px;font-size:14px;}
    #mih-app .danger{background:#ef4444;color:#ffffff;}
    #mih-app .input{
      width:100%;
      padding:10px;
      margin:6px 0 14px;
      border:1px solid #555;
      border-radius:6px;
      font-size:16px;
      background:#111;
      color:#f7f7f7;
    }
    #mih-app table{
      width:100%;
      border-collapse:collapse;
      margin-top:14px;
      background:#111111;
    }
    #mih-app th,#mih-app td{
      padding:8px;
      border-bottom:1px solid #333;
      text-align:left;
      color:#f7f7f7;
      vertical-align:top;
    }
    #mih-app .muted{opacity:.8;}
    #mih-app .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid #333;
      border-radius:9999px;
      font-size:14px;
      background:#0b0b0b;
      flex-wrap:wrap;
    }

    /* MIH burger */
    #mihMenuToggle{
      position:relative;
      z-index:60;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.18);
      color:#fff;
      border-radius:9999px;
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    #mihMenuPanel{
      position:fixed;
      top:0; right:0;
      height:100%;
      width:280px;
      background:rgba(0,0,0,.92);
      border-left:1px solid rgba(255,255,255,.12);
      transform:translateX(100%);
      transition:transform .3s ease;
      z-index:70;
      display:flex;
      flex-direction:column;
      color:#fff;
    }
    #mihMenuPanel.open{ transform:translateX(0); }
    #mihMenuOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.5);
      z-index:65;
      display:none;
    }
    #mihMenuOverlay.open{ display:block; }
    #mihMenuPanel .mihMenuTop{
      padding:16px;
      border-bottom:1px solid rgba(255,255,255,.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    #mihMenuPanel .mihMenuBody{
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:auto;
    }
    .mih-menu-btn{
      width:100%;
      text-align:left;
      padding:10px 12px;
      border-radius:10px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:#fff;
      cursor:pointer;
      font-size:14px;
    }
    .mih-menu-btn:hover{ background:rgba(255,255,255,.10); transform:none; }
    .mih-menu-mini{
      font-size:12px;
      opacity:.85;
      margin-top:4px;
    }
    .mih-menu-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .mih-lang-btn{
      background:transparent;
      border:1px solid rgba(255,255,255,.25);
      color:#fff;
      padding:6px 10px;
      border-radius:9999px;
      font-size:12px;
      cursor:pointer;
    }
    .mih-lang-btn.active{ background:#fff; color:#000; border-color:#fff; }

    /* Profile drawer */
    #mihProfilePanel{
      border:1px solid #333;
      border-radius:12px;
      padding:14px;
      background:#0b0b0b;
      margin-top:14px;
      display:none;
    }
    #mihProfilePanel.show{ display:block; }
    #mihProfilePanel .row{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:6px 0;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    #mihProfilePanel .row:last-child{ border-bottom:none; }
  </style>

  <script>
    // GSAP fade-in for SEP sections
    window.addEventListener('load',()=>{
      if (window.gsap && window.ScrollTrigger) {
        gsap.registerPlugin(ScrollTrigger);
        gsap.utils.toArray('.fade-section').forEach(sec=>{
          gsap.to(sec,{
            opacity:1,y:0,duration:1,
            scrollTrigger:{trigger:sec,start:'top 80%',once:true}
          });
        });
      }
    });
  </script>
</head>

<body>

<div id="toast" class="popup"></div>

<!-- GLOBAL WELCOME SCREEN -->
<section id="welcome-screen">
  <h1 id="welcomeTitle">SEP</h1>
  <p id="welcomeSubtitle">Your Choice. Either shop (SEP shop), or move (Make It Happen). That simple.</p>
  <div>
    <button class="welcome-btn" id="welcomeSepBtn" type="button">SEP shop</button>
    <button class="welcome-btn welcome-secondary" id="welcomeMihBtn" type="button">Make It Happen</button>
  </div>
  <div id="welcome-lang-row">
    <button type="button" class="welcome-lang-btn" data-lang="en">English</button>
    <button type="button" class="welcome-lang-btn" data-lang="da">Dansk</button>
    <button type="button" class="welcome-lang-btn" data-lang="cs">Čeština</button>
  </div>
</section>

<!-- =========================================================
     SEP APP
========================================================= -->
<div id="sep-app" class="hidden">

  <!-- Burger menu button -->
  <button id="menuToggle" aria-label="Open menu" type="button">
    <div class="flex flex-col">
      <span class="menu-line"></span>
      <span class="menu-line"></span>
      <span class="menu-line"></span>
    </div>
  </button>

  <!-- Burger menu panel -->
  <div id="menuPanel" class="fixed top-0 right-0 h-full w-64 bg-black/90 text-white transform translate-x-full z-40 flex flex-col">
    <div class="p-5 border-b border-white/10 flex justify-between items-center">
      <span id="menuTitle" class="text-sm tracking-wide">SEP Menu</span>
      <button id="menuClose" type="button" class="px-3 py-1 rounded-full bg-white/10 border border-white/20 text-xs">✕</button>
    </div>
    <div class="p-5 space-y-4 text-sm">
      <div>
        <p id="sepLangLabel" class="mb-2 font-semibold text-xs tracking-wide uppercase text-white/70">Language</p>
        <div class="flex flex-wrap gap-2">
          <button data-lang="en" class="lang-btn px-3 py-1 rounded-full border border-white/30 text-xs" type="button">English</button>
          <button data-lang="da" class="lang-btn px-3 py-1 rounded-full border border-white/30 text-xs" type="button">Dansk</button>
          <button data-lang="cs" class="lang-btn px-3 py-1 rounded-full border border-white/30 text-xs" type="button">Čeština</button>
        </div>
      </div>
      <div class="pt-4 border-t border-white/10">
        <p id="sepInfoLabel" class="mb-2 font-semibold text-xs tracking-wide uppercase text-white/70">Info</p>
        <button id="menuAboutBtn" class="w-full text-left px-3 py-2 rounded-lg bg-white/5 hover:bg-white/10 text-sm" type="button">
          About "SEP"
        </button>
      </div>
      <div class="pt-4 border-t border-white/10">
        <p id="sepExitLabel" class="mb-2 font-semibold text-xs tracking-wide uppercase text-white/70">Exit</p>
        <button id="sepExitBtn" class="w-full text-left px-3 py-2 rounded-lg bg-white/5 hover:bg-white/10 text-sm" type="button">
          Back to main menu
        </button>
      </div>
    </div>
  </div>
  <div id="menuOverlay" class="fixed inset-0 bg-black/40 hidden pointer-none z-30"></div>

  <!-- MAIN SCENE (shop) -->
  <div id="sep-scene-main">
    <header class="py-20 text-center fade-section">
      <h1 id="heroTitle" class="theme-text text-5xl font-bold mb-4 text-white">Clothes chosen for you.</h1>
      <p id="heroSubtitle" class="theme-text text-lg mb-8 text-white">Clothes worthy of just wearing.</p>
      <div class="flex justify-center gap-4">
        <a id="btnShopNow" href="#products" class="bg-white text-black px-6 py-3 rounded-full font-medium">Shop Now</a>
        <button id="viewCartBtn" class="border border-white text-white px-6 py-3 rounded-full font-medium relative" type="button">
          <span id="btnViewCart">View Cart</span>
          <span id="cartCounter" class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-content:center text-xs hidden">0</span>
        </button>
      </div>
    </header>

    <section id="products" class="py-20 px-6 fade-section">
      <div class="text-center mb-12">
        <h2 id="productsTitle" class="theme-text text-4xl font-bold mb-4 text-white">Two products. Three choices.</h2>
        <p id="productsSubtitle" class="theme-text text-white">Our soft collection:</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-6xl mx-auto">
        <div class="product-card bg-white/10 p-6 rounded-xl shadow-md text-center backdrop-blur">
          <img src="https://picsum.photos/1024/1024?random=11" class="w-full h-64 object-cover rounded mb-4" alt="White T-shirt">
          <h3 id="product1Name" class="text-xl font-bold mb-2 text-white">SEP White T-shirt</h3>
          <p class="mb-2 text-white" data-price="180">180 DKK</p>
          <select class="theme-text border rounded px-3 py-2 mb-2 bg-transparent text-white size-selector">
            <option>XS</option><option>S</option><option>M</option><option>L</option><option>XL</option>
          </select>
          <div class="flex justify-center gap-2">
            <input type="number" min="1" value="1" class="theme-text border rounded w-16 text-center bg-transparent quantity-selector text-white">
            <button class="add-to-cart bg-white text-black px-4 py-2 rounded" data-name="SEP White T-shirt" data-price="180" type="button" data-i18n-btn="addToCart">Add</button>
          </div>
        </div>

        <div class="product-card bg-white/10 p-6 rounded-xl shadow-md text-center backdrop-blur">
          <img src="https://picsum.photos/1024/1024?random=22" class="w-full h-64 object-cover rounded mb-4" alt="Sweater">
          <h3 id="product2Name" class="text-xl font-bold mb-2 text-white">SEP Sweater</h3>
          <p class="mb-2 text-white" data-price="180">180 DKK</p>
          <select class="theme-text border rounded px-3 py-2 mb-2 bg-transparent text-white size-selector">
            <option>XS</option><option>S</option><option>M</option><option>L</option><option>XL</option>
          </select>
          <div class="flex justify-center gap-2">
            <input type="number" min="1" value="1" class="theme-text border rounded w-16 text-center bg-transparent quantity-selector text-white">
            <button class="add-to-cart bg-white text-black px-4 py-2 rounded" data-name="SEP Sweater" data-price="180" type="button" data-i18n-btn="addToCart">Add</button>
          </div>
        </div>
      </div>
    </section>

    <section class="py-20 text-center fade-section">
      <h2 id="howToOrderTitle" class="text-3xl font-bold mb-10 text-black">How to Order</h2>
      <div class="grid grid-cols-1 md:grid-cols-5 gap-6 max-w-6xl mx-auto text-sm md:text-base">
        <div class="bg-white/10 rounded-xl p-6 backdrop-blur text-black">
          <h3 id="step1Title" class="font-bold text-lg mb-2">1. Choose</h3>
          <p id="howStep1">Select your favourite SEP piece - T-shirt or Sweater - then pick your size and quantity.</p>
        </div>
        <div class="bg-white/10 rounded-xl p-6 backdrop-blur text-black">
          <h3 id="step2Title" class="font-bold text-lg mb-2">2. Add to Cart</h3>
          <p id="howStep2">Click “Add” to add your chosen items to your cart. When ready, click “View Cart” to review your order.</p>
        </div>
        <div class="bg-white/10 rounded-xl p-6 backdrop-blur text-black">
          <h3 id="step3Title" class="font-bold text-lg mb-2">3. Copy Order Message</h3>
          <p id="howStep3">Inside your cart, press “Copy Order Message”. This copies your full order, including shipping, automatically.</p>
        </div>
        <div class="bg-white/10 rounded-xl p-6 backdrop-blur text-black">
          <h3 id="step4Title" class="font-bold text-lg mb-2">4. Pay with MobilePay</h3>
          <p id="howStep4">Send the total amount (incl. +45 DKK shipping, free in Copenhagen.) to <b>5894BZ</b> using MobilePay.<br><span class="text-xs italic">“Open MobilePay” works only on mobile devices.</span></p>
        </div>
        <div class="bg-white/10 rounded-xl p-6 backdrop-blur text-black">
          <h3 id="step5Title" class="font-bold text-lg mb-2">5. Send us your order</h3>
          <p id="howStep5">DM your copied message to <b>@seproairesis</b> (Instagram) or <b>@seproairesis</b> (TikTok).<br>We currently deliver only within Denmark.</p>
        </div>
      </div>
    </section>

    <footer class="text-center py-10 fade-section text-black">
      <p id="footerText">
        © 2025 SEP - Se Proairesis • MobilePay 5894BZ • +45 DKK Shipping • Made in Copenhagen. Only delivered across Denmark.
      </p>
      <div class="flex justify-center gap-4 mt-4">
        <a href="https://instagram.com/seproairesis" class="bg-gradient-to-br from-pink-500 to-purple-600 text-white p-3 rounded-full" target="_blank" rel="noreferrer">IG</a>
        <a href="https://tiktok.com/@seproairesis" class="bg-black text-white p-3 rounded-full" target="_blank" rel="noreferrer">TT</a>
      </div>
    </footer>
  </div>

  <!-- ABOUT SCENE -->
  <section id="sep-scene-about" class="py-20 px-6 hidden">
    <div class="max-w-3xl mx-auto text-center text-white">
      <h2 id="aboutTitle" class="theme-text text-3xl font-bold mb-4">About SEP</h2>
      <p id="aboutBody1" class="theme-text mb-4">
        SEP stands for Se Proairesis - your choice in ancient greek. Each piece is pressed by hand in Copenhagen in small batches.
      </p>
      <p id="aboutBody2" class="theme-text mb-4">
        We make batches with small choice but good quality - rather focusing on quality than choice. That doesn't mean we wont do big batches though. We can't buy thousands of peices yet (we are still a small brand staring up)
      </p>
      <p id="aboutBody3" class="theme-text mb-8">
        One t-shirt, one sweater; all built to be the first thing you reach for when you open your wardrobe. I'm still a 13-year-old which means I cant have apple pay yet. So there's only mobile pay so far.
      </p>
      <button id="aboutBackBtn" class="mt-4 px-6 py-3 rounded-full border border-white/40 bg-white/10 hover:bg-white/20" type="button">
        Back to shop
      </button>
      <div class="mt-6">
        <button id="sepExitBtn2" class="px-5 py-2 rounded-full border border-white/30 bg-transparent hover:bg-white/10 text-sm" type="button">
          Exit to main menu
        </button>
      </div>
    </div>
  </section>

  <!-- CART -->
  <div id="cartSidebar" class="fixed top-0 right-0 h-full w-80 bg-white shadow-xl translate-x-full transition-transform duration-300 z-50 overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 id="cartTitle" class="text-xl font-bold">Your Cart</h3>
      </div>
      <div id="cartItems" class="space-y-4 text-sm"></div>
      <div class="border-t border-gray-300 pt-4 mt-4">
        <div class="flex justify-between mb-1">
          <span id="cartSubtotalLabel">Subtotal:</span><span id="cartSubtotal" class="font-bold">0 DKK</span>
        </div>
        <div class="flex justify-between mb-2 text-sm text-gray-600">
          <span id="cartShippingLabel">Shipping:</span><span id="cartShippingValue">+45 DKK</span>
        </div>
        <div class="flex justify-between font-semibold border-t border-gray-300 pt-2 mb-3">
          <span id="cartTotalLabel">Total:</span><span id="cartTotal">45 DKK</span>
        </div>
        <button id="openMobilePay" class="w-full bg-green-500 text-white py-2 rounded mb-2" type="button">
          <span id="cartMobilePayButton">Open MobilePay</span>
        </button>
        <p id="cartMobilePayNote" class="text-xs text-gray-500 mb-2 text-center">
          *Open MobilePay button is only valid on mobile*
        </p>
        <button id="copyMobilePay" class="w-full bg-gray-200 py-2 rounded" type="button">
          <span id="cartCopyOrder">Copy Order Message</span>
        </button>
      </div>
    </div>
  </div>
  <div id="cartOverlay" class="fixed inset-0 bg-black/50 hidden pointer-none z-40"></div>
</div>

<!-- =========================================================
     MAKE IT HAPPEN APP
========================================================= -->
<div id="mih-app" class="hidden">

  <header>
    <div class="chip">
      <span id="mihTitle" style="font-weight:700; letter-spacing:.08em;">MAKE IT HAPPEN</span>
      <span id="mihLeaguePill" class="muted">The League of Choice</span>
      <span id="mih-user-pill" class="muted">Not logged in</span>
    </div>

    <button id="mihMenuToggle" type="button" aria-label="Open menu">
      <div class="flex flex-col">
        <span class="menu-line"></span>
        <span class="menu-line"></span>
        <span class="menu-line"></span>
      </div>
    </button>
  </header>

  <div id="mihMenuOverlay"></div>
  <aside id="mihMenuPanel" aria-label="MIH menu">
    <div class="mihMenuTop">
      <div>
        <div id="mihMenuTitle" style="font-weight:700;letter-spacing:.08em;">MENU</div>
        <div id="mihMenuUserMini" class="mih-menu-mini">Not logged in</div>
      </div>
      <button id="mihMenuClose" type="button" class="mih-menu-btn" style="width:auto;padding:8px 10px;border-radius:9999px;">✕</button>
    </div>

    <div class="mihMenuBody">
      <button class="mih-menu-btn" type="button" data-mih-scene="mih-login" id="mihMenuLoginBtn">Login</button>
      <button class="mih-menu-btn" type="button" data-mih-scene="mih-home" id="mihMenuHomeBtn">Home</button>
      <button class="mih-menu-btn" type="button" data-mih-scene="mih-leaderboard" id="mihMenuLeaderboardBtn">Leaderboard</button>
      <button class="mih-menu-btn" type="button" data-mih-scene="mih-profiles" id="mihMenuProfilesBtn">Profiles</button>
      <button class="mih-menu-btn" type="button" data-mih-scene="mih-stats" id="mihMenuStatsBtn">Stats</button>
      <button class="mih-menu-btn" type="button" data-mih-scene="mih-about" id="mihMenuAboutBtn">About</button>

      <div style="border-top:1px solid rgba(255,255,255,.12); margin:6px 0;"></div>

      <div id="mihLangLabel" class="mih-menu-mini">Language</div>
      <div class="mih-menu-row">
        <button type="button" class="mih-lang-btn" data-lang="en">English</button>
        <button type="button" class="mih-lang-btn" data-lang="da">Dansk</button>
        <button type="button" class="mih-lang-btn" data-lang="cs">Čeština</button>
      </div>

      <div style="border-top:1px solid rgba(255,255,255,.12); margin:6px 0;"></div>

      <button class="mih-menu-btn danger" type="button" id="mihLogoutBtn" style="display:none;">Log out</button>

      <button class="mih-menu-btn danger" type="button" id="mihDeleteAccountBtn" style="display:none; background:#7f1d1d; border-color:rgba(239,68,68,.35);">
        Delete account
      </button>

      <button class="mih-menu-btn" type="button" id="mihExitBtn" style="border-color:rgba(239,68,68,.35);">Exit</button>

    </div>
  </aside>

  <!-- LOGIN SCENE -->
  <section id="mih-login" class="scene active">
    <h1 id="mihLoginTitle">Welcome back</h1>
    <p class="muted" id="mihLoginSubtitle">Enter your username and password.</p>

    <input id="mih-username" class="input" placeholder="Your name" />
    <input id="mih-password" class="input" type="password" placeholder="Password" />

    <button class="btn" id="mih-login-btn" type="button">Enter</button>

    <div style="margin-top:12px;">
      <button class="btn btn-small" id="mih-view-saved-pass" type="button">View saved login password</button>
      <div id="mih-saved-pass-display" class="muted" style="margin-top:10px; display:none;"></div>
    </div>
  </section>

  <!-- HOME SCENE -->
  <section id="mih-home" class="scene">
    <h1 id="mihHomeTitle">Your Dashboard</h1>
    <p class="muted" id="mihHomeSubtitle">Log your activity. Every kilometre counts.</p>

    <h2 id="mihAddTitle" style="margin-top:30px;">Log a new activity</h2>
    <input id="mih-distance" class="input" type="number" step="0.01" placeholder="Kilometres (e.g. 3.5)" />
    <input id="mih-minutes" class="input" type="number" step="1" placeholder="Time in minutes (e.g. 28)" />
    <button class="btn" id="mih-add-activity" type="button">Submit</button>

    <h2 id="mihRecentTitle" style="margin-top:40px;">Your recent entries</h2>
    <table>
      <thead>
        <tr>
          <th id="mihRecentColDate">Date</th>
          <th id="mihRecentColKm">Distance (km)</th>
          <th id="mihRecentColMin">Time (min)</th>
          <th id="mihRecentColPace">Pace</th>
        </tr>
      </thead>
      <tbody id="mih-recent"></tbody>
    </table>
  </section>

  <!-- LEADERBOARD SCENE -->
  <section id="mih-leaderboard" class="scene">
    <h1 id="mihLbTitle">Leaderboard</h1>
    <p class="muted" id="mihLbSubtitle">The League of Choice. Totals, all-time.</p>
    <table>
      <thead>
        <tr>
          <th id="mihLbColRank">#</th>
          <th id="mihLbColName">Name</th>
          <th id="mihLbColKm">Total km</th>
          <th id="mihLbColMin">Total min</th>
          <th id="mihLbColPace">Avg pace</th>
        </tr>
      </thead>
      <tbody id="mih-leaderboard-body"></tbody>
    </table>
  </section>

  <!-- PROFILES SCENE -->
  <section id="mih-profiles" class="scene">
    <h1 id="mihProfilesTitle">Profiles</h1>
    <p class="muted" id="mihProfilesSubtitle">Tap a player's name to view their stats.</p>

    <table>
      <thead>
        <tr>
          <th id="mihProfilesColName">Name</th>
          <th id="mihProfilesColKm">Total km</th>
          <th id="mihProfilesColMin">Total min</th>
          <th id="mihProfilesColRuns">Entries</th>
        </tr>
      </thead>
      <tbody id="mih-profiles-body"></tbody>
    </table>

    <div id="mihProfilePanel">
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:8px;">
        <div>
          <div id="mihProfileName" style="font-weight:700;font-size:18px;">—</div>
          <div id="mihProfileLeague" class="muted">The League of Choice</div>
        </div>
        <button type="button" class="btn btn-small" id="mihProfileClose">Close</button>
      </div>

      <div class="row"><span id="mihProfileRowKmLabel">Total km</span><b id="mihProfileKm">0</b></div>
      <div class="row"><span id="mihProfileRowMinLabel">Total min</span><b id="mihProfileMin">0</b></div>
      <div class="row"><span id="mihProfileRowRunsLabel">Entries</span><b id="mihProfileRuns">0</b></div>
      <div class="row"><span id="mihProfileRowAvgPaceLabel">Avg pace</span><b id="mihProfileAvgPace">0:00</b></div>

      <div style="margin-top:14px;">
        <div class="muted" id="mihProfileHistoryTitle">Recent activities</div>
        <table style="margin-top:10px;">
          <thead>
            <tr>
              <th id="mihProfileHistDate">Date</th>
              <th id="mihProfileHistKm">Km</th>
              <th id="mihProfileHistMin">Min</th>
              <th id="mihProfileHistPace">Pace</th>
            </tr>
          </thead>
          <tbody id="mih-profile-history"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- STATS SCENE -->
  <section id="mih-stats" class="scene">
    <h1 id="mihStatsTitle">Your Stats</h1>

    <div style="margin-top:20px;">
      <p><b id="mihStatsTotalKmLabel">Total km:</b> <span id="mih-total-km">0</span></p>
      <p><b id="mihStatsTotalMinLabel">Total minutes:</b> <span id="mih-total-min">0</span></p>
      <p><b id="mihStatsEntriesLabel">Entries:</b> <span id="mih-total-entries">0</span></p>
      <p><b id="mihStatsAvgKmLabel">Average distance:</b> <span id="mih-average-km">0</span></p>
      <p><b id="mihStatsAvgPaceLabel">Average pace:</b> <span id="mih-average-pace">0:00</span></p>
    </div>

    <h2 id="mihStatsHistoryTitle" style="margin-top:30px;">Your entry history</h2>
    <table>
      <thead>
        <tr>
          <th id="mihHistColDate">Date</th>
          <th id="mihHistColKm">Distance (km)</th>
          <th id="mihHistColMin">Time (min)</th>
          <th id="mihHistColPace">Pace</th>
        </tr>
      </thead>
      <tbody id="mih-history-body"></tbody>
    </table>
  </section>

  <!-- ABOUT SCENE -->
  <section id="mih-about" class="scene">
    <h1 id="mihAboutTitle">About the challenge</h1>
    <p class="muted" id="mihAboutBody">
      Make It Happen is about consistency. Not perfection.
      Log your movement, no matter how small. Every metre counts.
      We find that a league with competition motivates people to move more.
    </p>
  </section>
</div>

<script>
/* =========================================================
   GLOBAL LANGUAGE + ROUTER (NO SCENE PERSIST ON REFRESH)
========================================================= */

const LS_GLOBAL_LANG = "global_lang_v1";
let GLOBAL_LANG = localStorage.getItem(LS_GLOBAL_LANG) || "en";

const GLOBAL_TRANSLATIONS = {
  en: {
    welcomeTitle: "SEP",
    welcomeSubtitle: "Your Choice. Either shop (SEP shop), or move (Make It Happen). That simple.",
    welcomeSepBtn: "SEP shop",
    welcomeMihBtn: "Make It Happen",
    sepLangLabel: "Language",
    sepInfoLabel: "Info",
    sepExitLabel: "Exit",
    sepExitBtn: "Back to main menu",
    sepExitBtn2: "Exit to main menu",
    mihMenuTitle: "MENU",
    mihMenuLoginBtn: "Login",
    mihMenuHomeBtn: "Home",
    mihMenuLeaderboardBtn: "Leaderboard",
    mihMenuProfilesBtn: "Profiles",
    mihMenuStatsBtn: "Stats",
    mihMenuAboutBtn: "About",
    mihLangLabel: "Language",
    mihLogoutBtn: "Log out",
    mihExitBtn: "Exit",
    mihLoginTitle: "Welcome back",
    mihLoginSubtitle: "Enter your username and password.",
    mihUsernamePh: "Your name",
    mihPasswordPh: "Password",
    mihEnterBtn: "Enter",
    mihViewSaved: "View saved login password",
    mihSavedNone: "No login password has been saved on this device yet.",
    mihSavedShow: "Saved login password on this device: {password}",
    mihHomeTitle: "Your Dashboard",
    mihHomeSubtitle: "Log your activity. Every kilometre counts.",
    mihAddTitle: "Log a new activity",
    mihDistancePh: "Kilometres (e.g. 3.5)",
    mihMinutesPh: "Time in minutes (e.g. 28)",
    mihSubmit: "Submit",
    mihRecentTitle: "Your recent entries",
    mihRecentColDate: "Date",
    mihRecentColKm: "Distance (km)",
    mihRecentColMin: "Time (min)",
    mihRecentColPace: "Pace",
    mihLbTitle: "Leaderboard",
    mihLbSubtitle: "The League of Choice. Totals, all-time.",
    mihLbColRank: "#",
    mihLbColName: "Name",
    mihLbColKm: "Total km",
    mihLbColMin: "Total min",
    mihLbColPace: "Avg pace",
    mihProfilesTitle: "Profiles",
    mihProfilesSubtitle: "Tap a player's name to view their stats.",
    mihProfilesColName: "Name",
    mihProfilesColKm: "Total km",
    mihProfilesColMin: "Total min",
    mihProfilesColRuns: "Entries",
    mihProfileClose: "Close",
    mihProfileRowKmLabel: "Total km",
    mihProfileRowMinLabel: "Total min",
    mihProfileRowRunsLabel: "Entries",
    mihProfileRowAvgPaceLabel: "Avg pace",
    mihProfileHistoryTitle: "Recent activities",
    mihProfileHistDate: "Date",
    mihProfileHistKm: "Km",
    mihProfileHistMin: "Min",
    mihProfileHistPace: "Pace",
    mihStatsTitle: "Your Stats",
    mihStatsTotalKmLabel: "Total km:",
    mihStatsTotalMinLabel: "Total minutes:",
    mihStatsEntriesLabel: "Entries:",
    mihStatsAvgKmLabel: "Average distance:",
    mihStatsAvgPaceLabel: "Average pace:",
    mihStatsHistoryTitle: "Your entry history",
    mihHistColDate: "Date",
    mihHistColKm: "Distance (km)",
    mihHistColMin: "Time (min)",
    mihHistColPace: "Pace",
    mihAboutTitle: "About the challenge",
    mihAboutBody: "Make It Happen is about consistency. Not perfection. Log your movement, no matter how small. Every metre counts. We find that a league with competition motivates people to move more.",
    toastSaved: "Saved",
    errLoginMissing: "Please enter both name and password.",
    errWrongPass: "Wrong password for this name.",
    errFirebase: "Firebase failed to initialise. Check your config + internet connection.",
    errMustLogin: "Please log in first.",
    errActivityInvalid: "Please enter valid km and minutes.",
    noEntries: "No entries yet.",
    noPlayers: "No players yet.",
    confirmDelete: "Are you sure? This will remove you from leaderboard (entries stay, but hidden).",
    deletedOk: "Account deleted (hidden).",
    deletedErr: "Could not delete. Check Firestore rules."
  },
  da: {
    welcomeTitle: "SEP",
    welcomeSubtitle: "Dit valg. Enten shop (SEP shop), eller bevæg dig (Make It Happen). Så enkelt.",
    welcomeSepBtn: "SEP shop",
    welcomeMihBtn: "Make It Happen",
    sepLangLabel: "Sprog",
    sepInfoLabel: "Info",
    sepExitLabel: "Exit",
    sepExitBtn: "Tilbage til hovedmenu",
    sepExitBtn2: "Til hovedmenu",
    mihMenuTitle: "MENU",
    mihMenuLoginBtn: "Login",
    mihMenuHomeBtn: "Hjem",
    mihMenuLeaderboardBtn: "Leaderboard",
    mihMenuProfilesBtn: "Profiler",
    mihMenuStatsBtn: "Stats",
    mihMenuAboutBtn: "Om",
    mihLangLabel: "Sprog",
    mihLogoutBtn: "Log ud",
    mihExitBtn: "Exit",
    mihLoginTitle: "Velkommen tilbage",
    mihLoginSubtitle: "Indtast dit brugernavn og din adgangskode.",
    mihUsernamePh: "Dit navn",
    mihPasswordPh: "Adgangskode",
    mihEnterBtn: "Gå ind",
    mihViewSaved: "Se gemt login-adgangskode",
    mihSavedNone: "Der er ikke gemt nogen login-adgangskode på denne enhed endnu.",
    mihSavedShow: "Gemt login-adgangskode på denne enhed: {password}",
    mihHomeTitle: "Dit dashboard",
    mihHomeSubtitle: "Log din aktivitet. Hver kilometer tæller.",
    mihAddTitle: "Log en ny aktivitet",
    mihDistancePh: "Kilometer (fx 3,5)",
    mihMinutesPh: "Tid i minutter (fx 28)",
    mihSubmit: "Indsend",
    mihRecentTitle: "Dine seneste entries",
    mihRecentColDate: "Dato",
    mihRecentColKm: "Distance (km)",
    mihRecentColMin: "Tid (min)",
    mihRecentColPace: "Tempo",
    mihLbTitle: "Leaderboard",
    mihLbSubtitle: "The League of Choice. Samlet, all-time.",
    mihLbColRank: "#",
    mihLbColName: "Navn",
    mihLbColKm: "Km i alt",
    mihLbColMin: "Min i alt",
    mihLbColPace: "Gns. tempo",
    mihProfilesTitle: "Profiler",
    mihProfilesSubtitle: "Tryk på en spillers navn for at se deres stats.",
    mihProfilesColName: "Navn",
    mihProfilesColKm: "Km i alt",
    mihProfilesColMin: "Min i alt",
    mihProfilesColRuns: "Indgange",
    mihProfileClose: "Luk",
    mihProfileRowKmLabel: "Km i alt",
    mihProfileRowMinLabel: "Min i alt",
    mihProfileRowRunsLabel: "Indgange",
    mihProfileRowAvgPaceLabel: "Gns. tempo",
    mihProfileHistoryTitle: "Seneste aktiviteter",
    mihProfileHistDate: "Dato",
    mihProfileHistKm: "Km",
    mihProfileHistMin: "Min",
    mihProfileHistPace: "Tempo",
    mihStatsTitle: "Dine stats",
    mihStatsTotalKmLabel: "Km i alt:",
    mihStatsTotalMinLabel: "Minutter i alt:",
    mihStatsEntriesLabel: "Indgange:",
    mihStatsAvgKmLabel: "Gns. distance:",
    mihStatsAvgPaceLabel: "Gns. tempo:",
    mihStatsHistoryTitle: "Din historik",
    mihHistColDate: "Dato",
    mihHistColKm: "Distance (km)",
    mihHistColMin: "Tid (min)",
    mihHistColPace: "Tempo",
    mihAboutTitle: "Om challenge",
    mihAboutBody: "Make It Happen handler om kontinuitet. Ikke perfektion. Log din bevægelse, uanset hvor lidt. Hver meter tæller. Vi oplever, at en liga med konkurrence motiverer folk til at bevæge sig mere.",
    toastSaved: "Gemt",
    errLoginMissing: "Indtast både navn og adgangskode.",
    errWrongPass: "Forkert adgangskode til dette navn.",
    errFirebase: "Firebase kunne ikke starte. Tjek din config + internet.",
    errMustLogin: "Log ind først.",
    errActivityInvalid: "Indtast gyldige km og minutter.",
    noEntries: "Ingen entries endnu.",
    noPlayers: "Ingen spillere endnu.",
    confirmDelete: "Er du sikker? Det fjerner dig fra leaderboard (entries bliver, men skjult).",
    deletedOk: "Konto slettet (skjult).",
    deletedErr: "Kunne ikke slette. Tjek Firestore rules."
  },
  cs: {
    welcomeTitle: "SEP",
    welcomeSubtitle: "Tvoje volba. Buď nakupuj (SEP shop), nebo se hýbej (Make It Happen). Tak jednoduché.",
    welcomeSepBtn: "SEP shop",
    welcomeMihBtn: "Make It Happen",
    sepLangLabel: "Jazyk",
    sepInfoLabel: "Info",
    sepExitLabel: "Ukončit",
    sepExitBtn: "Zpět do hlavního menu",
    sepExitBtn2: "Zpět do hlavního menu",
    mihMenuTitle: "MENU",
    mihMenuLoginBtn: "Login",
    mihMenuHomeBtn: "Domů",
    mihMenuLeaderboardBtn: "Leaderboard",
    mihMenuProfilesBtn: "Profily",
    mihMenuStatsBtn: "Statistiky",
    mihMenuAboutBtn: "O aplikaci",
    mihLangLabel: "Jazyk",
    mihLogoutBtn: "Odhlásit",
    mihExitBtn: "Exit",
    mihLoginTitle: "Vítej zpět",
    mihLoginSubtitle: "Zadej své uživatelské jméno a heslo.",
    mihUsernamePh: "Tvoje jméno",
    mihPasswordPh: "Heslo",
    mihEnterBtn: "Vstoupit",
    mihViewSaved: "Zobrazit uložené heslo",
    mihSavedNone: "Na tomto zařízení zatím není uložené žádné heslo.",
    mihSavedShow: "Uložené heslo na tomto zařízení: {password}",
    mihHomeTitle: "Tvůj dashboard",
    mihHomeSubtitle: "Zapisuj aktivitu. Každý kilometr se počítá.",
    mihAddTitle: "Zapiš novou aktivitu",
    mihDistancePh: "Kilometry (např. 3.5)",
    mihMinutesPh: "Čas v minutách (např. 28)",
    mihSubmit: "Odeslat",
    mihRecentTitle: "Tvoje poslední záznamy",
    mihRecentColDate: "Datum",
    mihRecentColKm: "Vzdálenost (km)",
    mihRecentColMin: "Čas (min)",
    mihRecentColPace: "Tempo",
    mihLbTitle: "Leaderboard",
    mihLbSubtitle: "The League of Choice. Celkem, all-time.",
    mihLbColRank: "#",
    mihLbColName: "Jméno",
    mihLbColKm: "Celkem km",
    mihLbColMin: "Celkem min",
    mihLbColPace: "Prům. tempo",
    mihProfilesTitle: "Profily",
    mihProfilesSubtitle: "Klikni na jméno hráče a uvidíš jeho statistiky.",
    mihProfilesColName: "Jméno",
    mihProfilesColKm: "Celkem km",
    mihProfilesColMin: "Celkem min",
    mihProfilesColRuns: "Záznamy",
    mihProfileClose: "Zavřít",
    mihProfileRowKmLabel: "Celkem km",
    mihProfileRowMinLabel: "Celkem min",
    mihProfileRowRunsLabel: "Záznamy",
    mihProfileRowAvgPaceLabel: "Prům. tempo",
    mihProfileHistoryTitle: "Poslední aktivity",
    mihProfileHistDate: "Datum",
    mihProfileHistKm: "Km",
    mihProfileHistMin: "Min",
    mihProfileHistPace: "Tempo",
    mihStatsTitle: "Tvoje statistiky",
    mihStatsTotalKmLabel: "Celkem km:",
    mihStatsTotalMinLabel: "Celkem minut:",
    mihStatsEntriesLabel: "Záznamy:",
    mihStatsAvgKmLabel: "Prům. vzdálenost:",
    mihStatsAvgPaceLabel: "Prům. tempo:",
    mihStatsHistoryTitle: "Historie",
    mihHistColDate: "Datum",
    mihHistColKm: "Vzdálenost (km)",
    mihHistColMin: "Čas (min)",
    mihHistColPace: "Tempo",
    mihAboutTitle: "O výzvě",
    mihAboutBody: "Make It Happen je o konzistenci. Ne o perfektnosti. Zapisuj pohyb, i když je malý. Každý metr se počítá. Zjistili jsme, že liga s trochou soutěživosti motivuje lidi hýbat se víc.",
    toastSaved: "Uloženo",
    errLoginMissing: "Zadej jméno i heslo.",
    errWrongPass: "Špatné heslo pro toto jméno.",
    errFirebase: "Firebase se nepodařilo spustit. Zkontroluj config + internet.",
    errMustLogin: "Nejdřív se přihlas.",
    errActivityInvalid: "Zadej platné km i minuty.",
    noEntries: "Zatím žádné záznamy.",
    noPlayers: "Zatím žádní hráči.",
    confirmDelete: "Jsi si jistý? Odstraní tě to z leaderboardu (záznamy zůstanou, ale skryté).",
    deletedOk: "Účet smazán (skrytý).",
    deletedErr: "Nešlo smazat. Zkontroluj Firestore rules."
  }
};

function GT(key, vars){
  const pack = GLOBAL_TRANSLATIONS[GLOBAL_LANG] || GLOBAL_TRANSLATIONS.en;
  let str = pack[key] || (GLOBAL_TRANSLATIONS.en[key] || key);
  if (vars){
    Object.keys(vars).forEach(k => { str = str.replace(`{${k}}`, vars[k]); });
  }
  return str;
}

function toast(msg, good=true){
  const el = document.getElementById('toast');
  if (!el) return;
  el.style.background = good ? "#16a34a" : "#ef4444";
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'), 1600);
}

function applyGlobalTranslations(){
  const map = [
    ['welcomeTitle','welcomeTitle'], ['welcomeSubtitle','welcomeSubtitle'], ['welcomeSepBtn','welcomeSepBtn'], ['welcomeMihBtn','welcomeMihBtn'],
    ['sepLangLabel','sepLangLabel'], ['sepInfoLabel','sepInfoLabel'], ['sepExitLabel','sepExitLabel'], ['sepExitBtn','sepExitBtn'], ['sepExitBtn2','sepExitBtn2'],
    ['mihMenuTitle','mihMenuTitle'], ['mihMenuLoginBtn','mihMenuLoginBtn'], ['mihMenuHomeBtn','mihMenuHomeBtn'], ['mihMenuLeaderboardBtn','mihMenuLeaderboardBtn'],
    ['mihMenuProfilesBtn','mihMenuProfilesBtn'], ['mihMenuStatsBtn','mihMenuStatsBtn'], ['mihMenuAboutBtn','mihMenuAboutBtn'], ['mihLangLabel','mihLangLabel'],
    ['mihLogoutBtn','mihLogoutBtn'], ['mihExitBtn','mihExitBtn'], ['mihLoginTitle','mihLoginTitle'], ['mihLoginSubtitle','mihLoginSubtitle'],
    ['mihHomeTitle','mihHomeTitle'], ['mihHomeSubtitle','mihHomeSubtitle'], ['mihAddTitle','mihAddTitle'], ['mihRecentTitle','mihRecentTitle'],
    ['mihLbTitle','mihLbTitle'], ['mihLbSubtitle','mihLbSubtitle'], ['mihProfilesTitle','mihProfilesTitle'], ['mihProfilesSubtitle','mihProfilesSubtitle'],
    ['mihStatsTitle','mihStatsTitle'], ['mihStatsHistoryTitle','mihStatsHistoryTitle'], ['mihAboutTitle','mihAboutTitle'],
    ['mihRecentColDate','mihRecentColDate'], ['mihRecentColKm','mihRecentColKm'], ['mihRecentColMin','mihRecentColMin'], ['mihRecentColPace','mihRecentColPace'],
    ['mihLbColRank','mihLbColRank'], ['mihLbColName','mihLbColName'], ['mihLbColKm','mihLbColKm'], ['mihLbColMin','mihLbColMin'], ['mihLbColPace','mihLbColPace'],
    ['mihProfilesColName','mihProfilesColName'], ['mihProfilesColKm','mihProfilesColKm'], ['mihProfilesColMin','mihProfilesColMin'], ['mihProfilesColRuns','mihProfilesColRuns'],
    ['mihProfileClose','mihProfileClose'], ['mihProfileRowKmLabel','mihProfileRowKmLabel'], ['mihProfileRowMinLabel','mihProfileRowMinLabel'],
    ['mihProfileRowRunsLabel','mihProfileRowRunsLabel'], ['mihProfileRowAvgPaceLabel','mihProfileRowAvgPaceLabel'],
    ['mihProfileHistoryTitle','mihProfileHistoryTitle'], ['mihProfileHistDate','mihProfileHistDate'], ['mihProfileHistKm','mihProfileHistKm'],
    ['mihProfileHistMin','mihProfileHistMin'], ['mihProfileHistPace','mihProfileHistPace'],
    ['mihStatsTotalKmLabel','mihStatsTotalKmLabel'], ['mihStatsTotalMinLabel','mihStatsTotalMinLabel'], ['mihStatsEntriesLabel','mihStatsEntriesLabel'],
    ['mihStatsAvgKmLabel','mihStatsAvgKmLabel'], ['mihStatsAvgPaceLabel','mihStatsAvgPaceLabel'],
    ['mihHistColDate','mihHistColDate'], ['mihHistColKm','mihHistColKm'], ['mihHistColMin','mihHistColMin'], ['mihHistColPace','mihHistColPace'],
  ];
  map.forEach(([id,key])=>{
    const el = document.getElementById(id);
    if (el) el.textContent = GT(key);
  });

  const about = document.getElementById('mihAboutBody');
  if (about) about.textContent = GT('mihAboutBody');

  const u = document.getElementById('mih-username');
  const p = document.getElementById('mih-password');
  const d = document.getElementById('mih-distance');
  const m = document.getElementById('mih-minutes');
  if (u) u.placeholder = GT('mihUsernamePh');
  if (p) p.placeholder = GT('mihPasswordPh');
  if (d) d.placeholder = GT('mihDistancePh');
  if (m) m.placeholder = GT('mihMinutesPh');

  const enter = document.getElementById('mih-login-btn');
  const submit = document.getElementById('mih-add-activity');
  const viewSaved = document.getElementById('mih-view-saved-pass');
  if (enter) enter.textContent = GT('mihEnterBtn');
  if (submit) submit.textContent = GT('mihSubmit');
  if (viewSaved) viewSaved.textContent = GT('mihViewSaved');
}

function setGlobalLang(lang){
  GLOBAL_LANG = lang || "en";
  localStorage.setItem(LS_GLOBAL_LANG, GLOBAL_LANG);

  document.querySelectorAll('.welcome-lang-btn').forEach(btn => {
    btn.classList.toggle('active', btn.getAttribute('data-lang') === GLOBAL_LANG);
  });
  document.querySelectorAll('.mih-lang-btn').forEach(btn => {
    btn.classList.toggle('active', btn.getAttribute('data-lang') === GLOBAL_LANG);
  });
  document.querySelectorAll('.lang-btn').forEach(btn => {
    btn.classList.toggle('active', btn.getAttribute('data-lang') === GLOBAL_LANG);
  });

  if (window.__SEP_SET_LANG) window.__SEP_SET_LANG(GLOBAL_LANG);
  applyGlobalTranslations();
}

/* Router (NO persistence) */
function showApp(app){
  const welcome = document.getElementById('welcome-screen');
  const sepApp = document.getElementById('sep-app');
  const mihApp = document.getElementById('mih-app');

  if (app === 'sep'){
    welcome && welcome.classList.add('hidden');
    mihApp && mihApp.classList.add('hidden');
    sepApp && sepApp.classList.remove('hidden');
    window.scrollTo({ top: 0, behavior: 'auto' });
    return;
  }
  if (app === 'mih'){
    welcome && welcome.classList.add('hidden');
    sepApp && sepApp.classList.add('hidden');
    mihApp && mihApp.classList.remove('hidden');
    window.scrollTo({ top: 0, behavior: 'auto' });
    return;
  }

  sepApp && sepApp.classList.add('hidden');
  mihApp && mihApp.classList.add('hidden');
  welcome && welcome.classList.remove('hidden');
  window.scrollTo({ top: 0, behavior: 'auto' });
}
function openSep(){ showApp('sep'); }
function openMih(){ showApp('mih'); }
function backToMainMenu(){ showApp('welcome'); }
</script>

<script>
/* =========================================================
   SEP LOGIC (Translations + Burger + Cart)
========================================================= */
(function () {
  const LS_SEP_CART = "sep_cart_v1";
  const SHIPPING_DKK = 45;

  const sepTranslations = {
    en: {
      menuTitle: "SEP Menu",
      navAboutSep: 'About "SEP"',
      heroTitle: "Clothes chosen for you.",
      heroSubtitle: "Clothes worthy of just wearing.",
      btnShopNow: "Shop Now",
      btnViewCart: "View Cart",
      addToCart: "Add",
      productsTitle: "Two products. Three choices.",
      productsSubtitle: "Our soft collection:",
      product1Name: "SEP White T-shirt",
      product2Name: "SEP Sweater",
      aboutTitle: "About SEP",
      aboutBody1: "SEP stands for Se Proairesis - your choice in ancient greek. Each piece is pressed by hand in Copenhagen in small batches.",
      aboutBody2: "We make batches with small choice but good quality - rather focusing on quality than choice. That doesn't mean we wont do big batches though. We can't buy thousands of peices yet (we are still a small brand staring up)",
      aboutBody3: "One t-shirt, one sweater; all built to be the first thing you reach for when you open your wardrobe. I'm still a 13-year-old which means I cant have apple pay yet. So there's only mobile pay so far.",
      aboutBackBtn: "Back to shop",
      howToOrderTitle: "How to Order",
      step1Title: "1. Choose",
      step2Title: "2. Add to Cart",
      step3Title: "3. Copy Order Message",
      step4Title: "4. Pay with MobilePay",
      step5Title: "5. Send us your order",
      howStep1: "Select your favourite SEP piece - T-shirt or Sweater - then pick your size and quantity.",
      howStep2: "Click “Add” to add your chosen items to your cart. When ready, click “View Cart” to review your order.",
      howStep3: "Inside your cart, press “Copy Order Message”. This copies your full order, including shipping, automatically.",
      howStep4: "Send the total amount (incl. +45 DKK shipping, free in Copenhagen.) to 5894BZ using MobilePay.\n“Open MobilePay” works only on mobile devices.",
      howStep5: "DM your copied message to @seproairesis (Instagram) or @seproairesis (TikTok).\nWe currently deliver only within Denmark.",
      footerText: "© 2025 SEP - Se Proairesis • MobilePay 5894BZ • +45 DKK Shipping • Made in Copenhagen. Only delivered across Denmark.",
      cartTitle: "Your Cart",
      cartSubtotalLabel: "Subtotal:",
      cartShippingLabel: "Shipping:",
      cartShippingValue: "+45 DKK",
      cartTotalLabel: "Total:",
      cartMobilePayButton: "Open MobilePay",
      cartMobilePayNote: "*Open MobilePay button is only valid on mobile*",
      cartCopyOrder: "Copy Order Message",
      cartEmpty: "Cart is empty",
      labelSizeQty: "Size: {size} | Qty: {qty}",
      btnRemove: "Remove",
      popupAdded: "Added to cart",
      popupOrderCopied: "Order message copied!",
      orderIntro: "Hi SEP, here is my order:",
      orderSubtotalLabel: "Subtotal:",
      orderShippingLabel: "Shipping:",
      orderTotalLabel: "Total:",
      orderItem: "{qty}× {name} (Size: {size})"
    },
    da: {
      menuTitle: "SEP menu",
      navAboutSep: 'Om "SEP"',
      heroTitle: "Tøj valgt til dig.",
      heroSubtitle: "Tøj, der er bare værd at have på.",
      btnShopNow: "Shop nu",
      btnViewCart: "Se kurv",
      addToCart: "Læg i kurv",
      productsTitle: "To produkter. Tre valg.",
      productsSubtitle: "Vores bløde kollektion:",
      product1Name: "SEP hvid T-shirt",
      product2Name: "SEP sweater",
      aboutTitle: "Om SEP",
      aboutBody1: "SEP står for Se Proairesis – dit valg på oldgræsk. Hvert stykke presses i hånden i København i små batches.",
      aboutBody2: "Vi laver batches med få valg, men god kvalitet – vi fokuserer på kvalitet frem for udvalg. Vi er stadig et lille brand i opstart, så vi kan ikke købe tusindvis endnu.",
      aboutBody3: "En T-shirt, en sweater – lavet til at være det første, du rækker ud efter. Jeg er stadig 13 år, så jeg kan ikke have Apple Pay endnu. Derfor er det kun MobilePay lige nu.",
      aboutBackBtn: "Tilbage til shop",
      howToOrderTitle: "Sådan bestiller du",
      step1Title: "1. Vælg",
      step2Title: "2. Læg i kurv",
      step3Title: "3. Kopiér ordrebesked",
      step4Title: "4. Betal med MobilePay",
      step5Title: "5. Send din ordre",
      howStep1: "Vælg din foretrukne SEP-del – T-shirt eller sweater – og vælg størrelse og antal.",
      howStep2: "Tryk “Læg i kurv” for at tilføje dine varer. Når du er klar, tryk “Se kurv” for at tjekke din ordre.",
      howStep3: "I kurven trykker du “Kopiér ordrebesked”. Det kopierer hele din ordre automatisk, inkl. fragt.",
      howStep4: "Send det samlede beløb (inkl. +45 DKK fragt, gratis i København) til 5894BZ via MobilePay.\n“Åbn MobilePay” virker kun på mobilenheder.",
      howStep5: "Send din besked som DM til @seproairesis (Instagram) eller @seproairesis (TikTok).\nVi leverer kun i Danmark.",
      footerText: "© 2025 SEP - Se Proairesis • MobilePay 5894BZ • +45 DKK fragt • Lavet i København. Leveres kun i Danmark.",
      cartTitle: "Din kurv",
      cartSubtotalLabel: "Subtotal:",
      cartShippingLabel: "Fragt:",
      cartShippingValue: "+45 DKK",
      cartTotalLabel: "Total:",
      cartMobilePayButton: "Åbn MobilePay",
      cartMobilePayNote: "*MobilePay-knappen virker kun som link på mobil*",
      cartCopyOrder: "Kopiér ordrebesked",
      cartEmpty: "Kurven er tom",
      labelSizeQty: "Størrelse: {size} | Antal: {qty}",
      btnRemove: "Fjern",
      popupAdded: "Lagt i kurv",
      popupOrderCopied: "Ordrebesked kopieret!",
      orderIntro: "Hej SEP, her er min ordre:",
      orderSubtotalLabel: "Subtotal:",
      orderShippingLabel: "Fragt:",
      orderTotalLabel: "Total:",
      orderItem: "{qty}× {name} (Størrelse: {size})"
    },
    cs: {
      menuTitle: "Menu SEP",
      navAboutSep: 'O „SEP“',
      heroTitle: "Oblečení vybrané pro tebe.",
      heroSubtitle: "Oblečení, které prostě stojí za nošení.",
      btnShopNow: "Nakoupit",
      btnViewCart: "Košík",
      addToCart: "Přidat",
      productsTitle: "Dva produkty. Tři volby.",
      productsSubtitle: "Naše měkká kolekce:",
      product1Name: "SEP bílé tričko",
      product2Name: "SEP mikina",
      aboutTitle: "O SEP",
      aboutBody1: "SEP znamená Se Proairesis – tvoje volba ve staré řečtině. Každý kus je ručně lisovaný v Kodani v malých dávkách.",
      aboutBody2: "Děláme malé série s malým výběrem, ale vysokou kvalitou. Jsme malé značky na startu, takže zatím nemůžeme kupovat tisíce kusů.",
      aboutBody3: "Jedno tričko, jedna mikina; aby to byla první věc, po které sáhneš. Je mi 13, takže nemám Apple Pay. Zatím jen MobilePay.",
      aboutBackBtn: "Zpět do shopu",
      howToOrderTitle: "Jak objednat",
      step1Title: "1. Vyber",
      step2Title: "2. Přidej do košíku",
      step3Title: "3. Zkopíruj zprávu",
      step4Title: "4. Zaplať MobilePay",
      step5Title: "5. Pošli objednávku",
      howStep1: "Vyber svůj SEP kus (tričko nebo mikinu), pak velikost a počet.",
      howStep2: "Klikni „Přidat“ a dej věci do košíku. Až budeš připraven, otevři košík.",
      howStep3: "V košíku klikni „Zkopírovat zprávu“. Zkopíruje se celá objednávka včetně dopravy.",
      howStep4: "Pošli celkovou částku (vč. +45 DKK dopravy, v Kodani zdarma) na 5894BZ přes MobilePay.\n„Otevřít MobilePay“ funguje jen na mobilu.",
      howStep5: "Pošli zkopírovanou zprávu do DM na @seproairesis (Instagram) nebo @seproairesis (TikTok).\nDoručujeme jen v Dánsku.",
      footerText: "© 2025 SEP - Se Proairesis • MobilePay 5894BZ • +45 DKK doprava • Vyrobeno v Kodani. Jen Dánsko.",
      cartTitle: "Košík",
      cartSubtotalLabel: "Mezisoučet:",
      cartShippingLabel: "Doprava:",
      cartShippingValue: "+45 DKK",
      cartTotalLabel: "Celkem:",
      cartMobilePayButton: "Otevřít MobilePay",
      cartMobilePayNote: "*Tlačítko funguje jen na mobilu*",
      cartCopyOrder: "Zkopírovat zprávu",
      cartEmpty: "Košík je prázdný",
      labelSizeQty: "Velikost: {size} | Počet: {qty}",
      btnRemove: "Odebrat",
      popupAdded: "Přidáno do košíku",
      popupOrderCopied: "Zpráva zkopírována!",
      orderIntro: "Ahoj SEP, tady je moje objednávka:",
      orderSubtotalLabel: "Mezisoučet:",
      orderShippingLabel: "Doprava:",
      orderTotalLabel: "Celkem:",
      orderItem: "{qty}× {name} (Velikost: {size})"
    }
  };

  function ST(key, vars){
    const pack = sepTranslations[GLOBAL_LANG] || sepTranslations.en;
    let str = pack[key] || (sepTranslations.en[key] || key);
    if (vars){
      Object.keys(vars).forEach(k => { str = str.replace(`{${k}}`, vars[k]); });
    }
    return str;
  }

  window.__SEP_SET_LANG = function(){
    const map = [
      ['menuTitle','menuTitle'],
      ['menuAboutBtn','navAboutSep'],
      ['heroTitle','heroTitle'],
      ['heroSubtitle','heroSubtitle'],
      ['btnShopNow','btnShopNow'],
      ['btnViewCart','btnViewCart'],
      ['productsTitle','productsTitle'],
      ['productsSubtitle','productsSubtitle'],
      ['product1Name','product1Name'],
      ['product2Name','product2Name'],
      ['aboutTitle','aboutTitle'],
      ['aboutBody1','aboutBody1'],
      ['aboutBody2','aboutBody2'],
      ['aboutBody3','aboutBody3'],
      ['aboutBackBtn','aboutBackBtn'],
      ['howToOrderTitle','howToOrderTitle'],
      ['step1Title','step1Title'],
      ['step2Title','step2Title'],
      ['step3Title','step3Title'],
      ['step4Title','step4Title'],
      ['step5Title','step5Title'],
      ['howStep1','howStep1'],
      ['howStep2','howStep2'],
      ['howStep3','howStep3'],
      ['howStep4','howStep4'],
      ['howStep5','howStep5'],
      ['footerText','footerText'],
      ['cartTitle','cartTitle'],
      ['cartSubtotalLabel','cartSubtotalLabel'],
      ['cartShippingLabel','cartShippingLabel'],
      ['cartShippingValue','cartShippingValue'],
      ['cartTotalLabel','cartTotalLabel'],
      ['cartMobilePayButton','cartMobilePayButton'],
      ['cartMobilePayNote','cartMobilePayNote'],
      ['cartCopyOrder','cartCopyOrder'],
    ];
    map.forEach(([id,key])=>{
      const el = document.getElementById(id);
      if (el) el.textContent = ST(key);
    });

    document.querySelectorAll('[data-i18n-btn="addToCart"]').forEach(btn=>{
      btn.textContent = ST('addToCart');
    });
  };

  function loadCart(){
    try { return JSON.parse(localStorage.getItem(LS_SEP_CART) || "[]"); }
    catch { return []; }
  }
  function saveCart(cart){
    localStorage.setItem(LS_SEP_CART, JSON.stringify(cart || []));
  }

  function cartSubtotal(cart){
    return (cart || []).reduce((sum, it)=> sum + (Number(it.price)||0) * (Number(it.qty)||0), 0);
  }

  function updateCartBadge(){
    const cart = loadCart();
    const count = cart.reduce((s,it)=> s + (Number(it.qty)||0), 0);
    const badge = document.getElementById('cartCounter');
    if (!badge) return;
    if (count > 0){
      badge.textContent = String(count);
      badge.classList.remove('hidden');
    } else {
      badge.classList.add('hidden');
    }
  }

  function renderCart(){
    const cart = loadCart();
    const itemsEl = document.getElementById('cartItems');
    if (!itemsEl) return;

    itemsEl.innerHTML = "";
    if (!cart.length){
      itemsEl.innerHTML = `<div class="text-gray-500">${ST('cartEmpty')}</div>`;
    } else {
      cart.forEach((it, idx)=>{
        const row = document.createElement('div');
        row.className = "border border-gray-200 rounded-lg p-3";
        row.innerHTML = `
          <div class="flex justify-between gap-3">
            <div>
              <div class="font-semibold">${it.name}</div>
              <div class="text-xs text-gray-600">${ST('labelSizeQty', { size: it.size, qty: it.qty })}</div>
              <div class="text-xs text-gray-600">${it.price} DKK</div>
            </div>
            <button data-remove="${idx}" class="text-sm underline text-gray-700">${ST('btnRemove')}</button>
          </div>
        `;
        itemsEl.appendChild(row);
      });
    }

    const sub = cartSubtotal(cart);
    const total = sub + SHIPPING_DKK; // total = subtotal + 45
    const subEl = document.getElementById('cartSubtotal');
    const totalEl = document.getElementById('cartTotal');
    if (subEl) subEl.textContent = `${sub} DKK`;
    if (totalEl) totalEl.textContent = `${total} DKK`;

    itemsEl.querySelectorAll('button[data-remove]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const i = Number(btn.getAttribute('data-remove'));
        const next = loadCart();
        next.splice(i,1);
        saveCart(next);
        renderCart();
        updateCartBadge();
      });
    });
  }

  function openCart(){
    const sidebar = document.getElementById('cartSidebar');
    const overlay = document.getElementById('cartOverlay');
    if (sidebar) sidebar.classList.remove('translate-x-full');
    if (overlay){
      overlay.classList.remove('hidden');
      overlay.classList.remove('pointer-none');
      overlay.classList.add('pointer-auto');
    }
    renderCart();
  }
  function closeCart(){
    const sidebar = document.getElementById('cartSidebar');
    const overlay = document.getElementById('cartOverlay');
    if (sidebar) sidebar.classList.add('translate-x-full');
    if (overlay){
      overlay.classList.add('hidden');
      overlay.classList.add('pointer-none');
      overlay.classList.remove('pointer-auto');
    }
  }

  function copyOrderMessage(){
    const cart = loadCart();
    const sub = cartSubtotal(cart);
    const total = sub + SHIPPING_DKK;

    const lines = [];
    lines.push(ST('orderIntro'));
    cart.forEach(it=>{
      lines.push(ST('orderItem', { qty: it.qty, name: it.name, size: it.size }));
    });
    lines.push(`${ST('orderSubtotalLabel')} ${sub} DKK`);
    lines.push(`${ST('orderShippingLabel')} ${SHIPPING_DKK} DKK`);
    lines.push(`${ST('orderTotalLabel')} ${total} DKK`);
    lines.push(`MobilePay box: 5894BZ`);

    const msg = lines.join("\n");
    navigator.clipboard.writeText(msg).then(()=>{
      toast(ST('popupOrderCopied'), true);
    }).catch(()=>{
      const ta = document.createElement('textarea');
      ta.value = msg;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      toast(ST('popupOrderCopied'), true);
    });
  }

  function isMobile(){
    return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent || "");
  }

  function openMobilePay(){
    if (!isMobile()){
      toast("Open MobilePay works on mobile.", false);
      return;
    }
    copyOrderMessage();
    alert("Copied your order message. Now open MobilePay and pay to box 5894BZ, then DM @seproairesis.");
  }

  function openSepAbout(){
    document.getElementById('sep-scene-main')?.classList.add('hidden');
    document.getElementById('sep-scene-about')?.classList.remove('hidden');
  }
  function backToShop(){
    document.getElementById('sep-scene-about')?.classList.add('hidden');
    document.getElementById('sep-scene-main')?.classList.remove('hidden');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // SEP burger
  function openSepMenu(){
    const panel = document.getElementById('menuPanel');
    const overlay = document.getElementById('menuOverlay');
    if (panel) panel.classList.remove('translate-x-full');
    if (overlay){
      overlay.classList.remove('hidden');
      overlay.classList.remove('pointer-none');
      overlay.classList.add('pointer-auto');
    }
  }
  function closeSepMenu(){
    const panel = document.getElementById('menuPanel');
    const overlay = document.getElementById('menuOverlay');
    if (panel) panel.classList.add('translate-x-full');
    if (overlay){
      overlay.classList.add('hidden');
      overlay.classList.add('pointer-none');
      overlay.classList.remove('pointer-auto');
    }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    document.querySelectorAll('.add-to-cart').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const card = btn.closest('.product-card');
        const size = card?.querySelector('.size-selector')?.value || "M";
        const qty = Number(card?.querySelector('.quantity-selector')?.value || 1);
        const name = btn.getAttribute('data-name') || "Item";
        const price = Number(btn.getAttribute('data-price') || 0);

        const cart = loadCart();
        cart.push({ name, price, size, qty: Math.max(1, qty) });
        saveCart(cart);

        updateCartBadge();
        toast((sepTranslations[GLOBAL_LANG]||sepTranslations.en).popupAdded || "Added", true);
      });
    });

    document.getElementById('viewCartBtn')?.addEventListener('click', openCart);
    document.getElementById('closeCart')?.addEventListener('click', closeCart);
    document.getElementById('cartOverlay')?.addEventListener('click', closeCart);
    document.getElementById('copyMobilePay')?.addEventListener('click', copyOrderMessage);
    document.getElementById('openMobilePay')?.addEventListener('click', openMobilePay);

    document.getElementById('menuAboutBtn')?.addEventListener('click', ()=>{ closeSepMenu(); openSepAbout(); });
    document.getElementById('aboutBackBtn')?.addEventListener('click', backToShop);

    document.getElementById('sepExitBtn')?.addEventListener('click', ()=>{ closeSepMenu(); backToMainMenu(); });
    document.getElementById('sepExitBtn2')?.addEventListener('click', backToMainMenu);

    document.getElementById('menuToggle')?.addEventListener('click', openSepMenu);
    document.getElementById('menuClose')?.addEventListener('click', closeSepMenu);
    document.getElementById('menuOverlay')?.addEventListener('click', closeSepMenu);

    updateCartBadge();
  });
})();
</script>

<script>
/* =========================================================
   MIH LOGIC (Firebase + Scenes + Leaderboard + Soft Delete)
   - NO "remember scene after refresh"
   - Delete account works by updating the user doc to status="deleted"
========================================================= */

const LS_MIH_USER = "mih_username_v2";
const LS_MIH_PASS = "mih_password_v2";

let MIH = {
  ready:false,
  user:null,      // { name, password }
  db:null,
  uid:null
};

function mihSetPills(){
  const pill = document.getElementById('mih-user-pill');
  const mini = document.getElementById('mihMenuUserMini');
  const name = MIH.user?.name ? MIH.user.name : "Not logged in";
  if (pill) pill.textContent = name;
  if (mini) mini.textContent = name;
}

function mihShowScene(id){
  document.querySelectorAll('#mih-app .scene').forEach(s=>s.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) el.classList.add('active');
}

function mihOpenMenu(){
  document.getElementById('mihMenuPanel')?.classList.add('open');
  document.getElementById('mihMenuOverlay')?.classList.add('open');
}
function mihCloseMenu(){
  document.getElementById('mihMenuPanel')?.classList.remove('open');
  document.getElementById('mihMenuOverlay')?.classList.remove('open');
}

function paceStr(km, minutes){
  const m = Number(minutes)||0;
  const k = Number(km)||0;
  if (k <= 0 || m <= 0) return "0:00";
  const pace = m / k;
  const mm = Math.floor(pace);
  const ss = Math.round((pace - mm) * 60);
  return `${mm}:${String(ss).padStart(2,'0')}`;
}
function fmtDate(ts){
  const d = new Date(Number(ts)||Date.now());
  return d.toLocaleDateString();
}

async function mihInitFirebase(){
  try{
    const firebaseConfig = {
      apiKey: "AIzaSyAkbH3mJkeheF3L7EaqN1kMgbFd_LJCIXo",
      authDomain: "hitachi-vantara-make-it-happen.firebaseapp.com",
      projectId: "hitachi-vantara-make-it-happen",
      storageBucket: "hitachi-vantara-make-it-happen.firebasestorage.app",
      messagingSenderId: "749690169824",
      appId: "1:749690169824:web:21d6b8d2a5862847e4e385",
      measurementId: "G-7WZ03E68MF"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    MIH.db = firebase.firestore();

    // Anonymous auth so request.auth exists in rules (if you use rules with auth)
    const cred = await firebase.auth().signInAnonymously();
    MIH.uid = cred?.user?.uid || firebase.auth().currentUser?.uid || null;

    MIH.ready = true;
  }catch(err){
    console.error(err);
    toast(GT('errFirebase'), false);
    MIH.ready = false;
  }
}

async function mihLoginOrCreate(username, password){
  if (!MIH.ready) { toast(GT('errFirebase'), false); return; }
  const name = (username || "").trim();
  const pass = (password || "").trim();
  if (!name || !pass) { toast(GT('errLoginMissing'), false); return; }

  const userRef = MIH.db.collection('mih_users_v2').doc(name);
  const snap = await userRef.get();

  if (snap.exists){
    const data = snap.data() || {};
    if (data.status === "deleted"){
      toast("This account is deleted.", false);
      return;
    }
    if (data.password !== pass){
      toast(GT('errWrongPass'), false);
      return;
    }

    // Optional patch: ensure uid/name exist (helps if your rules require them)
    try{
      if (!data.uid || !data.name){
        await userRef.set({ uid: MIH.uid || null, name }, { merge:true });
      }
    }catch(e){ /* ignore */ }

    MIH.user = { name, password: pass };
    localStorage.setItem(LS_MIH_USER, name);
    localStorage.setItem(LS_MIH_PASS, pass);
    mihSetPills();
    mihUpdateMenuButtons();
    await mihRefreshAll();
    mihShowScene('mih-home');
    return;
  }

  // create new
  await userRef.set({
    uid: MIH.uid || null,
    name,
    password: pass,
    status: "active",
    createdAt: Date.now(),
    totalKm: 0,
    totalMin: 0,
    entries: 0
  });

  MIH.user = { name, password: pass };
  localStorage.setItem(LS_MIH_USER, name);
  localStorage.setItem(LS_MIH_PASS, pass);
  mihSetPills();
  mihUpdateMenuButtons();
  await mihRefreshAll();
  mihShowScene('mih-home');
}

function mihLogout(){
  MIH.user = null;
  localStorage.removeItem(LS_MIH_USER);
  localStorage.removeItem(LS_MIH_PASS);
  mihSetPills();
  mihUpdateMenuButtons();
  mihShowScene('mih-login');
}

function mihUpdateMenuButtons(){
  const loggedIn = !!MIH.user?.name;
  const logoutBtn = document.getElementById('mihLogoutBtn');
  const delBtn = document.getElementById('mihDeleteAccountBtn');
  if (logoutBtn) logoutBtn.style.display = loggedIn ? "block" : "none";
  if (delBtn) delBtn.style.display = loggedIn ? "block" : "none";
}

async function mihAddActivity(km, minutes){
  if (!MIH.user?.name) { toast(GT('errMustLogin'), false); return; }
  if (!MIH.ready) { toast(GT('errFirebase'), false); return; }

  const k = Number(km);
  const m = Number(minutes);
  if (!(k > 0) || !(m > 0)) { toast(GT('errActivityInvalid'), false); return; }

  const username = MIH.user.name;
  const ts = Date.now();

  const entryRef = MIH.db.collection('mih_entries_v2').doc();
  const userRef = MIH.db.collection('mih_users_v2').doc(username);

  const batch = MIH.db.batch();
  batch.set(entryRef, { uid: MIH.uid || null, username, km: k, minutes: m, ts });
  batch.update(userRef, {
    totalKm: firebase.firestore.FieldValue.increment(k),
    totalMin: firebase.firestore.FieldValue.increment(m),
    entries: firebase.firestore.FieldValue.increment(1)
  });
  await batch.commit();

  toast(GT('toastSaved'), true);

  document.getElementById('mih-distance').value = "";
  document.getElementById('mih-minutes').value = "";

  await mihRefreshAll();
}

async function mihLoadMyRecent(){
  const tbody = document.getElementById('mih-recent');
  if (!tbody) return;
  tbody.innerHTML = "";

  if (!MIH.user?.name) {
    tbody.innerHTML = `<tr><td colspan="4" class="muted">${GT('errMustLogin')}</td></tr>`;
    return;
  }

  const snap = await MIH.db.collection('mih_entries_v2')
    .where('username','==',MIH.user.name)
    .orderBy('ts','desc')
    .limit(15)
    .get();

  if (snap.empty){
    tbody.innerHTML = `<tr><td colspan="4" class="muted">${GT('noEntries')}</td></tr>`;
    return;
  }

  snap.forEach(doc=>{
    const d = doc.data();
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${fmtDate(d.ts)}</td>
      <td>${Number(d.km).toFixed(2)}</td>
      <td>${Number(d.minutes).toFixed(0)}</td>
      <td>${paceStr(d.km, d.minutes)}</td>
    `;
    tbody.appendChild(tr);
  });
}

async function mihLoadMyStatsAndHistory(){
  const kmEl = document.getElementById('mih-total-km');
  const minEl = document.getElementById('mih-total-min');
  const entEl = document.getElementById('mih-total-entries');
  const avgKmEl = document.getElementById('mih-average-km');
  const avgPaceEl = document.getElementById('mih-average-pace');
  const histBody = document.getElementById('mih-history-body');

  if (histBody) histBody.innerHTML = "";
  if (!MIH.user?.name) return;

  const userSnap = await MIH.db.collection('mih_users_v2').doc(MIH.user.name).get();
  const user = userSnap.exists ? (userSnap.data()||{}) : {};
  const totalKm = Number(user.totalKm||0);
  const totalMin = Number(user.totalMin||0);
  const entries = Number(user.entries||0);

  if (kmEl) kmEl.textContent = totalKm.toFixed(2);
  if (minEl) minEl.textContent = totalMin.toFixed(0);
  if (entEl) entEl.textContent = String(entries);
  if (avgKmEl) avgKmEl.textContent = entries > 0 ? (totalKm/entries).toFixed(2) : "0";
  if (avgPaceEl) avgPaceEl.textContent = totalKm > 0 ? paceStr(totalKm, totalMin) : "0:00";

  const snap = await MIH.db.collection('mih_entries_v2')
    .where('username','==',MIH.user.name)
    .orderBy('ts','desc')
    .limit(50)
    .get();

  if (histBody){
    if (snap.empty){
      histBody.innerHTML = `<tr><td colspan="4" class="muted">${GT('noEntries')}</td></tr>`;
    } else {
      snap.forEach(doc=>{
        const d = doc.data();
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${fmtDate(d.ts)}</td>
          <td>${Number(d.km).toFixed(2)}</td>
          <td>${Number(d.minutes).toFixed(0)}</td>
          <td>${paceStr(d.km, d.minutes)}</td>
        `;
        histBody.appendChild(tr);
      });
    }
  }
}

async function mihLoadLeaderboard(){
  const body = document.getElementById('mih-leaderboard-body');
  if (!body) return;
  body.innerHTML = "";

  const snap = await MIH.db.collection('mih_users_v2').get();
  let users = [];
  snap.forEach(doc=>{
    const u = doc.data() || {};
    if (u.status === "deleted") return;
    users.push({
      name: doc.id,
      totalKm: Number(u.totalKm||0),
      totalMin: Number(u.totalMin||0),
      entries: Number(u.entries||0)
    });
  });

  if (!users.length){
    body.innerHTML = `<tr><td colspan="5" class="muted">${GT('noPlayers')}</td></tr>`;
    return;
  }

  users.sort((a,b)=> b.totalKm - a.totalKm);

  users.forEach((u, idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td>${u.name}</td>
      <td>${u.totalKm.toFixed(2)}</td>
      <td>${u.totalMin.toFixed(0)}</td>
      <td>${u.totalKm > 0 ? paceStr(u.totalKm, u.totalMin) : "0:00"}</td>
    `;
    body.appendChild(tr);
  });
}

async function mihLoadProfiles(){
  const body = document.getElementById('mih-profiles-body');
  if (!body) return;
  body.innerHTML = "";

  const snap = await MIH.db.collection('mih_users_v2').get();
  let users = [];
  snap.forEach(doc=>{
    const u = doc.data() || {};
    if (u.status === "deleted") return;
    users.push({
      id: doc.id,
      totalKm: Number(u.totalKm||0),
      totalMin: Number(u.totalMin||0),
      entries: Number(u.entries||0)
    });
  });

  if (!users.length){
    body.innerHTML = `<tr><td colspan="4" class="muted">${GT('noPlayers')}</td></tr>`;
    return;
  }

  users.sort((a,b)=> b.totalKm - a.totalKm);

  users.forEach(u=>{
    const tr = document.createElement('tr');
    tr.style.cursor = "pointer";
    tr.innerHTML = `
      <td><u>${u.id}</u></td>
      <td>${u.totalKm.toFixed(2)}</td>
      <td>${u.totalMin.toFixed(0)}</td>
      <td>${u.entries}</td>
    `;
    tr.addEventListener('click', ()=> mihOpenProfile(u.id));
    body.appendChild(tr);
  });
}

async function mihOpenProfile(name){
  const panel = document.getElementById('mihProfilePanel');
  if (!panel) return;

  const userSnap = await MIH.db.collection('mih_users_v2').doc(name).get();
  if (!userSnap.exists) return;
  const u = userSnap.data() || {};
  if (u.status === "deleted") return;

  document.getElementById('mihProfileName').textContent = name;
  document.getElementById('mihProfileKm').textContent = Number(u.totalKm||0).toFixed(2);
  document.getElementById('mihProfileMin').textContent = Number(u.totalMin||0).toFixed(0);
  document.getElementById('mihProfileRuns').textContent = String(Number(u.entries||0));
  document.getElementById('mihProfileAvgPace').textContent = (Number(u.totalKm||0) > 0) ? paceStr(u.totalKm, u.totalMin) : "0:00";

  const hist = document.getElementById('mih-profile-history');
  if (hist) hist.innerHTML = "";

  const snap = await MIH.db.collection('mih_entries_v2')
    .where('username','==',name)
    .orderBy('ts','desc')
    .limit(15)
    .get();

  if (hist){
    if (snap.empty){
      hist.innerHTML = `<tr><td colspan="4" class="muted">${GT('noEntries')}</td></tr>`;
    } else {
      snap.forEach(doc=>{
        const d = doc.data();
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${fmtDate(d.ts)}</td>
          <td>${Number(d.km).toFixed(2)}</td>
          <td>${Number(d.minutes).toFixed(0)}</td>
          <td>${paceStr(d.km, d.minutes)}</td>
        `;
        hist.appendChild(tr);
      });
    }
  }

  panel.classList.add('show');
}

function mihCloseProfile(){
  document.getElementById('mihProfilePanel')?.classList.remove('show');
}

async function mihSoftDeleteAccount(){
  if (!MIH.user?.name) return;

  const ok = confirm(GT('confirmDelete'));
  if (!ok) return;

  try{
    const ref = MIH.db.collection('mih_users_v2').doc(MIH.user.name);

    // Set status="deleted" but keep other fields (merge) so it passes stricter rules more often
    await ref.set({
      uid: MIH.uid || null,
      name: MIH.user.name,
      password: MIH.user.password,
      status: "deleted",
      deletedAt: Date.now()
    }, { merge:true });

    toast(GT('deletedOk'), true);
    mihLogout();
    await mihRefreshAll();
  }catch(err){
    console.error(err);
    toast(GT('deletedErr'), false);
  }
}

async function mihRefreshAll(){
  if (!MIH.ready) return;
  await mihLoadLeaderboard();
  await mihLoadProfiles();

  if (MIH.user?.name){
    await mihLoadMyRecent();
    await mihLoadMyStatsAndHistory();
  }
}

document.addEventListener('DOMContentLoaded', async ()=>{
  // Welcome buttons
  document.getElementById('welcomeSepBtn')?.addEventListener('click', openSep);
  document.getElementById('welcomeMihBtn')?.addEventListener('click', openMih);

  // Language buttons
  document.querySelectorAll('.welcome-lang-btn').forEach(btn=>{
    btn.addEventListener('click', ()=> setGlobalLang(btn.getAttribute('data-lang')));
  });
  document.querySelectorAll('.lang-btn').forEach(btn=>{
    btn.addEventListener('click', ()=> setGlobalLang(btn.getAttribute('data-lang')));
  });
  document.querySelectorAll('.mih-lang-btn').forEach(btn=>{
    btn.addEventListener('click', ()=> setGlobalLang(btn.getAttribute('data-lang')));
  });

  // MIH menu
  document.getElementById('mihMenuToggle')?.addEventListener('click', mihOpenMenu);
  document.getElementById('mihMenuClose')?.addEventListener('click', mihCloseMenu);
  document.getElementById('mihMenuOverlay')?.addEventListener('click', mihCloseMenu);

  document.getElementById('mihExitBtn')?.addEventListener('click', ()=>{ mihCloseMenu(); backToMainMenu(); });

  // Scene nav from menu
  document.querySelectorAll('[data-mih-scene]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const scene = btn.getAttribute('data-mih-scene');
      mihCloseMenu();
      mihShowScene(scene);

      if (scene === "mih-leaderboard") await mihLoadLeaderboard();
      if (scene === "mih-profiles") await mihLoadProfiles();
      if (scene === "mih-stats") await mihLoadMyStatsAndHistory();
      if (scene === "mih-home") await mihLoadMyRecent();
    });
  });

  // Login / activity
  document.getElementById('mih-login-btn')?.addEventListener('click', async ()=>{
    const u = document.getElementById('mih-username')?.value || "";
    const p = document.getElementById('mih-password')?.value || "";
    await mihLoginOrCreate(u,p);
  });

  document.getElementById('mih-add-activity')?.addEventListener('click', async ()=>{
    const km = document.getElementById('mih-distance')?.value;
    const min = document.getElementById('mih-minutes')?.value;
    await mihAddActivity(km, min);
  });

  // View saved password
  document.getElementById('mih-view-saved-pass')?.addEventListener('click', ()=>{
    const box = document.getElementById('mih-saved-pass-display');
    if (!box) return;
    const p = localStorage.getItem(LS_MIH_PASS);
    box.style.display = "block";
    box.textContent = p ? GT('mihSavedShow', { password: p }) : GT('mihSavedNone');
  });

  // Logout / delete
  document.getElementById('mihLogoutBtn')?.addEventListener('click', ()=>{ mihCloseMenu(); mihLogout(); });
  document.getElementById('mihDeleteAccountBtn')?.addEventListener('click', async ()=>{ mihCloseMenu(); await mihSoftDeleteAccount(); });

  // Profile close
  document.getElementById('mihProfileClose')?.addEventListener('click', mihCloseProfile);

  // Init lang (this does NOT change scenes)
  setGlobalLang(GLOBAL_LANG);

  // Init Firebase
  await mihInitFirebase();

  // Restore login (optional) — keeps working, but it will NOT force you back into MIH on refresh
  const savedUser = localStorage.getItem(LS_MIH_USER);
  const savedPass = localStorage.getItem(LS_MIH_PASS);
  if (savedUser && savedPass){
    try{
      await mihLoginOrCreate(savedUser, savedPass);
    }catch(e){
      console.warn(e);
      MIH.user = null;
    }
  }

  mihSetPills();
  mihUpdateMenuButtons();

  // IMPORTANT: Always start on welcome after refresh (no route persistence)
  showApp("welcome");
  mihShowScene("mih-login");

  // Initial loads
  if (MIH.ready){
    await mihRefreshAll();
  }
});
</script>

</body>
</html>
